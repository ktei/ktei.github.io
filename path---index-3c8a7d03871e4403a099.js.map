{"version":3,"sources":["webpack:///path---index-3c8a7d03871e4403a099.js","webpack:///./.cache/json/index.json"],"names":["webpackJsonp","382","module","exports","data","site","siteMetadata","title","description","url","author","adsense","remark","posts","post","html","frontmatter","layout","path","categories","date","pathContext"],"mappings":"AAAAA,cAAc,iBAERC,IACA,SAAUC,EAAQC,GCHxBD,EAAAC,SAAkBC,MAAQC,MAAQC,cAAgBC,MAAA,cAAAC,YAAA,mCAAAC,IAAA,+BAAAC,OAAA,YAAAC,QAAA,KAA+IC,QAAWC,QAAUC,MAAQC,KAAA,6v7BAAywjBC,aAAivZC,OAAA,OAAAV,MAAA,kEAAAW,KAAA,kEAAAC,YAAA,kFAAAC,KAAA,iBAA2RN,MAAQC,KAAA;AAA6qpBC,aAA05JC,OAAA,OAAAV,MAAA,sEAAAW,KAAA,uEAAAC,YAAA,yEAAAC,KAAA,iBAA2RN,MAAQC,KAAA;AAAq11FC,aAAyjBC,OAAA,OAAAV,MAAA,yCAAAW,KAAA,yCAAAC,YAAA,4DAAAC,KAAA,iBAAmNN,MAAQC,KAAA;AAAk5uEC,aAAmvDC,OAAA,OAAAV,MAAA,yCAAAW,KAAA,yCAAAC,YAAA,8EAAAC,KAAA,iBAAqON,MAAQC,KAAA,glKAAu6GC,aAA+rDC,OAAA,OAAAV,MAAA,+CAAAW,KAAA,0CAAAC,YAAA,sBAAAC,KAAA,mBAAqLC","file":"path---index-3c8a7d03871e4403a099.js","sourcesContent":["webpackJsonp([142629428675168],{\n\n/***/ 382:\n/***/ (function(module, exports) {\n\n\tmodule.exports = {\"data\":{\"site\":{\"siteMetadata\":{\"title\":\"DisasterDev\",\"description\":\"The blog of a disaster developer\",\"url\":\"https://blog.disasterdev.net\",\"author\":\"Rui Cheng\",\"adsense\":\"\"}},\"remark\":{\"posts\":[{\"post\":{\"html\":\"<p>If you’re a developer like me, you probably also want to build a blog site to showcase your ideas, skills, lessons and achievements. What if I tell you I built this site without hosting any server and it’s worldwide-fast, highly available, and even the building process was almost automated, and even better, the cost is almost nothing? <em>“That sounds pretty good, now show me how!”</em> With AWS (I’m not working for their sales team) and laptop, you can do this in one day. Now let me show you how.</p>\\n<!--more-->\\n<p>This article will show you how I built this site by leveraging the power of <a href=\\\"https://aws.amazon.com/\\\">AWS</a> and <a href=\\\"https://reactjs.org/\\\">React</a>. I assume that you have some knowledge regarding AWS, React, Node, so I’ll just focus on the main points. I also assume that you’ve had an AWS account already.</p>\\n<h2>How it works</h2>\\n<p>First of all, here’s the overview of what I did, just to give you a big picture.</p>\\n<ol>\\n<li>\\n<p>I bought the domain (disasterdev.net) directly from AWS <a href=\\\"https://aws.amazon.com/route53/\\\">Route53</a>.</p>\\n</li>\\n<li>\\n<p>I used <a href=\\\"https://www.gatsbyjs.org/\\\">Gatsby</a> (<strong>nothing to do with</strong> Leonardo DiCaprio) to generate all the site contents that’re ready to be deployed. This article will not discuss how to use this tool, so you’ll need to read its documentation, which won’t take you much time.</p>\\n</li>\\n<li>\\n<p>I created an <a href=\\\"https://aws.amazon.com/s3/\\\">S3</a> bucket and put the all website files in that bucket. I also turned on the static website hosting for this bucket and set up public read permission.</p>\\n</li>\\n<li>\\n<p>I created a <a href=\\\"https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Introduction.html\\\">CloudFront</a> distribution which points to the static website URL of the bucket created in step 3 to serve the website to public audience.</p>\\n</li>\\n<li>\\n<p>I created a record set (blog.disasterdev.net) in the hosted zone (disasterdev.net) and pointed it to the domain name of the CloudFront in step 4.</p>\\n</li>\\n<li>\\n<p>I requested an SSL/TLS certificate using <a href=\\\"https://aws.amazon.com/certificate-manager/\\\">Certificate Manager</a> and configured CloudFront distribution in step 4 to use this certificate.</p>\\n</li>\\n<li>\\n<p>One day later, my billing alarm reminded me that I’d spend $600 at the end of this month. On dear, don’t worry, because I’d tell you the mistake I made and make sure you’ll NEVER have to repeat my mistake, just because I’m such a generous person.</p>\\n</li>\\n</ol>\\n<p>Now, let’s stop playing the stupid MMO or watching that R18+ on Netflix - time to do build something!</p>\\n<h2>1. Install Gatsby</h2>\\n<p>There’s not much to say about this. You need to have <a href=\\\"https://nodejs.org/en/\\\">Node</a> installed. Then, you run the following commands to install this tool and get started.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-none\\\"><code>npm install --global gatsby-cli\\ngatsby new blog\\ncd blog\\ngatsby develop</code></pre>\\n      </div>\\n<p>You can play around with Gatsby and create some dummy pages. Once you’re ready, run <code>gatsby build</code> to build it. This will generate all the contents in <code>/public</code> folder, that is ready to be deployed.</p>\\n<h2>2. Create S3 bucket</h2>\\n<p>Login AWS console and go to S3 service page, where you need to create a bucket that will be used to store all the website files. This is the <a href=\\\"https://aws.amazon.com/cloudformation/\\\">CloudFormation</a> template for the bucket.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token key atrule\\\">S3Bucket</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::S3::Bucket\\\"</span>\\n  <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">BucketName</span><span class=\\\"token punctuation\\\">:</span> your.blog\\n</code></pre>\\n      </div>\\n<p><em>“Wait, what the hell is CloudFormation?”</em> might be your question. It’s just a way to automatically provision AWS resources without a thousand times of manual clicks. Whatever you can do with CloudFormation, you can do it via AWS console or CLI as well, so don’t let that freak you out, as you’re free to choose your way of doing things.</p>\\n<p>An S3 bucket by default denies all kinds of requests, except the owner’s. If we are to host a static website using S3, we need to set up public read permission as mentioned <a href=\\\"https://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteAccessPermissionsReqd.html\\\">here</a>. Open S3 service page and click <em>Permissions->Bucket Policy</em> and add the following policy.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-json\\\"><code><span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token property\\\">\\\"Version\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token string\\\">\\\"2008-10-17\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n  <span class=\\\"token property\\\">\\\"Statement\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token punctuation\\\">[</span>\\n    <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token property\\\">\\\"Effect\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token string\\\">\\\"Allow\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n      <span class=\\\"token property\\\">\\\"Principal\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token property\\\">\\\"AWS\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n      <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span>\\n      <span class=\\\"token property\\\">\\\"Action\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token string\\\">\\\"s3:GetObject\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n      <span class=\\\"token property\\\">\\\"Resource\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token string\\\">\\\"arn:aws:s3:::your.blog/*\\\"</span>\\n    <span class=\\\"token punctuation\\\">}</span>\\n  <span class=\\\"token punctuation\\\">]</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n</code></pre>\\n      </div>\\n<p>And this is the CloudFormation template for both S3 bucket policy.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token key atrule\\\">S3BucketPolicy</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::S3::BucketPolicy\\\"</span>\\n  <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span> \\n    <span class=\\\"token key atrule\\\">Bucket</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> S3Bucket\\n    <span class=\\\"token key atrule\\\">PolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span> \\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"s3:GetObject\\\"</span>\\n          <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"Allow\\\"</span>\\n          <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Join</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"\\\"</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"arn:aws:s3:::\\\"</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!Ref</span> S3Bucket\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"/*\\\"</span>\\n          <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">AWS</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n</code></pre>\\n      </div>\\n<h2>3. Create CloudFront distribution</h2>\\n<p>Instead of using S3 to serve the website directly, we will use CloudFront, because this is a static website and CloudFront provides great speed across the world, thanks to its edge locations.</p>\\n<p>Login AWS console and go to CloudFront service page, where you can create the CloudFront distribution. Here’re some highlights that you need to pay attention to:</p>\\n<ul>\\n<li>\\n<p>The origin should be the static website endpoiont of the S3 bucket you created in step 2. It’ll look like this: <em>your.blog.s3-website-ap-southeast-2.amazonaws.com</em>.</p>\\n</li>\\n<li>\\n<p>Set the Default Root Object to <em>index.html</em> so when user requests the root URL, index page will be automatically displayed.</p>\\n</li>\\n<li>\\n<p>For <em>Alias</em>, add the domain name which will be the website URL for your end users, for instance, mine is <code>blog.disasterdev.net</code>.</p>\\n</li>\\n</ul>\\n<p>At last, your distribution settings will look similar as the screenshot below. There’re settings you may not understand yet, for example <em>SSL Certificate</em>, which we will talk about later.</p>\\n\\n  <span class=\\\"gatsby-resp-image-wrapper\\\" style=\\\"position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 750px; margin-left: auto; margin-right: auto;\\\">\\n    <span class=\\\"gatsby-resp-image-background-image\\\" style=\\\"padding-bottom: 63.49206349206349%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABfUlEQVQ4y5VTa4+CQAz0//8wjUaNXjQ+QXmDgCIEEAHnnF7kwx2Ys0mz3c3utJ3O9kz3jMnXBn6U4XK54HA4IkkS2LaN4/EntiwLiqJIzDNN0xDH1+fdA3Rdb+5EUYReXdd4PB74bUEQNI8ZO44jSZi0KArc73fwbVmWsn95D2+MILPZTDKfTifxMAzFfd+H53myvvZM1gk4Ho/R7/cxGAykyv9aK2CaptLuYrHAcrmEYRhQVRXX61Xa+hiQ3JCj9XqN7XYrrbJKEm+aplDBM9d1//DfCshKCMDKptOpcEQeP2qZFRGEMiAQhzEajTCZTGB5ITYHG4ruQHMjJLcaUVaJJ3mFc1rh8oxbK6yqSqRAYLZL7jw/gKoZcDwfR8OC7XgoyrrxNC9we66tgNQcueJAhsOhTJvglAhbJ2+8Q5m8pEO5dHJIrvgD2DYHQA65Z8xBZFn2+ZSZcbfbCdh8PhcwgjJZHMdvpdMp7DzPsVqtsN/vm2/FM66UVZd9Aya45GWYi5fOAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\\\">\\n      <img class=\\\"gatsby-resp-image-image\\\" style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\" alt=\\\"CloudFront settings\\\" title=\\\"\\\" src=\\\"/static/cf-settings-3b9b9716140e8911c9fc43e157c65ca2-245fd.png\\\" srcset=\\\"/static/cf-settings-3b9b9716140e8911c9fc43e157c65ca2-7aee9.png 188w,\\n/static/cf-settings-3b9b9716140e8911c9fc43e157c65ca2-2014b.png 375w,\\n/static/cf-settings-3b9b9716140e8911c9fc43e157c65ca2-245fd.png 750w,\\n/static/cf-settings-3b9b9716140e8911c9fc43e157c65ca2-a0f71.png 1125w,\\n/static/cf-settings-3b9b9716140e8911c9fc43e157c65ca2-9b813.png 1500w,\\n/static/cf-settings-3b9b9716140e8911c9fc43e157c65ca2-380da.png 1638w\\\" sizes=\\\"(max-width: 750px) 100vw, 750px\\\">\\n    </span>\\n  </span>\\n  \\n<h2>4. Create record set</h2>\\n<p>I’m gonna assume you’ve already bought your domain, so if you login AWS console and go to <em>Route53->Hosted zones</em>, you should see something similar to this.</p>\\n\\n  <span class=\\\"gatsby-resp-image-wrapper\\\" style=\\\"position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 750px; margin-left: auto; margin-right: auto;\\\">\\n    <span class=\\\"gatsby-resp-image-background-image\\\" style=\\\"padding-bottom: 30.761209593326384%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA/ElEQVQY032Q626EIBBGff9X68+aeNcVL4h4AYV1jdGvQLdN2m06yQnDJJyZwaOUgjGGrusghIBSyt0tfd8jz3NkWebyqulQEIqKDhBqh3qcL3hhGCIIAhBC0DTNv3DOXdN5nh3XdeF3eG3bIk3T70dVVaEsS8Rx7Oq+7yOKIpdb4ZdUSol1VYb1iYLWdyMcVrTcMKg/afgCQieEWY2eDyhvpWtqhfabbINpmoxMu4m9pHsgIiOSegZbLvQrfkD4hhvTeHvPMM3SPbJb2S3seRwHzvPEtm2fwkXv6LgAGyXu+/XCKDRGqZHkBMJMZaOpaxRFAWYmlM+aDSv8AC5DxG6KuBtVAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\\\">\\n      <img class=\\\"gatsby-resp-image-image\\\" style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\" alt=\\\"Hosted zone\\\" title=\\\"\\\" src=\\\"/static/hosted-zone-67ca3723fbc646b4d45893eb0dfd2cbc-245fd.png\\\" srcset=\\\"/static/hosted-zone-67ca3723fbc646b4d45893eb0dfd2cbc-7aee9.png 188w,\\n/static/hosted-zone-67ca3723fbc646b4d45893eb0dfd2cbc-2014b.png 375w,\\n/static/hosted-zone-67ca3723fbc646b4d45893eb0dfd2cbc-245fd.png 750w,\\n/static/hosted-zone-67ca3723fbc646b4d45893eb0dfd2cbc-a0f71.png 1125w,\\n/static/hosted-zone-67ca3723fbc646b4d45893eb0dfd2cbc-9b813.png 1500w,\\n/static/hosted-zone-67ca3723fbc646b4d45893eb0dfd2cbc-f1539.png 1918w\\\" sizes=\\\"(max-width: 750px) 100vw, 750px\\\">\\n    </span>\\n  </span>\\n  \\n<p>The <em>NS</em> record set have the name servers for your domain, so make sure they also appear in registered domains like this. If they don’t, click <em>Add or edit name servers</em> to update them.</p>\\n\\n  <span class=\\\"gatsby-resp-image-wrapper\\\" style=\\\"position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 750px; margin-left: auto; margin-right: auto;\\\">\\n    <span class=\\\"gatsby-resp-image-background-image\\\" style=\\\"padding-bottom: 28.74743326488706%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA7klEQVQY042RyW6FMAxF+f//Y4GEQBAoY8YHhDDdxn5qF5Va1ZJlZzq+dpKiKFBVFYQQ7H3fo+s63ivLEm3bQkqJfd/xPA/u+/7Tk6ZpYIxhSF3XsNYylICUX9fFFyn+x5Nt23CeJ7TWcM5xrpTCMAysimxdF8zKwq0hwh8cx4Fpmlj5siwYx+l7ndBDY96wEAID53lmIMUQdiz+wms7uOWfRudZliFNU+R5joTIpJLak+YF7dYIkrHqyE5QikYbLkZQUk4F+VwqFGJAXnWQzr+B3vuo0GK2G3w4eKbU1peZOA6atfiIHzZp7uQ3+wQ59cxdpckqkwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\\\">\\n      <img class=\\\"gatsby-resp-image-image\\\" style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\" alt=\\\"Reigstered domains\\\" title=\\\"\\\" src=\\\"/static/registered-domains-e459cd38097d528a47d8c35df7b38736-245fd.png\\\" srcset=\\\"/static/registered-domains-e459cd38097d528a47d8c35df7b38736-7aee9.png 188w,\\n/static/registered-domains-e459cd38097d528a47d8c35df7b38736-2014b.png 375w,\\n/static/registered-domains-e459cd38097d528a47d8c35df7b38736-245fd.png 750w,\\n/static/registered-domains-e459cd38097d528a47d8c35df7b38736-a0f71.png 1125w,\\n/static/registered-domains-e459cd38097d528a47d8c35df7b38736-9b813.png 1500w,\\n/static/registered-domains-e459cd38097d528a47d8c35df7b38736-64938.png 1948w\\\" sizes=\\\"(max-width: 750px) 100vw, 750px\\\">\\n    </span>\\n  </span>\\n  \\n<p>Now, you need to add another record set which points the website domain name to CloudFront domain name.</p>\\n<p>For CloudFront domain name, go to CloudFront service page and find the distribution you just created, which should show you the domain name.</p>\\n<p>For the record set, click <em>Go to Record Sets->yourdomain.net->Create Record Set</em>, and create a record with these properties:</p>\\n<ul>\\n<li>Name: blog.yourdomain.net</li>\\n<li>Type: A - IPv4 address</li>\\n<li>Alias: Yes</li>\\n<li>Alias Target: d2n3whn1234567.cloudfront.net.</li>\\n<li>Alias Hosted Zone ID: Z2FDTNDATAQYW2</li>\\n<li>Routing Policy: Simple</li>\\n<li>Evaluate Target Health: No</li>\\n</ul>\\n<p>This is the CloudFormation template for the record set.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token key atrule\\\">RecourdSet</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Type</span> <span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::Route53::RecordSet\\\"</span>\\n  <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"blog.yourdomain.net\\\"</span>\\n    <span class=\\\"token key atrule\\\">Comment</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"A record for Blog\\\"</span>\\n    <span class=\\\"token key atrule\\\">HostedZoneId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"Z3MTVYTKZKL49\\\"</span>\\n    <span class=\\\"token key atrule\\\">AliasTarget</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">DNSName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> CloudFront.DomainName\\n      <span class=\\\"token key atrule\\\">HostedZoneId</span><span class=\\\"token punctuation\\\">:</span> Z2FDTNDATAQYW2\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> A\\n</code></pre>\\n      </div>\\n<h2>5. Upload your website</h2>\\n<p>By now, we’ve created S3 bucket, CloudFront distribution, a record set pointing to the CloudFront, and more importantly, connected them together. This allows a request to <em>blog.yourdomain.net</em> to be resolved to <em>abcdefg1234567.cloudfront.net</em>, which is eventaully routed to your S3 bucket <em>your.blog.s3-website-ap-southeast-2.amazonaws</em> - where the actual content lies - AWESOME! It’s time to throw some real content into the bucket so users can browse, yeah?</p>\\n<p>Remember in step 1 we ran <code>gatsby build</code> to generate all the website files into <code>/public</code> folder? Now you need to upload all the files to the S3 bucket. Please don’t be naive to upload them one by one; we should run a command to do this. Install <a href=\\\"https://aws.amazon.com/cli/\\\">AWS CLI</a> and run <code>aws configure</code> to configure your AWS credentials properly.</p>\\n<p>Done? Make sure you’re at project root folder, and run <code>aws s3 sync ./public/ s3://your.blog --storage-class REDUCED_REDUNDANCY --delete</code>. This will upload all the files in current directory to <em>your.blog</em> bucket, and also delete the remote files which don’t exist locally anymore - 100% synchronised. Note that I’m using <a href=\\\"https://aws.amazon.com/s3/reduced-redundancy/\\\">reduced redundancy</a> because it’s cheaper and even if I lose the files on S3, I can still regenerate all the files using Gatsby and re-upload them to S3 bucket.</p>\\n<p>Now you open <em><a href=\\\"https://blog.yourdomain.net\\\">https://blog.yourdomain.net</a></em>. Your site should be running, with one thing bugging you though: your browser complains “This website is NOT secure!“.</p>\\n<h2>6. Make it secure</h2>\\n<p>Before you go to Certificate Manager service page, make sure you’re under region US East (N. Virginia), according to <a href=\\\"https://docs.aws.amazon.com/acm/latest/userguide/acm-regions.html\\\">this article</a>: <em>“To use an ACM Certificate with Amazon CloudFront, you must request or import the certificate in the US East (N. Virginia) region.”</em>.</p>\\n<p>Click <em>Request Certificate</em> and type domain name *<em>.yourdomain.net</em>. Note that the aterisk will allow us to use this certificate for all domain names of this kind, such as <em>abc.yourdomain.net</em>, <em>batman.yourdomain.net</em> and so on.</p>\\n<p>Choose <em>DNS validation</em> and follow the instructions to complete the creation wizard. Now you should see a “Pending” certificate. Expand the certificate and you should see a button <em>Create Route53 Record Set</em>, clicking which will create a CNAME record in your hosted zone and a few minutes later the “Pending” status will be updated to “Issued”.</p>\\n<p>Phew, almost there! Remember in step 3 I mentioned <em>SSL Certificate</em>? Now take a note of the ARN of the certificate you just created. Go back to the CloudFront distribution, and fix its <em>SSL Certificate</em> to be this ARN. <strong>Pay attention</strong>: because you’re using CloudFront with a custom SSL certificate, it’s <strong>VERY IMPORTANT</strong> that you also set <em>Custom SSL Client Support</em> to <strong>Only Clients that Support Server Name Indication (SNI)</strong>. Look, I can’t stress this enough as I would have spent $600/month (thanks to my billing alarm, I didn’t) just because I accidentally chose the wrong option here. Anyway, $600 or $0, the choice is yours.</p>\\n<p>Give it some time, and it might take more than 10 minutes. Now open <em><a href=\\\"https://blog.yourdomain.net\\\">https://blog.yourdomain.net</a></em>, and your browser should tell you “Yep, this website is secure!“.</p>\\n<h2>CloudFormation</h2>\\n<p>I’m a big fan of CloudFormation and in reality I used CloudFormation to provision most of the AWS resources I needed for this website, except the hosted zone and certificate. Here’s the complete CloudFormation template I wrote (changed a few parameters), which you can borrow to provision your own website if you find clicking in AWS console is such a chore.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'2010-09-09'</span>\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Blog resources\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">S3Bucket</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::S3::Bucket\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">BucketName</span><span class=\\\"token punctuation\\\">:</span> your.blog\\n      <span class=\\\"token key atrule\\\">WebsiteConfiguration</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">IndexDocument</span><span class=\\\"token punctuation\\\">:</span> index.html\\n        <span class=\\\"token key atrule\\\">ErrorDocument</span><span class=\\\"token punctuation\\\">:</span> error.html\\n\\n  <span class=\\\"token key atrule\\\">S3BucketPolicy</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::S3::BucketPolicy\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span> \\n      <span class=\\\"token key atrule\\\">Bucket</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> S3Bucket\\n      <span class=\\\"token key atrule\\\">PolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span> \\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span> \\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"s3:GetObject\\\"</span>\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"Allow\\\"</span>\\n            <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Join</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"\\\"</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"arn:aws:s3:::\\\"</span>\\n                <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!Ref</span> S3Bucket\\n                <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"/*\\\"</span>\\n            <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">AWS</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n\\n  <span class=\\\"token key atrule\\\">CloudFront</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::CloudFront::Distribution\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">DistributionConfig</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Aliases</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"blog.disasterdev.net\\\"</span>\\n        <span class=\\\"token key atrule\\\">Comment</span><span class=\\\"token punctuation\\\">:</span> CloudFront for Blog\\n        <span class=\\\"token key atrule\\\">Enabled</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n        <span class=\\\"token key atrule\\\">DefaultCacheBehavior</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token key atrule\\\">Compress</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n          <span class=\\\"token key atrule\\\">ForwardedValues</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">QueryString</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n          <span class=\\\"token key atrule\\\">TargetOriginId</span><span class=\\\"token punctuation\\\">:</span> blog<span class=\\\"token punctuation\\\">-</span>origin\\n          <span class=\\\"token key atrule\\\">ViewerProtocolPolicy</span><span class=\\\"token punctuation\\\">:</span> redirect<span class=\\\"token punctuation\\\">-</span>to<span class=\\\"token punctuation\\\">-</span>https\\n          <span class=\\\"token key atrule\\\">DefaultTTL</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">3600 </span><span class=\\\"token comment\\\"># I prefer 1 hour so that my new post can be delivered quickly</span>\\n        <span class=\\\"token key atrule\\\">Origins</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">DomainName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Join</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">''</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!Ref</span> S3Bucket\\n                <span class=\\\"token punctuation\\\">-</span>  <span class=\\\"token string\\\">\\\".s3-website-ap-southeast-2.amazonaws.com\\\"</span>\\n            <span class=\\\"token key atrule\\\">CustomOriginConfig</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">HTTPPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">80</span>\\n              <span class=\\\"token key atrule\\\">HTTPSPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">443</span>\\n              <span class=\\\"token key atrule\\\">OriginProtocolPolicy</span><span class=\\\"token punctuation\\\">:</span> http<span class=\\\"token punctuation\\\">-</span>only\\n            <span class=\\\"token key atrule\\\">Id</span><span class=\\\"token punctuation\\\">:</span> blog<span class=\\\"token punctuation\\\">-</span>origin\\n        <span class=\\\"token key atrule\\\">PriceClass</span><span class=\\\"token punctuation\\\">:</span> PriceClass_All\\n        <span class=\\\"token key atrule\\\">ViewerCertificate</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token key atrule\\\">AcmCertificateArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"arn:aws:acm:us-east-1:504224764639:certificate/866de211-1111-1111-1111-db1180e6cddd\\\"</span>\\n          <span class=\\\"token key atrule\\\">SslSupportMethod</span><span class=\\\"token punctuation\\\">:</span> sni<span class=\\\"token punctuation\\\">-</span>only <span class=\\\"token comment\\\"># if you set this to vip, you'll be charged $600/month</span>\\n        <span class=\\\"token key atrule\\\">DefaultRootObject</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"index.html\\\"</span>\\n\\n  <span class=\\\"token key atrule\\\">RecourdSet</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span> <span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::Route53::RecordSet\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"blog.disasterdev.net\\\"</span>\\n      <span class=\\\"token key atrule\\\">Comment</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"A record for Blog\\\"</span>\\n      <span class=\\\"token key atrule\\\">HostedZoneId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"Z3MTVYT123456\\\"</span>\\n      <span class=\\\"token key atrule\\\">AliasTarget</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">DNSName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> CloudFront.DomainName\\n        <span class=\\\"token key atrule\\\">HostedZoneId</span><span class=\\\"token punctuation\\\">:</span> Z2FDTNDATAQYW2 <span class=\\\"token comment\\\"># hardcoded, found it here https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-route53-aliastarget.html</span>\\n      <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> A\\n</code></pre>\\n      </div>\\n<h2>Conclusion</h2>\\n<p>It tooke me a few hours to finally get this site up and running properly, but the journey was quite fun. Leveraging the power of AWS, I could host a static website that is highly available and fast for every location in the world costing me little, and all I need was just a laptop and AWS account - tell me how you beat that!</p>\\n<p>Gatsby is also a brilliant tool that helps you build the website easily with some <a href=\\\"https://www.gatsbyjs.org/docs/prpl-pattern/\\\">best practices</a> embeded.</p>\\n<p>All in all, I had a lot fun building this and I hope you will do too.</p>\",\"frontmatter\":{\"layout\":\"post\",\"title\":\"Build your ultimate blog with React, S3, CloudFront and Route53\",\"path\":\"/build-your-ultimate-blog-with-react-s3-cloudfront-and-route53/\",\"categories\":[\"AWS\",\"S3\",\"CloudFront\",\"Route53\",\"Certificate Manager\",\"CloudFormation\",\"React\"],\"date\":\"2018/01/01\"}}},{\"post\":{\"html\":\"<p>If you gave me face and read <a href=\\\"/build-your-ultimate-blog-with-react-s3-cloudfront-and-route53/\\\">Build your ultimate blog with React, S3, CloudFront and Route53</a>, then you know how <em>badass</em> this website is already. But young man, we’re not done yet, because as a developer, we want to</p>\\n\\n  <span class=\\\"gatsby-resp-image-wrapper\\\" style=\\\"position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 400px; margin-left: auto; margin-right: auto;\\\">\\n    <span class=\\\"gatsby-resp-image-background-image\\\" style=\\\"padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAUCAwT/xAAWAQEBAQAAAAAAAAAAAAAAAAACAwT/2gAMAwEAAhADEAAAAXdJjzpsRKn/xAAbEAABBAMAAAAAAAAAAAAAAAABAhEiMQADIf/aAAgBAQABBQJQfOOKVExRuFf/xAAWEQEBAQAAAAAAAAAAAAAAAAABEBH/2gAIAQMBAT8BDZ//xAAYEQADAQEAAAAAAAAAAAAAAAAAAQIREv/aAAgBAgEBPwHqnTRp/8QAGhAAAgIDAAAAAAAAAAAAAAAAARAAIQIRMf/aAAgBAQAGPwKUXsVker//xAAaEAEBAQEAAwAAAAAAAAAAAAABEQAxIUFR/9oACAEBAAE/IfEbioVfmEBmw9PMVJScd1RQu//aAAwDAQACAAMAAAAQZD//xAAWEQEBAQAAAAAAAAAAAAAAAAABEDH/2gAIAQMBAT8QXBP/xAAZEQACAwEAAAAAAAAAAAAAAAABMQARIUH/2gAIAQIBAT8QAaNZi43AdKf/xAAbEAEBAAMBAQEAAAAAAAAAAAABEQAhMVFBkf/aAAgBAQABPxAFSB0MRiBF01ffzKA2EuHjFgs4+YKaoBJqz7DLoZd3c//Z&apos;); background-size: cover; display: block;\\\">\\n      <img class=\\\"gatsby-resp-image-image\\\" style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\" alt=\\\"Automate everything\\\" title=\\\"\\\" src=\\\"/static/automate-everything-c09d5d1f91e89c001851bae8eeb1fd38-b0ab5.jpg\\\" srcset=\\\"/static/automate-everything-c09d5d1f91e89c001851bae8eeb1fd38-0852f.jpg 188w,\\n/static/automate-everything-c09d5d1f91e89c001851bae8eeb1fd38-ea616.jpg 375w,\\n/static/automate-everything-c09d5d1f91e89c001851bae8eeb1fd38-b0ab5.jpg 400w\\\" sizes=\\\"(max-width: 400px) 100vw, 400px\\\">\\n    </span>\\n  </span>\\n  \\n<p>So in this article I’m gonna talk about how I provisioned CICD pipeline to build and deploy this website.</p>\\n<p>What automation are we talking about? It’s quite straightforward:</p>\\n<ol>\\n<li>I pushed the source files, including all the articles to a Git service, such as GitHub.</li>\\n<li>I built an AWS CodeBuild project which takes in the source files of this website, builds it, and sync the built files to the S3 bucket hosting the website.</li>\\n<li>I built an AWS CodePipeline which automatically pulls the source files from Git and passes them down to CodeBuild project, which does the build and deployment.</li>\\n</ol>\\n<!--more-->\\n<p>And that’s it - simply 3 steps!</p>\\n<h2>Host source files</h2>\\n<p>I chose to host my source in AWS CodeCommit. <em>“Why not GitHub?”</em>, you’re asking. I guess for one, I’m too shy to share my terrible source code to everyone. Also, CodeCommit is seamlessly integrated with AWS CodePipeline, that is one of the main services I use for this CICD. See? They really know how to make you stick to AWS.</p>\\n<p>So I logged in AWS console, went to CodeCommit service page and created a repository called <em>blog</em>. Following the instructions, I also set up my <em>CodeCommit Credentials</em>.</p>\\n<p>With some basic AWS and Git knowledge, I got my source files checked in very quickly.</p>\\n<h2>Build CodeBuild</h2>\\n<p>Instead of provisioning and hosting your own build server, you can set up a CodeBuild project, which can be seen as a <em>serverless</em> (another fancy buzz word eh?) build machine that is provisioned by AWS on the fly when your build starts. This “serverless build machine” will execute build commands in <code>buildspec.yml</code> file, which should be put under the project root folder.</p>\\n<p>For example, this is my <code>buildspec.yml</code> file.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token key atrule\\\">version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">0.1</span>\\n\\n<span class=\\\"token key atrule\\\">phases</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">build</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">commands</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> echo \\\"Starting build `date` in `pwd`\\\"\\n      <span class=\\\"token punctuation\\\">-</span> npm install\\n      <span class=\\\"token punctuation\\\">-</span> npm run aws<span class=\\\"token punctuation\\\">-</span>build\\n  <span class=\\\"token key atrule\\\">post_build</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">commands</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> echo \\\"build completed on `date`\\\"\\n</code></pre>\\n      </div>\\n<p>I did two things in this file:</p>\\n<ol>\\n<li>I run <code>npm install</code> to install all the dependencies.</li>\\n<li>I run <code>npm run aws-build</code> to make a build and sync the built files to S3.</li>\\n</ol>\\n<p>Let me show you the magic of <code>aws-build</code> in <code>package.json</code>:</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-json\\\"><code><span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token property\\\">\\\"scripts\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token property\\\">\\\"sync-s3\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token string\\\">\\\"aws s3 sync public/. s3://my.blog --storage-class REDUCED_REDUNDANCY --delete\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token property\\\">\\\"aws-build\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token string\\\">\\\"npm run build &amp;&amp; npm run sync-s3\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n</code></pre>\\n      </div>\\n<p>In <code>aws-build</code> I first call <code>npm run build</code> to build the whole website and then I run <code>sync-s3</code> to synchronise all the files under <code>public/</code> directory to S3 bucket <code>my.blog</code>.</p>\\n<p>I didn’t go to CodeBuild service page because smart developers <strong>automate everything</strong>. I’m just going to pretend I’m smart here. Here’s the CloudFormation template to automate the provisioning.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token key atrule\\\">ArtifactBucket</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::S3::Bucket\\\"</span>\\n\\n<span class=\\\"token key atrule\\\">CodeBuildServiceRole</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::IAM::Role\\\"</span>\\n  <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"/\\\"</span>\\n    <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n          <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> codebuild.amazonaws.com\\n          <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n    <span class=\\\"token key atrule\\\">ManagedPolicyArns</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>iam<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>policy/AWSCodeCommitFullAccess\\n    <span class=\\\"token key atrule\\\">Policies</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">PolicyName</span><span class=\\\"token punctuation\\\">:</span> CodeBuildAccess\\n        <span class=\\\"token key atrule\\\">PolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n              <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n              <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span> logs<span class=\\\"token punctuation\\\">:</span>*\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>s3<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>$<span class=\\\"token punctuation\\\">{</span>ArtifactBucket<span class=\\\"token punctuation\\\">}</span>/*\\n              <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n              <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>GetObject\\n                <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>PutObject\\n                <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>GetObjectVersion\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n              <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n              <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span> s3<span class=\\\"token punctuation\\\">:</span>List*\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>s3<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ktei2008.blog/*\\n              <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n              <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>GetObject\\n                <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>PutObject\\n                <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>DeleteObject*\\n\\n<span class=\\\"token key atrule\\\">CodeBuildProject</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::CodeBuild::Project\\\"</span>\\n  <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> BlogBuildAndDeploy\\n    <span class=\\\"token key atrule\\\">Artifacts</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> S3\\n      <span class=\\\"token key atrule\\\">Location</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ArtifactBucket\\n    <span class=\\\"token key atrule\\\">Source</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> CODECOMMIT\\n      <span class=\\\"token key atrule\\\">Location</span><span class=\\\"token punctuation\\\">:</span> https<span class=\\\"token punctuation\\\">:</span>//git<span class=\\\"token punctuation\\\">-</span>codecommit.ap<span class=\\\"token punctuation\\\">-</span>southeast<span class=\\\"token punctuation\\\">-</span>2.amazonaws.com/v1/repos/blog\\n    <span class=\\\"token key atrule\\\">Environment</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">ComputeType</span><span class=\\\"token punctuation\\\">:</span> BUILD_GENERAL1_SMALL\\n      <span class=\\\"token key atrule\\\">Image</span><span class=\\\"token punctuation\\\">:</span> aws/codebuild/nodejs<span class=\\\"token punctuation\\\">:</span>7.0.0\\n      <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> LINUX_CONTAINER\\n    <span class=\\\"token key atrule\\\">ServiceRole</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> CodeBuildServiceRole\\n</code></pre>\\n      </div>\\n<p>A few things to notice here about CodeBuild:</p>\\n<ul>\\n<li>It needs certain permissions to synchronise built files to the blog bucket.</li>\\n<li>I set its <em>Environment->Image</em> to be <code>aws/codebuild/nodejs:7.0.0</code> because Gatsby is a  framework running on Node. There’re <a href=\\\"https://docs.aws.amazon.com/codebuild/latest/userguide/build-env-ref-available.html\\\">many images</a> you can choose from. You can even provision your own image.</li>\\n<li><em>ComputeType</em> is set to <em>BUILD<em>GENERAL1</em>SMALL</em> because I’m a cheapskate. If you think the build is too slow, upgrade this to <em>BUILD<em>GENERAL1</em>LARGE</em> and it’s usually much faster.</li>\\n</ul>\\n<h2>Build CodePipeline</h2>\\n<p>I’ve got all the pieces ready so it’s time to connect the dots. CodePipeline is perfect for this. I can create a CodePipeline and have 2 stages, the first of which is triggered whenever I push changes to CodeCommit repository. The first stage will clone the repository and put it in an artifacts S3 bucket, waiting for the CodeBuild in stage 2 to pick the source up.</p>\\n<p>In stage 2 I use CodeBuild to run <code>gatsby build</code> and synchronise built files to the blog bucket.</p>\\n<p>The final pipeline I created looks like this:</p>\\n\\n  <span class=\\\"gatsby-resp-image-wrapper\\\" style=\\\"position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 750px; margin-left: auto; margin-right: auto;\\\">\\n    <span class=\\\"gatsby-resp-image-background-image\\\" style=\\\"padding-bottom: 73.04116865869854%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAABJklEQVQ4y6WUaUrFMBSFu0cX4H+X4z9BcCm6BRFbau34OrcZOuXxOh3TSB/qL0kDh0AIX8695xLD8zyEYQjf9+G6rpJt23AcR51vsixLab9jmiY8ufO2h59xODHBqWzwmVAYhBAURYG6rpHnudrLsgBvGkzThHVdsSzLv2WEgY/Hlxh3T++4fXjDzf0rni2KaV6hs4xGOhmGAfM8/3ppc6YF5JxDCHGFbOBN2sCkoAgS2UcmVJmb23Ec9YHkzJENNWjP0XXd8ZLLpkUnxmsP91S1gSHPQBkDoxSUMjUqh4A74K+0gXESI01TRFGEqqqPOywqgjjJcJK6XEb0fX8s5Uac0Q6j0rJ8Q46FIoMIeAkmWjU2P9PWAn6QUKYsE5afBJVJH+3hFxlxlHKV/7OaAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\\\">\\n      <img class=\\\"gatsby-resp-image-image\\\" style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\" alt=\\\"Pipeline\\\" title=\\\"\\\" src=\\\"/static/pipeline-c1dec17bb1560e299d481e38573b653e-245fd.png\\\" srcset=\\\"/static/pipeline-c1dec17bb1560e299d481e38573b653e-7aee9.png 188w,\\n/static/pipeline-c1dec17bb1560e299d481e38573b653e-2014b.png 375w,\\n/static/pipeline-c1dec17bb1560e299d481e38573b653e-245fd.png 750w,\\n/static/pipeline-c1dec17bb1560e299d481e38573b653e-a0f71.png 1125w,\\n/static/pipeline-c1dec17bb1560e299d481e38573b653e-9b813.png 1500w,\\n/static/pipeline-c1dec17bb1560e299d481e38573b653e-697c4.png 1506w\\\" sizes=\\\"(max-width: 750px) 100vw, 750px\\\">\\n    </span>\\n  </span>\\n  \\n<p>And this is the CloudFormation template I used to create the pipeline.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token key atrule\\\">CodePipelineServiceRole</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::IAM::Role\\\"</span>\\n  <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"/\\\"</span>\\n    <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n          <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> codepipeline.amazonaws.com\\n          <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n    <span class=\\\"token key atrule\\\">ManagedPolicyArns</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>iam<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>policy/AWSCodeCommitFullAccess\\n    <span class=\\\"token key atrule\\\">Policies</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">PolicyName</span><span class=\\\"token punctuation\\\">:</span> CodePipelineAccess\\n        <span class=\\\"token key atrule\\\">PolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n              <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n              <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> iam<span class=\\\"token punctuation\\\">:</span>PassRole\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> CodeBuildProject.Arn\\n              <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n              <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> codebuild<span class=\\\"token punctuation\\\">:</span>StartBuild\\n                <span class=\\\"token punctuation\\\">-</span> codebuild<span class=\\\"token punctuation\\\">:</span>BatchGetBuilds\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>s3<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>$<span class=\\\"token punctuation\\\">{</span>ArtifactBucket<span class=\\\"token punctuation\\\">}</span>/*\\n              <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n              <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>*\\n\\n<span class=\\\"token key atrule\\\">Pipeline</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::CodePipeline::Pipeline\\\"</span>\\n  <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">RoleArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> CodePipelineServiceRole.Arn\\n    <span class=\\\"token key atrule\\\">ArtifactStore</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> S3\\n      <span class=\\\"token key atrule\\\">Location</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ArtifactBucket\\n    <span class=\\\"token key atrule\\\">Stages</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Source\\n        <span class=\\\"token key atrule\\\">Actions</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Source\\n            <span class=\\\"token key atrule\\\">ActionTypeId</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Category</span><span class=\\\"token punctuation\\\">:</span> Source\\n              <span class=\\\"token key atrule\\\">Owner</span><span class=\\\"token punctuation\\\">:</span> AWS\\n              <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n              <span class=\\\"token key atrule\\\">Provider</span><span class=\\\"token punctuation\\\">:</span> CodeCommit\\n            <span class=\\\"token key atrule\\\">Configuration</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">RepositoryName</span><span class=\\\"token punctuation\\\">:</span> blog\\n              <span class=\\\"token key atrule\\\">BranchName</span><span class=\\\"token punctuation\\\">:</span> master\\n            <span class=\\\"token key atrule\\\">OutputArtifacts</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Source\\n\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> BuildAndDeploy\\n        <span class=\\\"token key atrule\\\">Actions</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> BuildAndDeploy\\n            <span class=\\\"token key atrule\\\">ActionTypeId</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Category</span><span class=\\\"token punctuation\\\">:</span> Build\\n              <span class=\\\"token key atrule\\\">Owner</span><span class=\\\"token punctuation\\\">:</span> AWS\\n              <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n              <span class=\\\"token key atrule\\\">Provider</span><span class=\\\"token punctuation\\\">:</span> CodeBuild\\n            <span class=\\\"token key atrule\\\">Configuration</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">ProjectName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> CodeBuildProject\\n            <span class=\\\"token key atrule\\\">InputArtifacts</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Source\\n</code></pre>\\n      </div>\\n<p>Now I’ve built a simple CICD pipeline for my own website. This frees me up as I don’t need to worry about deployment anymore, while I can focus on wrting more bad or worse articles to <del>mislead</del> help you - disaster dev eh?</p>\\n<h1>Conclusion</h1>\\n<p>With the help of AWS CodeCommit, CodeBuild and CodePipeline, I managed to create a smooth CICD experience for my own website and it costs me little. We all want to be smart devs, and smart devs are usually lazy bastards - because they’ve automated everything for themselves! Don’t you wanna be one of them?</p>\",\"frontmatter\":{\"layout\":\"post\",\"title\":\"Build a simple CICD with AWS CodeCommit, CodeBuild and CodePipeline\",\"path\":\"/build-a-simple-cicd-with-aws-codecommit-codebuild-and-codepipeline/\",\"categories\":[\"AWS\",\"DevOps\",\"CodeCommit\",\"CodeBuild\",\"CodePipeline\",\"CloudFormation\"],\"date\":\"2018/01/02\"}}},{\"post\":{\"html\":\"<p>AWS is an enormous jungle. It has more than 50 services, the number of which keeps increasing every year. For beginners like myself, it’s pretty easy to get lost in this jungle. Thanks to my terrible memory, I think it’s useful for me to write down this blog to showcase how I built a simple AWS infrastructure using CloudFormation, and deployed a container on ECS, just in case I forget one day.</p>\\n<!--more-->\\n<p>First of all, I truly believe that <em>everything that can be automated should be automated</em>, so CloudFormation is going to be my main tool to provision the infrastructure. In fact, it’s one of the two services (another is AWS Lambda) that really got me into AWS.</p>\\n<p>So what I built here is a simple cloud infrastructure in which there’re VPC, subnets, load balancer, ECS clusters so on so forth. This infrastructure allows you to deploy containers on ECS clusters which is secure to some extent, and highly available.</p>\\n<p>In short, here is a poorly drawn diagram to illustrate what I built in a high level. I used <a href=\\\"https://www.draw.io/\\\">draw.io</a> to draw this and it actually costed me some effort so don’t you judge it!</p>\\n\\n  <span class=\\\"gatsby-resp-image-wrapper\\\" style=\\\"position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 722px; margin-left: auto; margin-right: auto;\\\">\\n    <span class=\\\"gatsby-resp-image-background-image\\\" style=\\\"padding-bottom: 100.13850415512466%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAChUlEQVQ4y5VUS2/TQBDOX+VKz0hckDgiIY49gFQQ4nEo5YKqitJSECqCJhUtEkIkUIkkjb21Ha9f63Wc2B87W6/TPCBipNE+PP72m5lvt4EVNh6PcXF6AOtoG6PRaFU4GkXkYvx9H0mSLLjv+2CMIXl6HeLRNT0fDodLY8npwIbz8yuSkx0EZydIW1v6B+OWZemRHW6iv/dwZm/e0zRFFEVoEAtfbUirjezHBxTOL+SHGyjzFFJEapTwTlUGZ8co1DyNOMrxCPnRc0z6p/o7rUM+vGTY6/X0ppQSuVDpsw7C7Tvo97o6gL6dN3fh79+HjAPEgQsRc/hv1hG3PyEMQ107iguCoAJUJxBd+8sDvWnbNvx2E9y1kYkYZVGAWQMEQw+scwCvewTHcXRswH0NShhTwArd8zwdGLsDyGdryI+3EHgXmIQOxEVXsZvWzHVdyPeK9Ysb+t8FhrQwRql2P+9gyM4VKxfZ67uQr24jCbmWkTHn20f83nusD1jK8KqRDMiIodc+Bu804bHBDGChSiGEWM2QjJqkARVDM/ccNgNo4jTgPEPO+WWRK6da0p4I/Row8l1d5/k4kt4CQ127hOmR0jDXjL4ZQJlEmGTKc6GFTPtlWdZxMwyp9fbJRn0qjcSQtGcAE9Vl1nmnZNOayqbyBYbUKSMbYmhsvoaUnomrY5bV0DSlYG3wl7dQji5BuctqQLfqcpnFCJ6sYeL3p4B/63IhY8RbN5G1NvXa6ne1PLTu7AqwmEC8XUe6e281wyzLdEpXdWiMboqRDd0USv+fDOedmpLGYQ2YS7EgGxNXM6RmcFX4cpxVPpod1TNmzDxVZZ4tjPXzRYB5ni9l+D9OYKSOP0B58Dc2a6c9AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\\\">\\n      <img class=\\\"gatsby-resp-image-image\\\" style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\" alt=\\\"Infrastructure\\\" title=\\\"\\\" src=\\\"/static/infrastructure-8f75cbdb4a671c074a696017b5aeb1af-5ba46.png\\\" srcset=\\\"/static/infrastructure-8f75cbdb4a671c074a696017b5aeb1af-584f6.png 188w,\\n/static/infrastructure-8f75cbdb4a671c074a696017b5aeb1af-a48bd.png 375w,\\n/static/infrastructure-8f75cbdb4a671c074a696017b5aeb1af-5ba46.png 722w\\\" sizes=\\\"(max-width: 722px) 100vw, 722px\\\">\\n    </span>\\n  </span>\\n  \\n<h2>Infrastructure</h2>\\n<p>To make my infrastructure highly availalbe, I choose to use 2 available zones - which I’ll call AZ1 and AZ2 just for simplicity. I divide each zone into 3 subnets, although from the diagram you can only see 2.</p>\\n<h3>Public subnet</h3>\\n<p>The Internet facing subnet (my <a href=\\\"https://en.wikipedia.org/wiki/DMZ_(computing)\\\">DMZ</a>), which I call public subnet is where I put things like <em>jumpbox</em> or <em>NAT gateway</em>. Any EC2 instance I deploy in this subnet will automatically have an assigned public IP, which means if I open port 22 through its security groups, I can SSH to the terminal from the Internet. As you can imagine, this is not a good place for your application servers, as this is the front line between the evil world and your happy private paradise, so we need to leave our servers and databases out of this area. However, this is the right place for everything that should be public facing, such as NAT gateway.</p>\\n<h3>Service subnet</h3>\\n<p>This is where I deploy my ECS clusters. The idea is that only load balancer can forward the requests from public subnets to these clusters, so all I need to do is to allow ALB (application load balancer) to hit the clusters. I can achieve this by creating a security group for ALB to listen to Internet requests on port 443, and then attaching a security group on clusters, which grants the inbound access for instances belonging to ALB security group, which is the ALB itself.</p>\\n<p>Another caveat I encountered was that to register EC2 instances to a ECS cluster, those instances need to have public IPs. If you think about it, instances in private subnets don’t have public IPs, so that seems like a conflict now? Not really, because you can put a NAT gateway - well, technically 2 for high availability - in public subnets, and then add a route <em>0.0.0.0/0->NAT</em> for the instances, so outgoing traffic will all go through the NAT gateway, which will translate their private IPs into public IPs, so that ECS agents can work properly.</p>\\n<h3>Application load balancer</h3>\\n<p>There’s not much to say about this but do understand one thing, that the traffic between the ALB and the ECS clusters may or may not be secure, which is totally up to how you implement your services. You can force the HTTP encryption between ALB and ECS, but that requires your web server - kestrel (.NET Core) for example - to be able to decrypt the traffic, given the SSL/TLS certificate. However, if your application server cannot decrypt it, then you can’t encrypt the traffic, otherwise nothing works.</p>\\n<h3>Data subnet</h3>\\n<p>This is something I left for future. At the moment I’m not planning to run any RDS (they’re indeed way more expensive than small EC2 instances). But as the name suggests, this is where you put data servers. ALB should not have access to this area. In fact, this subnet should be mostly protected as it’s the place for your data, which has not public facing responsibility. If somehow this area is compromised, you’ll be in trouble.</p>\\n<h3>Spot instance</h3>\\n<p>I chose to run spot instances for ECS clusters, as they’re way cheaper than on-demand instances. Beause I’m not running any commercial website, I can just put a very low bid price there hoping that the price will always be slightly higher than spot instance price, which will keep all my instances running. In fact, I use spot instances in my company for test environment and the website went down ever since. It makes a lot sense to do this especially when you run small business or startup, in which you want to save every cent of your money but also enjoy the power that AWS brings to you, so spot instance is a fine choice fro you.</p>\\n<h2>CloudFormation</h2>\\n<p>So far you should understand the infrastructure from a high level. Now it’s time to build it. With CloudFormation, I can deploy the whole infrastructure without endless cliking in AWS console, so here’re the templates I used to provision my infrastructure. You can read them and reuse them or roll your own, so let’s have a look.</p>\\n<p>With the CloudFormation templates below, I built the infrastructure depicted in the diagram. If you want to reuse them, make sure you run them in such correct sequence and use the stack name I provided here:</p>\\n<ul>\\n<li>infra-vpc</li>\\n<li>infra-sgs</li>\\n<li>infra-alb</li>\\n<li>infra-ecs-cluster</li>\\n</ul>\\n<h3>VPC - (infra-vpc)</h3>\\n<p>This template built VPC where 6 subnets (public subnets, service subnets and data subnets) exist. I added a parameter <code>EnableNat</code> which controls whether or not I build NAT gateways as I don’t want to run NAT gateways for personal AWS account - it costs money!</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2010-09-09</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> VPC and subnets\\n\\n<span class=\\\"token key atrule\\\">Parameters</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">VpcCidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for VPC\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.61.0/22\\n\\n  <span class=\\\"token key atrule\\\">EnableNat</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Whether to create NAT gateways for private subnets\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">false</span>\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for public subnet 1\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.61.0/26\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for public subnet 2\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.61.64/26\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for service (private) subnet 1\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.62.0/26\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for service (private) subnet 2\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.62.64/26\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for data (private) subnet 1\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.63.0/26\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for data (private) subnet 2\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.63.64/26\\n\\n<span class=\\\"token key atrule\\\">Conditions</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">EnableNat</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Equals</span> <span class=\\\"token punctuation\\\">[</span> <span class=\\\"token tag\\\">!Ref</span> EnableNat<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"true\\\"</span> <span class=\\\"token punctuation\\\">]</span>\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Vpc</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VPC\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> VpcCidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Vpc\\n\\n  <span class=\\\"token key atrule\\\">InternetGateway</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>InternetGateway\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>InternetGateway\\n\\n  <span class=\\\"token key atrule\\\">InternetGatewayVpcAttachment</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VPCGatewayAttachment\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">InternetGatewayId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> InternetGateway\\n\\n  <span class=\\\"token key atrule\\\">NatGatewayAz1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>NatGateway\\n    <span class=\\\"token key atrule\\\">Condition</span><span class=\\\"token punctuation\\\">:</span> EnableNat\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span> InternetGatewayVpcAttachment\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AllocationId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> NatEipAz1.AllocationId\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1\\n\\n  <span class=\\\"token key atrule\\\">NatEipAz1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EIP\\n    <span class=\\\"token key atrule\\\">Condition</span><span class=\\\"token punctuation\\\">:</span> EnableNat\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span> InternetGatewayVpcAttachment\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Domain</span><span class=\\\"token punctuation\\\">:</span> vpc\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">0</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1Cidr\\n      <span class=\\\"token key atrule\\\">MapPublicIpOnLaunch</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">1</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet2Cidr\\n      <span class=\\\"token key atrule\\\">MapPublicIpOnLaunch</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnetsRouteTable</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>RouteTable\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnetsRouteTable\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet1Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet2\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnetsInternetGatewayRoute</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Route\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span> InternetGatewayVpcAttachment\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">DestinationCidrBlock</span><span class=\\\"token punctuation\\\">:</span> 0.0.0.0/0\\n      <span class=\\\"token key atrule\\\">GatewayId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> InternetGateway    \\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">0</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet1Cidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet1\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">1</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet2Cidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet2\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnetsRouteTable</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>RouteTable\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnetsRouteTable\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet1\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet2\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnetsNatGatewayAz1Route</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Route\\n    <span class=\\\"token key atrule\\\">Condition</span><span class=\\\"token punctuation\\\">:</span> EnableNat\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">DestinationCidrBlock</span><span class=\\\"token punctuation\\\">:</span> 0.0.0.0/0\\n      <span class=\\\"token key atrule\\\">NatGatewayId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> NatGatewayAz1\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">0</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet1Cidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet1\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">1</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet2Cidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet2\\n\\n  <span class=\\\"token key atrule\\\">DataSubnetsRouteTable</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>RouteTable\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnetsRouteTable\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet1\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet2\\n\\n  <span class=\\\"token key atrule\\\">DataSubnetsNatGatewayAz1Route</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Route\\n    <span class=\\\"token key atrule\\\">Condition</span><span class=\\\"token punctuation\\\">:</span> EnableNat\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">DestinationCidrBlock</span><span class=\\\"token punctuation\\\">:</span> 0.0.0.0/0\\n      <span class=\\\"token key atrule\\\">NatGatewayId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> NatGatewayAz1\\n\\n<span class=\\\"token key atrule\\\">Outputs</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> VPC ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n\\n  <span class=\\\"token key atrule\\\">VpcCidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> VPC CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> VpcCidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcCidr\\n  \\n  <span class=\\\"token key atrule\\\">PublicSubnet1Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Public subnet 1 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1Id\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Public subnet 1 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1Cidr\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Public subnet 2 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet2\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2Id\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Public subnet 2 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet2Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2Cidr\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Service subnet 1 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet1\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet1Id\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Service subnet 1 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet1Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet1Cidr\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Service subnet 2 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet2\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet2Id\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Service subnet 2 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet2Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet2Cidr\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Data subnet 1 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet1\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet1Id\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Data subnet 1 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet1Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet1Cidr\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Data subnet 2 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet2\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet2Id\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Data subnet 2 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet2Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet2Cidr\\n</code></pre>\\n      </div>\\n<h3>Shared security groups - (infra-sgs)</h3>\\n<p>I usually define some shared security groups for other resources to share.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2010-09-09</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Shared security groups\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">DefaultIngressSg</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SecurityGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">GroupDescription</span><span class=\\\"token punctuation\\\">:</span> SSH access across the VPC\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n      <span class=\\\"token key atrule\\\">SecurityGroupIngress</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> icmp\\n          <span class=\\\"token key atrule\\\">FromPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">8</span>\\n          <span class=\\\"token key atrule\\\">ToPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">8</span>\\n          <span class=\\\"token key atrule\\\">CidrIp</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcCidr\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> tcp\\n          <span class=\\\"token key atrule\\\">FromPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">22</span>\\n          <span class=\\\"token key atrule\\\">ToPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">22</span>\\n          <span class=\\\"token key atrule\\\">CidrIp</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcCidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DefaultIngressSg\\n\\n<span class=\\\"token key atrule\\\">Outputs</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">DefaultIngressSgId</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Default ingress security group id\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DefaultIngressSg\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DefaultIngressSgId\\n</code></pre>\\n      </div>\\n<h3>ALB - (infra-alb)</h3>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2010-09-09</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Application load balancer\\n\\n<span class=\\\"token key atrule\\\">Parameters</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">CertificateArn</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The ARN of the SSL/TLS certificate for ALB port 443 listener\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>acm<span class=\\\"token punctuation\\\">:</span>ap<span class=\\\"token punctuation\\\">-</span>southeast<span class=\\\"token punctuation\\\">-</span>2<span class=\\\"token punctuation\\\">:</span>504224764639<span class=\\\"token punctuation\\\">:</span>certificate/ce5a2456<span class=\\\"token punctuation\\\">-</span>f97b<span class=\\\"token punctuation\\\">-</span>49ed<span class=\\\"token punctuation\\\">-</span>91fd<span class=\\\"token punctuation\\\">-</span>323b0e290fb8\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">LoadBalancer</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ElasticLoadBalancingV2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancer\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Subnets</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1Id\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2Id\\n      <span class=\\\"token key atrule\\\">SecurityGroups</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!Ref</span> LoadBalancerSg\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancer\\n\\n  <span class=\\\"token key atrule\\\">LoadBalancerSg</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SecurityGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">GroupDescription</span><span class=\\\"token punctuation\\\">:</span> Public access to ALB\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n      <span class=\\\"token key atrule\\\">SecurityGroupIngress</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">CidrIp</span><span class=\\\"token punctuation\\\">:</span> 0.0.0.0/0\\n          <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> tcp\\n          <span class=\\\"token key atrule\\\">FromPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">443</span>\\n          <span class=\\\"token key atrule\\\">ToPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">443</span>\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerSg\\n  \\n  <span class=\\\"token comment\\\"># We're not going to use the default group but we need this to create ALB</span>\\n  <span class=\\\"token key atrule\\\">DefaultTargetGroup</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ElasticLoadBalancingV2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>TargetGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Port</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">80</span>\\n      <span class=\\\"token key atrule\\\">Protocol</span><span class=\\\"token punctuation\\\">:</span> HTTP\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DefaultTargetGroup\\n\\n  <span class=\\\"token key atrule\\\">LoadBalancerListener</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ElasticLoadBalancingV2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Listener\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">LoadBalancerArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> LoadBalancer\\n      <span class=\\\"token key atrule\\\">Port</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">443</span>\\n      <span class=\\\"token key atrule\\\">Protocol</span><span class=\\\"token punctuation\\\">:</span> HTTPS\\n      <span class=\\\"token key atrule\\\">Certificates</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">CertificateArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> CertificateArn\\n      <span class=\\\"token key atrule\\\">DefaultActions</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">TargetGroupArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DefaultTargetGroup\\n          <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> forward\\n\\n<span class=\\\"token key atrule\\\">Outputs</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">LoadBalancerListenerArn</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> LoadBalancerListener\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerListenerArn\\n\\n  <span class=\\\"token key atrule\\\">LoadBalancerSgId</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> LoadBalancerSg\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerSgId\\n</code></pre>\\n      </div>\\n<h3>ECS cluster (infra-ecs-cluster)</h3>\\n<p>Here’s the how I provisioned an ECS cluster based on a spot fleet request. Notice that here I put EC2 instances in public subnets, which is not best practice in terms of security, but it saves me money as otherwise I need to put NAT gateways in public subnets so that my EC2 instances in private subnets can have public IPs for ECS agents to talk to ECS service.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2010-09-09</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> ECS cluster of spot fleet\\n\\n<span class=\\\"token key atrule\\\">Parameters</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">ClusterName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Name of the ECS cluster\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> ApplicationCluster\\n\\n  <span class=\\\"token key atrule\\\">TargetCapacity</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> Number\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> How many EC2 instances do we want\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1 </span><span class=\\\"token comment\\\"># HA needs at least 2</span>\\n\\n  <span class=\\\"token key atrule\\\">InstanceType</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedValues</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> t2.micro\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> EC2 instance type to use for ECS cluster\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> t2.micro\\n\\n  <span class=\\\"token key atrule\\\">KeyName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>KeyPair<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>KeyName\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Name of an existing EC2 KeyPair to enable SSH access to the EC2 instances\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> default<span class=\\\"token punctuation\\\">-</span>keypair\\n\\n  <span class=\\\"token key atrule\\\">SpotBidPrice</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Maximum price that you are willing to pay per hour per instance\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">0.0035</span>\\n\\n<span class=\\\"token key atrule\\\">Mappings</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">AWSRegionToECSAMI</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">ap-northeast-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>af46dbc9\\n    <span class=\\\"token key atrule\\\">ap-southeast-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>fec3b482\\n    <span class=\\\"token key atrule\\\">ap-southeast-2</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>b88e7cda\\n    <span class=\\\"token key atrule\\\">ca-central-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>e8cb4e8c\\n    <span class=\\\"token key atrule\\\">eu-central-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>b378e8dc\\n    <span class=\\\"token key atrule\\\">eu-west-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>7827b301\\n    <span class=\\\"token key atrule\\\">eu-west-2</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>acd5cdc8\\n    <span class=\\\"token key atrule\\\">us-east-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span><span class=\\\"token number\\\">13401669</span>\\n    <span class=\\\"token key atrule\\\">us-east-2</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>901338f5\\n    <span class=\\\"token key atrule\\\">us-west-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>b3adacd3\\n    <span class=\\\"token key atrule\\\">us-west-2</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>9a02a9e2\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">EcsCluster</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ECS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Cluster\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">ClusterName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ClusterName\\n\\n  <span class=\\\"token key atrule\\\">EcsHostSg</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SecurityGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n      <span class=\\\"token key atrule\\\">GroupDescription</span><span class=\\\"token punctuation\\\">:</span> Access to the ECS hosts and the tasks/containers that run on them\\n      <span class=\\\"token key atrule\\\">SecurityGroupIngress</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token comment\\\"># allow free access for ALB</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"-1\\\"</span>\\n          <span class=\\\"token key atrule\\\">SourceSecurityGroupId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>alb<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerSgId\\n        <span class=\\\"token comment\\\"># SSH for jumpbox</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> tcp\\n          <span class=\\\"token key atrule\\\">FromPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">22</span>\\n          <span class=\\\"token key atrule\\\">ToPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">22</span>\\n          <span class=\\\"token key atrule\\\">CidrIp</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcCidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EcsHostSg\\n\\n  <span class=\\\"token key atrule\\\">SpotFleet</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SpotFleet\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> SpotFleetRole\\n      <span class=\\\"token punctuation\\\">-</span> SpotFleetInstanceProfile\\n      <span class=\\\"token punctuation\\\">-</span> EcsHostSg\\n      <span class=\\\"token punctuation\\\">-</span> EcsCluster\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">SpotFleetRequestConfigData</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">AllocationStrategy</span><span class=\\\"token punctuation\\\">:</span> lowestPrice\\n        <span class=\\\"token key atrule\\\">IamFleetRole</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> SpotFleetRole.Arn\\n        <span class=\\\"token key atrule\\\">LaunchSpecifications</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IamInstanceProfile</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Arn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> SpotFleetInstanceProfile.Arn\\n            <span class=\\\"token key atrule\\\">ImageId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!FindInMap</span> <span class=\\\"token punctuation\\\">[</span>AWSRegionToECSAMI<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">\\\"AWS::Region\\\"</span><span class=\\\"token punctuation\\\">,</span> AMI<span class=\\\"token punctuation\\\">]</span>\\n            <span class=\\\"token key atrule\\\">InstanceType</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> InstanceType\\n            <span class=\\\"token key atrule\\\">KeyName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> KeyName\\n            <span class=\\\"token key atrule\\\">Monitoring</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Enabled</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n            <span class=\\\"token key atrule\\\">SecurityGroups</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">GroupId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> EcsHostSg\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">GroupId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>sgs<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DefaultIngressSgId\\n\\n            <span class=\\\"token comment\\\"># EC2 instances need to have public IPs to register ECS:</span>\\n            <span class=\\\"token comment\\\"># https://stackoverflow.com/questions/31036600/why-cant-my-ecs-service-register-available-ec2-instances-with-my-elb</span>\\n            <span class=\\\"token comment\\\"># I can either use public subnets, which is not best security practice, but it saves</span>\\n            <span class=\\\"token comment\\\"># me money from running NAT gateways.</span>\\n            <span class=\\\"token comment\\\"># Or, I can use service subnets, which is better practice, but I need to run NAT gateways.</span>\\n            <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Join</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">','</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1Id\\n                <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2Id\\n\\n            <span class=\\\"token key atrule\\\">UserData</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">\\\"Fn::Base64\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> <span class=\\\"token punctuation\\\">|</span><span class=\\\"token scalar string\\\">\\n                #!/bin/bash\\n                yum install -y aws-cfn-bootstrap\\n                echo ECS_CLUSTER=${EcsCluster} >> /etc/ecs/ecs.config</span>\\n        <span class=\\\"token key atrule\\\">SpotPrice</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> SpotBidPrice\\n        <span class=\\\"token key atrule\\\">TargetCapacity</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> TargetCapacity\\n        <span class=\\\"token key atrule\\\">TerminateInstancesWithExpiration</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n\\n  <span class=\\\"token key atrule\\\">SpotFleetInstanceProfile</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>IAM<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>InstanceProfile\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> SpotFleetInstanceRole\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> /\\n      <span class=\\\"token key atrule\\\">Roles</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Ref</span><span class=\\\"token punctuation\\\">:</span> SpotFleetInstanceRole\\n\\n  <span class=\\\"token key atrule\\\">SpotFleetInstanceRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>IAM<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Role\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2012-10-17</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> ec2.amazonaws.com\\n      <span class=\\\"token key atrule\\\">ManagedPolicyArns</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>iam<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>policy/service<span class=\\\"token punctuation\\\">-</span>role/AmazonEC2ContainerServiceforEC2Role\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> /\\n\\n  <span class=\\\"token key atrule\\\">SpotFleetRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>IAM<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Role\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2012-10-17</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> spotfleet.amazonaws.com\\n      <span class=\\\"token key atrule\\\">ManagedPolicyArns</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>iam<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>policy/service<span class=\\\"token punctuation\\\">-</span>role/AmazonEC2SpotFleetRole\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> /\\n\\n<span class=\\\"token key atrule\\\">Outputs</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">EcsClusterName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ClusterName\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EcsClusterName\\n</code></pre>\\n      </div>\\n<h2>Conclusion</h2>\\n<p>This is not the final conclusion yet, but so far you can basically understand what I built and why I built in such way. Also, by reading these boring CloudFormation templates (to prove that your life is probably as boring as mine), you’ll have an even better understanding about AWS infrastructure and its automation. Anyway, this is part 1 and now let’s take a break and to be continued…</p>\",\"frontmatter\":{\"layout\":\"post\",\"title\":\"Build your AWS infrastructure - Part 1\",\"path\":\"/build-your-aws-infrastructure-part-1/\",\"categories\":[\"AWS\",\"DevOps\",\"CloudFormation\",\"VPC\",\"ECS\",\"SpotInstance\"],\"date\":\"2018/01/08\"}}},{\"post\":{\"html\":\"<p>Hey fellas, you’re reading part 2 of <a href=\\\"/build-your-aws-infrastructure-part-1/\\\">Build your AWS infrastructure</a>. In part 1, I showed you how I built the basic infrastrucutre from VPC to load balancer and then to ECS cluster. Since we’ve got the foundation by now, let’s start building applications!</p>\\n<!--more-->\\n<h2>Overview</h2>\\n<p>Here’s an overview of what I did: I built a simple .NET core application, deployed it as a container on ECS and added a Route53 record set pointing to my application load balancer which points to my ECS cluster. Here’s an example: when users type <code>www.disasterdev.net</code> in their browser,the request is forwarded to my load balancer first, and then, based on the path of the request, the ALB (application load balancer) knows how to route the request to the corresponding container. Let’s see how I did all these in details.</p>\\n<h2>Build .NET core application</h2>\\n<p>You probably have heard of <a href=\\\"https://www.microsoft.com/net/learn/get-started/macos\\\">.NET core</a> already. Prior to its brith, we could only deploy .NET applications on windows servers (yeah yeah… I there’s Mono). Most importantly, it was very difficult to run .NET applications as containers - now that really sucks. Microsoft knew how important container technology would be, so it rewrote .NET framework from scratch, which is aimed to be cross-platform. Now with .NET core, I can deploy it as containers on Linux, which is huge benefit as now I can easily deploy a .NET core application on AWS cloud!</p>\\n<p>If you’re a .NET developer, do yourself a favor and start learning .NET core today - I believe it’ll gradually replace traditional .NET applications, and most importantly, you don’t have to worry cross-plat form issue anymore.</p>\\n<p>I assume you have installed .NET core SDK and runtime. Open terminal, and type</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-none\\\"><code>mkdir SampleNetCoreAWS\\ncd SampleNetCoreAWS\\ndotnet new web\\ndotnet restore\\ndotnet run</code></pre>\\n      </div>\\n<p>Bang! There’s your first .NET core application running on <code>http://localhost:5000</code> already. Before deploying it to AWS, I did a few changes:</p>\\n<p>In <code>Program.cs</code>:</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-csharp\\\"><code><span class=\\\"token keyword\\\">public</span> <span class=\\\"token keyword\\\">static</span> IWebHost <span class=\\\"token function\\\">BuildWebHost</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">string</span><span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">]</span> args<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=</span><span class=\\\"token operator\\\">></span>\\n    WebHost<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">CreateDefaultBuilder</span><span class=\\\"token punctuation\\\">(</span>args<span class=\\\"token punctuation\\\">)</span>\\n        <span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">UseKestrel</span><span class=\\\"token punctuation\\\">(</span>options <span class=\\\"token operator\\\">=</span><span class=\\\"token operator\\\">></span>\\n        <span class=\\\"token punctuation\\\">{</span>\\n            <span class=\\\"token comment\\\">// kestrel listens to port 5000 of any IPs</span>\\n            options<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">Listen</span><span class=\\\"token punctuation\\\">(</span>IPAddress<span class=\\\"token punctuation\\\">.</span>Any<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token keyword\\\">int</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">Parse</span><span class=\\\"token punctuation\\\">(</span>Environment<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">GetEnvironmentVariable</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"PORT\\\"</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">?</span><span class=\\\"token operator\\\">?</span> <span class=\\\"token string\\\">\\\"5000\\\"</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span>\\n        <span class=\\\"token punctuation\\\">.</span><span class=\\\"token generic-method function\\\">UseStartup<span class=\\\"token punctuation\\\">&lt;</span>Startup<span class=\\\"token punctuation\\\">></span></span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span>\\n        <span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">Build</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n</code></pre>\\n      </div>\\n<p>In <code>Startup.cs</code>:</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-csharp\\\"><code><span class=\\\"token keyword\\\">public</span> <span class=\\\"token keyword\\\">void</span> <span class=\\\"token function\\\">Configure</span><span class=\\\"token punctuation\\\">(</span>IApplicationBuilder app<span class=\\\"token punctuation\\\">,</span> IHostingEnvironment env<span class=\\\"token punctuation\\\">)</span>\\n<span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>env<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">IsDevelopment</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span>\\n    <span class=\\\"token punctuation\\\">{</span>\\n        app<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">UseDeveloperExceptionPage</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span>\\n\\n    app<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">Map</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"/app/healthcheck\\\"</span><span class=\\\"token punctuation\\\">,</span> HandleHealthCheck<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n    app<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">Map</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"/app\\\"</span><span class=\\\"token punctuation\\\">,</span> HandleApp<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n\\n<span class=\\\"token keyword\\\">private</span> <span class=\\\"token keyword\\\">static</span> <span class=\\\"token keyword\\\">void</span> <span class=\\\"token function\\\">HandleApp</span><span class=\\\"token punctuation\\\">(</span>IApplicationBuilder app<span class=\\\"token punctuation\\\">)</span>\\n<span class=\\\"token punctuation\\\">{</span>\\n    app<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">Run</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">async</span> context <span class=\\\"token operator\\\">=</span><span class=\\\"token operator\\\">></span>\\n    <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">await</span> context<span class=\\\"token punctuation\\\">.</span>Response<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">WriteAsync</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"Hello world!\\\"</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n\\n<span class=\\\"token keyword\\\">private</span> <span class=\\\"token keyword\\\">static</span> <span class=\\\"token keyword\\\">void</span> <span class=\\\"token function\\\">HandleHealthCheck</span><span class=\\\"token punctuation\\\">(</span>IApplicationBuilder app<span class=\\\"token punctuation\\\">)</span>\\n<span class=\\\"token punctuation\\\">{</span>\\n    app<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">Run</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">async</span> context <span class=\\\"token operator\\\">=</span><span class=\\\"token operator\\\">></span>\\n    <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">await</span> context<span class=\\\"token punctuation\\\">.</span>Response<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">WriteAsync</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"I'm running\\\"</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n</code></pre>\\n      </div>\\n<p>Notice that this code was written in the way to fit my scenario only. You can write your own application however you like, but do remember to configure <em>kestrel</em> to listen to <code>IPAddress.Any</code> on port 5000, otherwise you application won’t work, because ECS will have no way to send send traffic to your containers.</p>\\n<p>Don’t forget to add a Dockerfile to build your image:</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-docker\\\"><code><span class=\\\"token keyword\\\">FROM</span> microsoft/dotnet<span class=\\\"token punctuation\\\">:</span>2.0.4<span class=\\\"token punctuation\\\">-</span>sdk<span class=\\\"token punctuation\\\">-</span>2.1.3 as builder\\n\\n<span class=\\\"token keyword\\\">COPY</span> . /app\\n<span class=\\\"token keyword\\\">WORKDIR</span> /app\\n<span class=\\\"token keyword\\\">RUN</span> <span class=\\\"token punctuation\\\">[</span><span class=\\\"token string\\\">\\\"dotnet\\\"</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"restore\\\"</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"--no-cache\\\"</span><span class=\\\"token punctuation\\\">]</span>\\n<span class=\\\"token keyword\\\">RUN</span> dotnet publish <span class=\\\"token punctuation\\\">-</span>c Release <span class=\\\"token punctuation\\\">-</span>r linux<span class=\\\"token punctuation\\\">-</span>x64\\n\\n<span class=\\\"token keyword\\\">FROM</span> microsoft/dotnet<span class=\\\"token punctuation\\\">:</span>2.0.4<span class=\\\"token punctuation\\\">-</span>runtime\\n<span class=\\\"token keyword\\\">WORKDIR</span> /app\\n<span class=\\\"token keyword\\\">COPY</span> <span class=\\\"token punctuation\\\">-</span><span class=\\\"token punctuation\\\">-</span>from=builder /app/bin/Release/netcoreapp2.0/linux<span class=\\\"token punctuation\\\">-</span>64/publish .\\n<span class=\\\"token keyword\\\">EXPOSE</span> 5000\\n<span class=\\\"token keyword\\\">ENTRYPOINT</span> <span class=\\\"token punctuation\\\">[</span><span class=\\\"token string\\\">\\\"dotnet\\\"</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"SampleNetCoreAWS.dll\\\"</span><span class=\\\"token punctuation\\\">]</span>\\n</code></pre>\\n      </div>\\n<p>We also need a buildspec.yml, that is for AWS CodeBuild, which we’ll see later.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token key atrule\\\">version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">0.1</span>\\n\\n<span class=\\\"token key atrule\\\">phases</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">pre_build</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">commands</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> echo <span class=\\\"token punctuation\\\">-</span>n \\\"$CODEBUILD_BUILD_ID\\\" <span class=\\\"token punctuation\\\">|</span> sed \\\"s/.*<span class=\\\"token punctuation\\\">:</span>\\\\(<span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">:</span>xdigit<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">]</span>\\\\<span class=\\\"token punctuation\\\">{</span>7\\\\<span class=\\\"token punctuation\\\">}</span>\\\\).*/\\\\1/\\\" <span class=\\\"token punctuation\\\">></span> /tmp/build_id.out\\n      <span class=\\\"token punctuation\\\">-</span> printf '<span class=\\\"token punctuation\\\">{</span>\\\"tag\\\"<span class=\\\"token punctuation\\\">:</span><span class=\\\"token string\\\">\\\"%s\\\"</span><span class=\\\"token punctuation\\\">}</span>' \\\"$(cat /tmp/build_id.out)\\\" <span class=\\\"token punctuation\\\">></span> build.json\\n      <span class=\\\"token punctuation\\\">-</span> echo Logging in to Amazon ECR\\n      <span class=\\\"token punctuation\\\">-</span> $(aws ecr get<span class=\\\"token punctuation\\\">-</span>login <span class=\\\"token punctuation\\\">-</span><span class=\\\"token punctuation\\\">-</span>region $AWS_DEFAULT_REGION <span class=\\\"token punctuation\\\">-</span><span class=\\\"token punctuation\\\">-</span>no<span class=\\\"token punctuation\\\">-</span>include<span class=\\\"token punctuation\\\">-</span>email)\\n  <span class=\\\"token key atrule\\\">build</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">commands</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> echo Build started on `date` for $ASPNETCORE_ENVIRONMENT\\n      <span class=\\\"token punctuation\\\">-</span> docker build <span class=\\\"token punctuation\\\">-</span><span class=\\\"token punctuation\\\">-</span>tag \\\"$REPOSITORY_URI<span class=\\\"token punctuation\\\">:</span>$(cat /tmp/build_id.out)\\\" .\\n  <span class=\\\"token key atrule\\\">post_build</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">commands</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> echo Build completed on `date`\\n      <span class=\\\"token punctuation\\\">-</span> echo Pushing the Docker image<span class=\\\"token punctuation\\\">...</span>\\n      <span class=\\\"token punctuation\\\">-</span> docker push \\\"$REPOSITORY_URI<span class=\\\"token punctuation\\\">:</span>$(cat /tmp/build_id.out)\\\"\\n<span class=\\\"token key atrule\\\">artifacts</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">files</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token punctuation\\\">-</span> build.json\\n    <span class=\\\"token punctuation\\\">-</span> cfn/**/*\\n</code></pre>\\n      </div>\\n<h2>Deployment</h2>\\n<p>To run a container on ECS, we need to define an ECS service, for which we need to define a task definition. A task definition is like a recipe for <em>cooking</em> a container. It tells ECS how to spin up a container, including what Docker image it should use, how much memory it can allocate to the service, what container port it should deploy to, so on so forth. Once the task defined, ECS will maintain desired number of containers running for the task.</p>\\n<p>In <em>SampleNetCoreAWS</em> project, I added the <code>cfn/deploy.yml</code>, which contains the task definition as below. By executing this CloudFormation file, an applicatin stack <code>app-sample-netcore</code> will be created or updated if it exists. The idea is that each deployment produces a brand new version of task definition in the form of CloudFormation. We (technically not we, but the build machine) then applies this new task definition to the ECS service. ECS service detects that its task definition has been updated, so it starts to re-run containers based on the lastet task definition including pulling the new container image, spinning up desired number of containers etc. In short, <code>deploy.yml</code> tells AWS how to deploy our sample .NET core application. Here’s the <code>deploy.yml</code>.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'2010-09-09'</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> ECS Service <span class=\\\"token punctuation\\\">-</span> sample<span class=\\\"token punctuation\\\">-</span>netcore\\n\\n<span class=\\\"token key atrule\\\">Parameters</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">ApplicationName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The name of the application we're trying to deploy<span class=\\\"token punctuation\\\">,</span> which will be\\n      used for service name and container name etc.\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> sample<span class=\\\"token punctuation\\\">-</span>netcore\\n\\n  <span class=\\\"token key atrule\\\">EnvironmentName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The runtime environment name for this application<span class=\\\"token punctuation\\\">,</span> e.g. ASPNETCORE_ENVIRONMENT\\n      for Dotnet Core<span class=\\\"token punctuation\\\">,</span> NODE_ENV for Node\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> Development\\n\\n  <span class=\\\"token key atrule\\\">BaseImageName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The docker image name\\n\\n  <span class=\\\"token key atrule\\\">EnableHttps</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Set this to true if you want to encrpyted traffic between ALB and ECS\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">false</span>\\n\\n  <span class=\\\"token key atrule\\\">ClusterName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The name of the ECS cluster where this service is about to be deployed\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> ApplicationCluster\\n\\n  <span class=\\\"token key atrule\\\">DesiredCount</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> Number\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> How many instance of this task should we run across our cluster<span class=\\\"token punctuation\\\">?</span>\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n\\n  <span class=\\\"token key atrule\\\">Priority</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Priority to evaluate Path rules\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> Number\\n    <span class=\\\"token key atrule\\\">MaxValue</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">50000</span>\\n    <span class=\\\"token key atrule\\\">MinValue</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n\\n  <span class=\\\"token key atrule\\\">ImageTag</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The docker image tag\\n\\n  <span class=\\\"token key atrule\\\">HealthCheckPath</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Every container must provide a health url for the load balancer to\\n      test with\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> /app/healthcheck\\n\\n  <span class=\\\"token key atrule\\\">DeregistrationDelay</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> Number\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The duration (in seconds) ECS waits for before degistrating a container\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">5</span>\\n\\n  <span class=\\\"token key atrule\\\">Memory</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> Number\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> 'Soft memory limit of this task<span class=\\\"token punctuation\\\">:</span> the service cannot use memory above\\n      this number'\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">256</span>\\n\\n  <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The path to register with the ALB\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> /app*\\n\\n  <span class=\\\"token key atrule\\\">ContainerPort</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> Number\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The port the load balancer will map traffic to on the container;\\n      this application should listen to this port as well\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">5000</span>\\n\\n<span class=\\\"token key atrule\\\">Conditions</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">httpsEnabled</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Equals</span>\\n    <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'EnableHttps'</span>\\n    <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token boolean important\\\">true</span>\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ECS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Service\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">LoadBalancers</span><span class=\\\"token punctuation\\\">:</span> \\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">ContainerName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'ApplicationName'</span>\\n            <span class=\\\"token key atrule\\\">TargetGroupArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'TargetGroup'</span>\\n            <span class=\\\"token key atrule\\\">ContainerPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'ContainerPort'</span>\\n      <span class=\\\"token key atrule\\\">Cluster</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'ClusterName'</span>\\n      <span class=\\\"token key atrule\\\">Role</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'ServiceRole'</span>\\n      <span class=\\\"token key atrule\\\">TaskDefinition</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'TaskDefinition'</span>\\n      <span class=\\\"token key atrule\\\">DesiredCount</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'DesiredCount'</span>\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span> ListenerRule\\n\\n  <span class=\\\"token key atrule\\\">ServiceRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>IAM<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Role\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> /\\n      <span class=\\\"token key atrule\\\">Policies</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">PolicyName</span><span class=\\\"token punctuation\\\">:</span> ECSService\\n          <span class=\\\"token key atrule\\\">PolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'2012-10-17'</span>\\n            <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n                  <span class=\\\"token punctuation\\\">-</span> ec2<span class=\\\"token punctuation\\\">:</span>AuthorizeSecurityGroupIngress\\n                  <span class=\\\"token punctuation\\\">-</span> ec2<span class=\\\"token punctuation\\\">:</span>Describe*\\n                  <span class=\\\"token punctuation\\\">-</span> elasticloadbalancing<span class=\\\"token punctuation\\\">:</span>DeregisterInstancesFromLoadBalancer\\n                  <span class=\\\"token punctuation\\\">-</span> elasticloadbalancing<span class=\\\"token punctuation\\\">:</span>Describe*\\n                  <span class=\\\"token punctuation\\\">-</span> elasticloadbalancing<span class=\\\"token punctuation\\\">:</span>RegisterInstancesWithLoadBalancer\\n                  <span class=\\\"token punctuation\\\">-</span> elasticloadbalancing<span class=\\\"token punctuation\\\">:</span>DeregisterTargets\\n                  <span class=\\\"token punctuation\\\">-</span> elasticloadbalancing<span class=\\\"token punctuation\\\">:</span>DescribeTargetGroups\\n                  <span class=\\\"token punctuation\\\">-</span> elasticloadbalancing<span class=\\\"token punctuation\\\">:</span>DescribeTargetHealth\\n                  <span class=\\\"token punctuation\\\">-</span> elasticloadbalancing<span class=\\\"token punctuation\\\">:</span>RegisterTargets\\n                <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'*'</span>\\n                <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> ecs.amazonaws.com\\n\\n  <span class=\\\"token key atrule\\\">TaskRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>IAM<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Role\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span> ecs<span class=\\\"token punctuation\\\">-</span>tasks.amazonaws.com\\n\\n  <span class=\\\"token key atrule\\\">TaskDefinition</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ECS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>TaskDefinition\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">TaskRoleArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> <span class=\\\"token string\\\">'TaskRole.Arn'</span>\\n      <span class=\\\"token key atrule\\\">ContainerDefinitions</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Environment</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> ASPNETCORE_ENVIRONMENT\\n              <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'EnvironmentName'</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> PORT\\n              <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'ContainerPort'</span>\\n          <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'ApplicationName'</span>\\n          <span class=\\\"token key atrule\\\">Image</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> <span class=\\\"token string\\\">'${BaseImageName}:${ImageTag}'</span>\\n          <span class=\\\"token key atrule\\\">PortMappings</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">ContainerPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'ContainerPort'</span>\\n          <span class=\\\"token key atrule\\\">LogConfiguration</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">LogDriver</span><span class=\\\"token punctuation\\\">:</span> awslogs\\n            <span class=\\\"token key atrule\\\">Options</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">awslogs-group</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'AWS::StackName'</span>\\n              <span class=\\\"token key atrule\\\">awslogs-region</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'AWS::Region'</span>\\n          <span class=\\\"token key atrule\\\">Memory</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'Memory'</span>\\n          <span class=\\\"token key atrule\\\">Essential</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span> CloudWatchLogsGroup\\n\\n  <span class=\\\"token key atrule\\\">CloudWatchLogsGroup</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Logs<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LogGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RetentionInDays</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">60</span>\\n      <span class=\\\"token key atrule\\\">LogGroupName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'AWS::StackName'</span>\\n\\n  <span class=\\\"token key atrule\\\">TargetGroup</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ElasticLoadBalancingV2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>TargetGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">HealthyThresholdCount</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">2</span>\\n      <span class=\\\"token key atrule\\\">HealthCheckIntervalSeconds</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">10</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> <span class=\\\"token string\\\">'infra-vpc::VpcId'</span>\\n      <span class=\\\"token key atrule\\\">Protocol</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!If</span>\\n        <span class=\\\"token punctuation\\\">-</span> httpsEnabled\\n        <span class=\\\"token punctuation\\\">-</span> HTTPS\\n        <span class=\\\"token punctuation\\\">-</span> HTTP\\n      <span class=\\\"token key atrule\\\">Matcher</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">HttpCode</span><span class=\\\"token punctuation\\\">:</span> 200<span class=\\\"token punctuation\\\">-</span><span class=\\\"token number\\\">299</span>\\n      <span class=\\\"token key atrule\\\">HealthCheckPath</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'HealthCheckPath'</span>\\n      <span class=\\\"token key atrule\\\">HealthCheckTimeoutSeconds</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">5</span>\\n      <span class=\\\"token key atrule\\\">TargetGroupAttributes</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'DeregistrationDelay'</span>\\n          <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> deregistration_delay.timeout_seconds\\n      <span class=\\\"token key atrule\\\">HealthCheckProtocol</span><span class=\\\"token punctuation\\\">:</span> HTTP\\n      <span class=\\\"token key atrule\\\">Port</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!If</span>\\n        <span class=\\\"token punctuation\\\">-</span> httpsEnabled\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">443</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">80</span>\\n\\n  <span class=\\\"token key atrule\\\">ListenerRule</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ElasticLoadBalancingV2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ListenerRule\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Priority</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'Priority'</span>\\n      <span class=\\\"token key atrule\\\">Conditions</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Field</span><span class=\\\"token punctuation\\\">:</span> path<span class=\\\"token punctuation\\\">-</span>pattern\\n          <span class=\\\"token key atrule\\\">Values</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'Path'</span>\\n      <span class=\\\"token key atrule\\\">Actions</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">TargetGroupArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'TargetGroup'</span>\\n          <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> forward\\n      <span class=\\\"token key atrule\\\">ListenerArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>alb<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerListenerArn\\n</code></pre>\\n      </div>\\n<h2>CICD</h2>\\n<p>We’re almost there. I love AWS CodePipeline + CodeBuild because they’re both managed services, which means I don’t need to run and maintain a build server. CodeBuild provides you with an ephemeral build machine where you can run commands to build docker images and push them to ECR. CodePipeline defines your CICD automation process by letting you define different stages where you can pull source code, build it and deploy your applications. For example the diagram below illustrates a way to make your CICD on AWS.</p>\\n\\n  <span class=\\\"gatsby-resp-image-wrapper\\\" style=\\\"position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 750px; margin-left: auto; margin-right: auto;\\\">\\n    <span class=\\\"gatsby-resp-image-background-image\\\" style=\\\"padding-bottom: 46.49204864359214%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABJUlEQVQoz5WQXU6EMBSFWatbcA0uwAXogzHx0RCMMf48qA8Qw5jMGIMjpQHCj0wrDExLKSB6mSaaGB3jeTpp+/Wce7X3/6jrOpqXSlVVaRsfDzf2CRcluDZP2uVixfiFOXMcx3Vd3/d/hRnnKcl3j7af8H32WhH7LLMMgC+th/laGOMvOI5jSimYRooVL+q6llJyzpqmGZPbVggxwuYMSIRQEARamqaEkHhRnBvHU/sOQq6tU+N2D6b63oXxz2SoPcIqAe4iktOSrUNkLTicg8/LDCYH0/dvZcVUMswMfBiG2o8rhZKQ80KXO/tbj9iEOnyit9ahSlZwFEWbtj0MQ5g+w1fgZc3qgkCfqYMwmnue9zcMFfq+Vx4EO8siNLk60HU9SZIP5k74tbLXLOUAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\\\">\\n      <img class=\\\"gatsby-resp-image-image\\\" style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\" alt=\\\"CICD\\\" title=\\\"\\\" src=\\\"/static/CICD-54ff3498ed5c058ef90acb6ccac28e5f-245fd.png\\\" srcset=\\\"/static/CICD-54ff3498ed5c058ef90acb6ccac28e5f-7aee9.png 188w,\\n/static/CICD-54ff3498ed5c058ef90acb6ccac28e5f-2014b.png 375w,\\n/static/CICD-54ff3498ed5c058ef90acb6ccac28e5f-245fd.png 750w,\\n/static/CICD-54ff3498ed5c058ef90acb6ccac28e5f-952c5.png 1069w\\\" sizes=\\\"(max-width: 750px) 100vw, 750px\\\">\\n    </span>\\n  </span>\\n  \\n<ul>\\n<li>Developers commit code to GitHub repository.</li>\\n<li>CodePipeline polls the source code and passes it to CodeBuild.</li>\\n<li>CodeBuild builds a container image based on <code>buildspec.yml</code> file included in the project root, pushes it to ECR.</li>\\n<li>CodePipeline then runs a CloudFormation template to create a new task definition, and then updates ECS service.</li>\\n<li>ECS service is instructed by the new task definition to pull the container image from ECR and starts the containers using that image.</li>\\n</ul>\\n<p>The steps mentioned above is the complete flow of how CICD works using AWS managed tools and services. I find this approach neat and wasy, and heavily use it in my daily work - no build servers to maintain anymore!</p>\\n<p>Another reason I like this is that - yeah you pretty much have gussed it - you can CloudFormation it! This means I can write a generic CloudFormation template to serve the creation or update of most CICD pipelines. To build a new pipeline, all I need to do is to change a few parameters in the template and deploy it as a new CloudFormation stack. Usually, it only takes less than 1 minute to do so. Even better, I can write a CLI to generate such template and deploy it automatically - all of sudden life is so good already.</p>\\n<p>Here’s the CICD CloudFormation I used for this sample .NET core application.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'2010-09-09'</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"CICD - ECS Service - sample-netcore\\\"</span>\\n\\n<span class=\\\"token key atrule\\\">Parameters</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">ApplicationName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"The name of the application we're about to deploy using this CICD\\\"</span>\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"sample-netcore\\\"</span>\\n\\n  <span class=\\\"token key atrule\\\">RepoName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"The GitHub repository name for this application\\\"</span>\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"SampleNetCoreAWS\\\"</span>\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Repository</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::ECR::Repository\\\"</span>\\n\\n  <span class=\\\"token key atrule\\\">CloudFormationExecutionRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::IAM::Role\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"/\\\"</span>\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n          <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation.amazonaws.com\\n          <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n      <span class=\\\"token key atrule\\\">Policies</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">PolicyName</span><span class=\\\"token punctuation\\\">:</span> CloudFormationExecutionAccess\\n        <span class=\\\"token key atrule\\\">PolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'2012-10-17'</span>\\n          <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation<span class=\\\"token punctuation\\\">:</span>CreateStack\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation<span class=\\\"token punctuation\\\">:</span>DeleteStack\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation<span class=\\\"token punctuation\\\">:</span>DescribeStack*\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation<span class=\\\"token punctuation\\\">:</span>UpdateStack\\n            <span class=\\\"token punctuation\\\">-</span> ec2<span class=\\\"token punctuation\\\">:</span>Describe*\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>*\\n            <span class=\\\"token punctuation\\\">-</span> elasticloadbalancing<span class=\\\"token punctuation\\\">:</span>*\\n            <span class=\\\"token punctuation\\\">-</span> events<span class=\\\"token punctuation\\\">:</span>DescribeRule\\n            <span class=\\\"token punctuation\\\">-</span> events<span class=\\\"token punctuation\\\">:</span>DeleteRule\\n            <span class=\\\"token punctuation\\\">-</span> events<span class=\\\"token punctuation\\\">:</span>ListRuleNamesByTarget\\n            <span class=\\\"token punctuation\\\">-</span> events<span class=\\\"token punctuation\\\">:</span>ListTargetsByRule\\n            <span class=\\\"token punctuation\\\">-</span> events<span class=\\\"token punctuation\\\">:</span>PutRule\\n            <span class=\\\"token punctuation\\\">-</span> events<span class=\\\"token punctuation\\\">:</span>PutTargets\\n            <span class=\\\"token punctuation\\\">-</span> events<span class=\\\"token punctuation\\\">:</span>RemoveTargets\\n            <span class=\\\"token punctuation\\\">-</span> ecs<span class=\\\"token punctuation\\\">:</span>DescribeServices\\n            <span class=\\\"token punctuation\\\">-</span> ecs<span class=\\\"token punctuation\\\">:</span>UpdateService\\n            <span class=\\\"token punctuation\\\">-</span> ecs<span class=\\\"token punctuation\\\">:</span>RegisterTaskDefinition\\n            <span class=\\\"token punctuation\\\">-</span> ecs<span class=\\\"token punctuation\\\">:</span>DeregisterTaskDefinition\\n            <span class=\\\"token punctuation\\\">-</span> ecs<span class=\\\"token punctuation\\\">:</span>CreateService\\n            <span class=\\\"token punctuation\\\">-</span> iam<span class=\\\"token punctuation\\\">:</span>*\\n            <span class=\\\"token punctuation\\\">-</span> logs<span class=\\\"token punctuation\\\">:</span>CreateLogGroup\\n            <span class=\\\"token punctuation\\\">-</span> logs<span class=\\\"token punctuation\\\">:</span>CreateLogStream\\n            <span class=\\\"token punctuation\\\">-</span> logs<span class=\\\"token punctuation\\\">:</span>DescribeLogGroups\\n            <span class=\\\"token punctuation\\\">-</span> logs<span class=\\\"token punctuation\\\">:</span>DeleteLogGroup\\n            <span class=\\\"token punctuation\\\">-</span> logs<span class=\\\"token punctuation\\\">:</span>PutRetentionPolicy\\n\\n  <span class=\\\"token key atrule\\\">CodeBuildServiceRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::IAM::Role\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"/\\\"</span>\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n          <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> codebuild.amazonaws.com\\n          <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n      <span class=\\\"token key atrule\\\">Policies</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">PolicyName</span><span class=\\\"token punctuation\\\">:</span> CodeBuildAccess\\n        <span class=\\\"token key atrule\\\">PolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'2012-10-17'</span>\\n          <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> logs<span class=\\\"token punctuation\\\">:</span>CreateLogGroup\\n            <span class=\\\"token punctuation\\\">-</span> logs<span class=\\\"token punctuation\\\">:</span>CreateLogStream\\n            <span class=\\\"token punctuation\\\">-</span> logs<span class=\\\"token punctuation\\\">:</span>PutLogEvents\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>GetAuthorizationToken\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>s3<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>$<span class=\\\"token punctuation\\\">{</span>ArtifactBucket<span class=\\\"token punctuation\\\">}</span>/*\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>GetObject\\n            <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>PutObject\\n            <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>GetObjectVersion\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>ecr<span class=\\\"token punctuation\\\">:</span>$<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span>$<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>AccountId<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span>repository/$<span class=\\\"token punctuation\\\">{</span>Repository<span class=\\\"token punctuation\\\">}</span>\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>GetDownloadUrlForLayer\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>BatchGetImage\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>BatchCheckLayerAvailability\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>PutImage\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>InitiateLayerUpload\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>UploadLayerPart\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>CompleteLayerUpload\\n      \\n  <span class=\\\"token key atrule\\\">CodePipelineServiceRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::IAM::Role\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"/\\\"</span>\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n          <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> codepipeline.amazonaws.com\\n          <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n      <span class=\\\"token key atrule\\\">Policies</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">PolicyName</span><span class=\\\"token punctuation\\\">:</span> CodePipelineAccess\\n        <span class=\\\"token key atrule\\\">PolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'2012-10-17'</span>\\n          <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!Sub</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>s3<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>$<span class=\\\"token punctuation\\\">{</span>ArtifactBucket<span class=\\\"token punctuation\\\">}</span>/*\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>PutObject\\n            <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>GetObject\\n            <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>GetObjectVersion\\n            <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>GetBucketVersioning\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> codebuild<span class=\\\"token punctuation\\\">:</span>StartBuild\\n            <span class=\\\"token punctuation\\\">-</span> codebuild<span class=\\\"token punctuation\\\">:</span>BatchGetBuilds\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation<span class=\\\"token punctuation\\\">:</span>CreateStack\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation<span class=\\\"token punctuation\\\">:</span>DeleteStack\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation<span class=\\\"token punctuation\\\">:</span>DescribeStack*\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation<span class=\\\"token punctuation\\\">:</span>UpdateStack\\n            <span class=\\\"token punctuation\\\">-</span> iam<span class=\\\"token punctuation\\\">:</span>PassRole\\n\\n  <span class=\\\"token key atrule\\\">ArtifactBucket</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::S3::Bucket\\\"</span>\\n\\n  <span class=\\\"token key atrule\\\">CodeBuildProject</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::CodeBuild::Project\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Artifacts</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Location</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token key atrule\\\">Ref</span><span class=\\\"token punctuation\\\">:</span> ArtifactBucket\\n        <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> S3\\n      <span class=\\\"token key atrule\\\">Source</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Location</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> https<span class=\\\"token punctuation\\\">:</span>//github.com/ticklesource/$<span class=\\\"token punctuation\\\">{</span>RepoName<span class=\\\"token punctuation\\\">}</span>.git\\n        <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> GITHUB\\n      <span class=\\\"token key atrule\\\">Environment</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">ComputeType</span><span class=\\\"token punctuation\\\">:</span> BUILD_GENERAL1_LARGE\\n        <span class=\\\"token key atrule\\\">Image</span><span class=\\\"token punctuation\\\">:</span> aws/codebuild/docker<span class=\\\"token punctuation\\\">:</span>17.09.0\\n        <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> LINUX_CONTAINER\\n        <span class=\\\"token comment\\\"># PrivilegedMode: true</span>\\n        <span class=\\\"token key atrule\\\">EnvironmentVariables</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> AWS_DEFAULT_REGION\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> REPOSITORY_URI\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> <span class=\\\"token string\\\">\\\"${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${Repository}\\\"</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ApplicationName\\n      <span class=\\\"token key atrule\\\">ServiceRole</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> CodeBuildServiceRole\\n\\n  <span class=\\\"token key atrule\\\">Pipeline</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::CodePipeline::Pipeline\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ApplicationName\\n      <span class=\\\"token key atrule\\\">RoleArn</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token tag\\\">!GetAtt</span>\\n        <span class=\\\"token punctuation\\\">-</span> CodePipelineServiceRole\\n        <span class=\\\"token punctuation\\\">-</span> Arn\\n      <span class=\\\"token key atrule\\\">ArtifactStore</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> S3\\n        <span class=\\\"token key atrule\\\">Location</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ArtifactBucket\\n      <span class=\\\"token key atrule\\\">Stages</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Source\\n        <span class=\\\"token key atrule\\\">Actions</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Source\\n          <span class=\\\"token key atrule\\\">ActionTypeId</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Category</span><span class=\\\"token punctuation\\\">:</span> Source\\n            <span class=\\\"token key atrule\\\">Owner</span><span class=\\\"token punctuation\\\">:</span> ThirdParty\\n            <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n            <span class=\\\"token key atrule\\\">Provider</span><span class=\\\"token punctuation\\\">:</span> GitHub\\n          <span class=\\\"token key atrule\\\">Configuration</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Owner</span><span class=\\\"token punctuation\\\">:</span> ktei\\n            <span class=\\\"token key atrule\\\">Repo</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> RepoName\\n            <span class=\\\"token key atrule\\\">Branch</span><span class=\\\"token punctuation\\\">:</span> develop\\n            <span class=\\\"token key atrule\\\">OAuthToken</span><span class=\\\"token punctuation\\\">:</span> your_github_oauth_token <span class=\\\"token comment\\\"># create your own token</span>\\n          <span class=\\\"token key atrule\\\">OutputArtifacts</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Source\\n          <span class=\\\"token key atrule\\\">RunOrder</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Build\\n        <span class=\\\"token key atrule\\\">Actions</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Build\\n          <span class=\\\"token key atrule\\\">ActionTypeId</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Category</span><span class=\\\"token punctuation\\\">:</span> Build\\n            <span class=\\\"token key atrule\\\">Owner</span><span class=\\\"token punctuation\\\">:</span> AWS\\n            <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n            <span class=\\\"token key atrule\\\">Provider</span><span class=\\\"token punctuation\\\">:</span> CodeBuild\\n          <span class=\\\"token key atrule\\\">Configuration</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">ProjectName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> CodeBuildProject\\n          <span class=\\\"token key atrule\\\">InputArtifacts</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Source\\n          <span class=\\\"token key atrule\\\">OutputArtifacts</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> BuildOutput\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Deploy\\n        <span class=\\\"token key atrule\\\">Actions</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Deploy\\n          <span class=\\\"token key atrule\\\">ActionTypeId</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Category</span><span class=\\\"token punctuation\\\">:</span> Deploy\\n            <span class=\\\"token key atrule\\\">Owner</span><span class=\\\"token punctuation\\\">:</span> AWS\\n            <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n            <span class=\\\"token key atrule\\\">Provider</span><span class=\\\"token punctuation\\\">:</span> CloudFormation\\n          <span class=\\\"token key atrule\\\">Configuration</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">ChangeSetName</span><span class=\\\"token punctuation\\\">:</span> Deploy\\n            <span class=\\\"token key atrule\\\">ActionMode</span><span class=\\\"token punctuation\\\">:</span> CREATE_UPDATE\\n            <span class=\\\"token key atrule\\\">StackName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> <span class=\\\"token string\\\">\\\"app-${ApplicationName}\\\"</span>\\n            <span class=\\\"token key atrule\\\">Capabilities</span><span class=\\\"token punctuation\\\">:</span> CAPABILITY_NAMED_IAM\\n            <span class=\\\"token key atrule\\\">TemplatePath</span><span class=\\\"token punctuation\\\">:</span> BuildOutput<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>cfn/deploy.yml\\n            <span class=\\\"token key atrule\\\">RoleArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> <span class=\\\"token punctuation\\\">[</span> CloudFormationExecutionRole<span class=\\\"token punctuation\\\">,</span> Arn <span class=\\\"token punctuation\\\">]</span>\\n            <span class=\\\"token key atrule\\\">ParameterOverrides</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Fn::Sub</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token punctuation\\\">|</span><span class=\\\"token punctuation\\\">-</span>\\n                <span class=\\\"token punctuation\\\">{</span>\\n                  <span class=\\\"token key atrule\\\">\\\"BaseImageName\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${Repository}\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n                  <span class=\\\"token key atrule\\\">\\\"ImageTag\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token punctuation\\\">{</span>\\n                    <span class=\\\"token key atrule\\\">\\\"Fn::GetParam\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token punctuation\\\">[</span>\\n                      <span class=\\\"token string\\\">\\\"BuildOutput\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n                      <span class=\\\"token string\\\">\\\"build.json\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n                      <span class=\\\"token string\\\">\\\"tag\\\"</span>\\n                    <span class=\\\"token punctuation\\\">]</span>\\n                  <span class=\\\"token punctuation\\\">}</span>\\n                <span class=\\\"token punctuation\\\">}</span>\\n          <span class=\\\"token key atrule\\\">InputArtifacts</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> BuildOutput\\n</code></pre>\\n      </div>\\n<h2>Don’t forget Route53</h2>\\n<p>After you build CICD, it’ll start the first build and deployment automatically. If it succeeds, you can access your website through <a href=\\\"https://your-aws-load-balancer-dns-name.aws.com/app\\\">https://your-aws-load-balancer-dns-name.aws.com/app</a>. But this URL is too long to remember and most importantly, you won’t have SSL/TLS certificate to protect the ALB domain. However, if you have bought a domain then you should have at least one hosted zone in Route53 service. Go to that service page and create a new record set, where you should define an A record, for instance <code>www.mydomain.io</code>, pointing to your ALB domain name. Also, you need to use AWS Certificate Manager service to create an SSL/TLS certificate to protect <code>*.mydomain.io</code>. With all these set up, you can then browse <code>https://www.mydomain.io/app</code>.</p>\\n<h2>Conclusion</h2>\\n<p>From <a href=\\\"/build-your-aws-infrastructure-part-1/\\\">Part 1</a> to this Part 2, I’ve showed you how I utilized AWS resources and CloudFomration to build a secure and highly available .NET core website running on AWS ECS within my own VPC. I believe that there’s a lot to digest here if you’re absolutely a beginner on AWS and .NET core. However, I still hope that this article will at least give you some ideas and maybe inspire you in areas such as programming, cloud or DevOps. I enjoyed the journey of doing so and I hope you will too!</p>\",\"frontmatter\":{\"layout\":\"post\",\"title\":\"Build your AWS infrastructure - Part 2\",\"path\":\"/build-your-aws-infrastructure-part-2/\",\"categories\":[\"AWS\",\"DevOps\",\"CloudFormation\",\"ECS\",\"CodePipeline\",\"CodeBuild\",\".NET Core\"],\"date\":\"2018/01/10\"}}},{\"post\":{\"html\":\"<p>Surely when you see the title you’ll probably wonder: <em>“Hmmm… my lambda can access Internet without a problem. What the heck are you talk about?”</em>. Well, when you provision an AWS lambda, you can choose a VPC, and if you do that, then you need to configure your VPC properly otherwise the lambda will lose Internet access.</p>\\n<p>Hold on a second, why do we want lambda to reside in a VPC? A classic example would be: what if you want your lambda to read data from a Redis cluster? This, is when you need VPC, otherwise there’s no way for your lambda to access Redis. Alright, I’m writing this blog because today I had this problem that my lambda within VPC couldn’t access the Internet. It took me a while to figure out why. In fact, I should’ve followed the official documentation in the first place, which would’ve saved me a lot time. But anyway, let’s have a look how to do it.</p>\\n<!--more-->\\n<h2>Background story</h2>\\n<p>Let’s assume your VPC CIDR is <code>10.60.0.0/16</code> and you have two public subnets:</p>\\n<ul>\\n<li><strong>subnet1</strong>: <code>10.60.1.0/24</code></li>\\n<li><strong>subnet2</strong>: <code>10.60.2.0/24</code>.</li>\\n</ul>\\n<p>Also, you have depoyed a Redis cluster across these two subnets, which means the nodes of the cluster are deployed across these two subnets. Alright, now we want to deploy a lambda in this VPC, and allow it to access the Redis and the Internet. So what should we do?</p>\\n<h2>Create a lambda</h2>\\n<p>I assume you’ve got some experience using lambda, so I’m not gonna show you how to create lambda. A good practice is to provision it by CloudFormation, and the easiest way is to login AWS console and click a bunch of things to make it work. When you create the lambda, make sure you scroll down to <em>Configuration</em> section and choose VPC <code>10.60.0.0/16</code>. Then you’ll be asked to choose subnets, just choose both of them (<strong>subnet1</strong> and <strong>subnet2</strong>). By doing this, you can imagine that AWS will provision your lambda on containers running within these subnets.</p>\\n<h2>Security group for Redis</h2>\\n<p>Redis runs on TCP 6379, so the first thing we need to do is to create a RedisSecurityGroup:</p>\\n<ul>\\n<li>VPC: <code>10.60.0.0/16</code></li>\\n<li>Inbound: <code>Allow TCP 6379 from 10.60.0/0/16</code></li>\\n</ul>\\n<p>Attach this security group to both your lambda and Redis cluster. This esures that they can communicate with each other within VPC.</p>\\n<h2>Check your route table</h2>\\n<p>By now, you subnets <code>10.60.1.0/24</code> and <code>10.60.2.0/24</code> should be associated with a route table which has these routes like this:</p>\\n<table>\\n<thead>\\n<tr>\\n<th>Destination</th>\\n<th>Target</th>\\n<th></th>\\n</tr>\\n</thead>\\n<tbody>\\n<tr>\\n<td>10.60.0.0/16</td>\\n<td>local</td>\\n<td></td>\\n</tr>\\n<tr>\\n<td>0.0.0.0/0</td>\\n<td>igw-1234567</td>\\n<td></td>\\n</tr>\\n</tbody>\\n</table>\\n<p>This route table ensures that outgoing traffic will go through Internet gateway and eventually reach the Internet. Now if you think about it, by this logic, lambda should be able to access the Internet already. Well, unfortunately, our lambda doesn’t have public IP yet, which prevents the Internet access.</p>\\n<h2>Add NAT gateway</h2>\\n<p>To give the lambda a public IP, we need a NAT instance or gateway. AWS recommends us to use NAT gateway as it’s managed service. So let’s create a third <strong>subnet3</strong> in AZ3 (it doesn’t have to be in AZ3 though; any AZ is fine): <code>10.60.3.0/24</code>. Then go to VPC service page and create a NAT gateway in this subnet. Add a route table for this subnet with routes like this:</p>\\n<table>\\n<thead>\\n<tr>\\n<th>Destination</th>\\n<th>Target</th>\\n<th></th>\\n</tr>\\n</thead>\\n<tbody>\\n<tr>\\n<td>10.60.0.0/16</td>\\n<td>local</td>\\n<td></td>\\n</tr>\\n<tr>\\n<td>0.0.0.0/0</td>\\n<td>igw-1234567</td>\\n<td></td>\\n</tr>\\n</tbody>\\n</table>\\n<h2>Change routes for subnet1 and subnet2</h2>\\n<p>Suppose your NAT gateway ID is nat-7654321. Now change the route table for <strong>subnet1</strong> and <strong>subnet2</strong>:</p>\\n<table>\\n<thead>\\n<tr>\\n<th>Destination</th>\\n<th>Target</th>\\n<th></th>\\n</tr>\\n</thead>\\n<tbody>\\n<tr>\\n<td>10.60.0.0/16</td>\\n<td>local</td>\\n<td></td>\\n</tr>\\n<tr>\\n<td>0.0.0.0/0</td>\\n<td>nat-7654321</td>\\n<td></td>\\n</tr>\\n</tbody>\\n</table>\\n<p>There you go, now your routes work like this: <em>subnet1/2 -> nat-7654321 -> igw-1234567</em>.</p>\\n<h2>Conclusion</h2>\\n<p>There seems to be a lot steps to get this working, but it’s actually not that hard. What we did here is create a public subnet - <strong>subnet3</strong> where we put a NAT gateway. This public subnet is responsible for all the outgoing traffic to access the Internet. In the meantime, we made <strong>subnet1</strong> and <strong>subnet2</strong> private by removing the route <code>0.0.0.0/0 -> igw-1234567</code>. Instead, we re-route all the outgoing traffic to the NAT gateway residing in <strong>subnet3</strong>. Because <strong>subnet3</strong> has the route to access the Internet, the lambda in <strong>subnet1</strong> and <strong>subnet2</strong> will eventually have their access to Internet. Easy, right?</p>\",\"frontmatter\":{\"layout\":\"post\",\"title\":\"Let your lambda within a VPC access Internet\",\"path\":\"/let-lambda-within-vpc-access-internet/\",\"categories\":[\"AWS\",\"Lambda\",\"VPC\"],\"date\":\"2018/01/17\"}}}]}},\"pathContext\":{}}\n\n/***/ })\n\n});\n\n\n// WEBPACK FOOTER //\n// path---index-3c8a7d03871e4403a099.js","module.exports = {\"data\":{\"site\":{\"siteMetadata\":{\"title\":\"DisasterDev\",\"description\":\"The blog of a disaster developer\",\"url\":\"https://blog.disasterdev.net\",\"author\":\"Rui Cheng\",\"adsense\":\"\"}},\"remark\":{\"posts\":[{\"post\":{\"html\":\"<p>If you’re a developer like me, you probably also want to build a blog site to showcase your ideas, skills, lessons and achievements. What if I tell you I built this site without hosting any server and it’s worldwide-fast, highly available, and even the building process was almost automated, and even better, the cost is almost nothing? <em>“That sounds pretty good, now show me how!”</em> With AWS (I’m not working for their sales team) and laptop, you can do this in one day. Now let me show you how.</p>\\n<!--more-->\\n<p>This article will show you how I built this site by leveraging the power of <a href=\\\"https://aws.amazon.com/\\\">AWS</a> and <a href=\\\"https://reactjs.org/\\\">React</a>. I assume that you have some knowledge regarding AWS, React, Node, so I’ll just focus on the main points. I also assume that you’ve had an AWS account already.</p>\\n<h2>How it works</h2>\\n<p>First of all, here’s the overview of what I did, just to give you a big picture.</p>\\n<ol>\\n<li>\\n<p>I bought the domain (disasterdev.net) directly from AWS <a href=\\\"https://aws.amazon.com/route53/\\\">Route53</a>.</p>\\n</li>\\n<li>\\n<p>I used <a href=\\\"https://www.gatsbyjs.org/\\\">Gatsby</a> (<strong>nothing to do with</strong> Leonardo DiCaprio) to generate all the site contents that’re ready to be deployed. This article will not discuss how to use this tool, so you’ll need to read its documentation, which won’t take you much time.</p>\\n</li>\\n<li>\\n<p>I created an <a href=\\\"https://aws.amazon.com/s3/\\\">S3</a> bucket and put the all website files in that bucket. I also turned on the static website hosting for this bucket and set up public read permission.</p>\\n</li>\\n<li>\\n<p>I created a <a href=\\\"https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Introduction.html\\\">CloudFront</a> distribution which points to the static website URL of the bucket created in step 3 to serve the website to public audience.</p>\\n</li>\\n<li>\\n<p>I created a record set (blog.disasterdev.net) in the hosted zone (disasterdev.net) and pointed it to the domain name of the CloudFront in step 4.</p>\\n</li>\\n<li>\\n<p>I requested an SSL/TLS certificate using <a href=\\\"https://aws.amazon.com/certificate-manager/\\\">Certificate Manager</a> and configured CloudFront distribution in step 4 to use this certificate.</p>\\n</li>\\n<li>\\n<p>One day later, my billing alarm reminded me that I’d spend $600 at the end of this month. On dear, don’t worry, because I’d tell you the mistake I made and make sure you’ll NEVER have to repeat my mistake, just because I’m such a generous person.</p>\\n</li>\\n</ol>\\n<p>Now, let’s stop playing the stupid MMO or watching that R18+ on Netflix - time to do build something!</p>\\n<h2>1. Install Gatsby</h2>\\n<p>There’s not much to say about this. You need to have <a href=\\\"https://nodejs.org/en/\\\">Node</a> installed. Then, you run the following commands to install this tool and get started.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-none\\\"><code>npm install --global gatsby-cli\\ngatsby new blog\\ncd blog\\ngatsby develop</code></pre>\\n      </div>\\n<p>You can play around with Gatsby and create some dummy pages. Once you’re ready, run <code>gatsby build</code> to build it. This will generate all the contents in <code>/public</code> folder, that is ready to be deployed.</p>\\n<h2>2. Create S3 bucket</h2>\\n<p>Login AWS console and go to S3 service page, where you need to create a bucket that will be used to store all the website files. This is the <a href=\\\"https://aws.amazon.com/cloudformation/\\\">CloudFormation</a> template for the bucket.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token key atrule\\\">S3Bucket</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::S3::Bucket\\\"</span>\\n  <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">BucketName</span><span class=\\\"token punctuation\\\">:</span> your.blog\\n</code></pre>\\n      </div>\\n<p><em>“Wait, what the hell is CloudFormation?”</em> might be your question. It’s just a way to automatically provision AWS resources without a thousand times of manual clicks. Whatever you can do with CloudFormation, you can do it via AWS console or CLI as well, so don’t let that freak you out, as you’re free to choose your way of doing things.</p>\\n<p>An S3 bucket by default denies all kinds of requests, except the owner’s. If we are to host a static website using S3, we need to set up public read permission as mentioned <a href=\\\"https://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteAccessPermissionsReqd.html\\\">here</a>. Open S3 service page and click <em>Permissions->Bucket Policy</em> and add the following policy.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-json\\\"><code><span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token property\\\">\\\"Version\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token string\\\">\\\"2008-10-17\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n  <span class=\\\"token property\\\">\\\"Statement\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token punctuation\\\">[</span>\\n    <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token property\\\">\\\"Effect\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token string\\\">\\\"Allow\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n      <span class=\\\"token property\\\">\\\"Principal\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token property\\\">\\\"AWS\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n      <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span>\\n      <span class=\\\"token property\\\">\\\"Action\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token string\\\">\\\"s3:GetObject\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n      <span class=\\\"token property\\\">\\\"Resource\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token string\\\">\\\"arn:aws:s3:::your.blog/*\\\"</span>\\n    <span class=\\\"token punctuation\\\">}</span>\\n  <span class=\\\"token punctuation\\\">]</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n</code></pre>\\n      </div>\\n<p>And this is the CloudFormation template for both S3 bucket policy.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token key atrule\\\">S3BucketPolicy</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::S3::BucketPolicy\\\"</span>\\n  <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span> \\n    <span class=\\\"token key atrule\\\">Bucket</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> S3Bucket\\n    <span class=\\\"token key atrule\\\">PolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span> \\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"s3:GetObject\\\"</span>\\n          <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"Allow\\\"</span>\\n          <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Join</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"\\\"</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"arn:aws:s3:::\\\"</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!Ref</span> S3Bucket\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"/*\\\"</span>\\n          <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">AWS</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n</code></pre>\\n      </div>\\n<h2>3. Create CloudFront distribution</h2>\\n<p>Instead of using S3 to serve the website directly, we will use CloudFront, because this is a static website and CloudFront provides great speed across the world, thanks to its edge locations.</p>\\n<p>Login AWS console and go to CloudFront service page, where you can create the CloudFront distribution. Here’re some highlights that you need to pay attention to:</p>\\n<ul>\\n<li>\\n<p>The origin should be the static website endpoiont of the S3 bucket you created in step 2. It’ll look like this: <em>your.blog.s3-website-ap-southeast-2.amazonaws.com</em>.</p>\\n</li>\\n<li>\\n<p>Set the Default Root Object to <em>index.html</em> so when user requests the root URL, index page will be automatically displayed.</p>\\n</li>\\n<li>\\n<p>For <em>Alias</em>, add the domain name which will be the website URL for your end users, for instance, mine is <code>blog.disasterdev.net</code>.</p>\\n</li>\\n</ul>\\n<p>At last, your distribution settings will look similar as the screenshot below. There’re settings you may not understand yet, for example <em>SSL Certificate</em>, which we will talk about later.</p>\\n\\n  <span class=\\\"gatsby-resp-image-wrapper\\\" style=\\\"position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 750px; margin-left: auto; margin-right: auto;\\\">\\n    <span class=\\\"gatsby-resp-image-background-image\\\" style=\\\"padding-bottom: 63.49206349206349%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABfUlEQVQ4y5VTa4+CQAz0//8wjUaNXjQ+QXmDgCIEEAHnnF7kwx2Ys0mz3c3utJ3O9kz3jMnXBn6U4XK54HA4IkkS2LaN4/EntiwLiqJIzDNN0xDH1+fdA3Rdb+5EUYReXdd4PB74bUEQNI8ZO44jSZi0KArc73fwbVmWsn95D2+MILPZTDKfTifxMAzFfd+H53myvvZM1gk4Ho/R7/cxGAykyv9aK2CaptLuYrHAcrmEYRhQVRXX61Xa+hiQ3JCj9XqN7XYrrbJKEm+aplDBM9d1//DfCshKCMDKptOpcEQeP2qZFRGEMiAQhzEajTCZTGB5ITYHG4ruQHMjJLcaUVaJJ3mFc1rh8oxbK6yqSqRAYLZL7jw/gKoZcDwfR8OC7XgoyrrxNC9we66tgNQcueJAhsOhTJvglAhbJ2+8Q5m8pEO5dHJIrvgD2DYHQA65Z8xBZFn2+ZSZcbfbCdh8PhcwgjJZHMdvpdMp7DzPsVqtsN/vm2/FM66UVZd9Aya45GWYi5fOAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\\\">\\n      <img class=\\\"gatsby-resp-image-image\\\" style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\" alt=\\\"CloudFront settings\\\" title=\\\"\\\" src=\\\"/static/cf-settings-3b9b9716140e8911c9fc43e157c65ca2-245fd.png\\\" srcset=\\\"/static/cf-settings-3b9b9716140e8911c9fc43e157c65ca2-7aee9.png 188w,\\n/static/cf-settings-3b9b9716140e8911c9fc43e157c65ca2-2014b.png 375w,\\n/static/cf-settings-3b9b9716140e8911c9fc43e157c65ca2-245fd.png 750w,\\n/static/cf-settings-3b9b9716140e8911c9fc43e157c65ca2-a0f71.png 1125w,\\n/static/cf-settings-3b9b9716140e8911c9fc43e157c65ca2-9b813.png 1500w,\\n/static/cf-settings-3b9b9716140e8911c9fc43e157c65ca2-380da.png 1638w\\\" sizes=\\\"(max-width: 750px) 100vw, 750px\\\">\\n    </span>\\n  </span>\\n  \\n<h2>4. Create record set</h2>\\n<p>I’m gonna assume you’ve already bought your domain, so if you login AWS console and go to <em>Route53->Hosted zones</em>, you should see something similar to this.</p>\\n\\n  <span class=\\\"gatsby-resp-image-wrapper\\\" style=\\\"position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 750px; margin-left: auto; margin-right: auto;\\\">\\n    <span class=\\\"gatsby-resp-image-background-image\\\" style=\\\"padding-bottom: 30.761209593326384%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA/ElEQVQY032Q626EIBBGff9X68+aeNcVL4h4AYV1jdGvQLdN2m06yQnDJJyZwaOUgjGGrusghIBSyt0tfd8jz3NkWebyqulQEIqKDhBqh3qcL3hhGCIIAhBC0DTNv3DOXdN5nh3XdeF3eG3bIk3T70dVVaEsS8Rx7Oq+7yOKIpdb4ZdUSol1VYb1iYLWdyMcVrTcMKg/afgCQieEWY2eDyhvpWtqhfabbINpmoxMu4m9pHsgIiOSegZbLvQrfkD4hhvTeHvPMM3SPbJb2S3seRwHzvPEtm2fwkXv6LgAGyXu+/XCKDRGqZHkBMJMZaOpaxRFAWYmlM+aDSv8AC5DxG6KuBtVAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\\\">\\n      <img class=\\\"gatsby-resp-image-image\\\" style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\" alt=\\\"Hosted zone\\\" title=\\\"\\\" src=\\\"/static/hosted-zone-67ca3723fbc646b4d45893eb0dfd2cbc-245fd.png\\\" srcset=\\\"/static/hosted-zone-67ca3723fbc646b4d45893eb0dfd2cbc-7aee9.png 188w,\\n/static/hosted-zone-67ca3723fbc646b4d45893eb0dfd2cbc-2014b.png 375w,\\n/static/hosted-zone-67ca3723fbc646b4d45893eb0dfd2cbc-245fd.png 750w,\\n/static/hosted-zone-67ca3723fbc646b4d45893eb0dfd2cbc-a0f71.png 1125w,\\n/static/hosted-zone-67ca3723fbc646b4d45893eb0dfd2cbc-9b813.png 1500w,\\n/static/hosted-zone-67ca3723fbc646b4d45893eb0dfd2cbc-f1539.png 1918w\\\" sizes=\\\"(max-width: 750px) 100vw, 750px\\\">\\n    </span>\\n  </span>\\n  \\n<p>The <em>NS</em> record set have the name servers for your domain, so make sure they also appear in registered domains like this. If they don’t, click <em>Add or edit name servers</em> to update them.</p>\\n\\n  <span class=\\\"gatsby-resp-image-wrapper\\\" style=\\\"position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 750px; margin-left: auto; margin-right: auto;\\\">\\n    <span class=\\\"gatsby-resp-image-background-image\\\" style=\\\"padding-bottom: 28.74743326488706%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA7klEQVQY042RyW6FMAxF+f//Y4GEQBAoY8YHhDDdxn5qF5Va1ZJlZzq+dpKiKFBVFYQQ7H3fo+s63ivLEm3bQkqJfd/xPA/u+/7Tk6ZpYIxhSF3XsNYylICUX9fFFyn+x5Nt23CeJ7TWcM5xrpTCMAysimxdF8zKwq0hwh8cx4Fpmlj5siwYx+l7ndBDY96wEAID53lmIMUQdiz+wms7uOWfRudZliFNU+R5joTIpJLak+YF7dYIkrHqyE5QikYbLkZQUk4F+VwqFGJAXnWQzr+B3vuo0GK2G3w4eKbU1peZOA6atfiIHzZp7uQ3+wQ59cxdpckqkwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\\\">\\n      <img class=\\\"gatsby-resp-image-image\\\" style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\" alt=\\\"Reigstered domains\\\" title=\\\"\\\" src=\\\"/static/registered-domains-e459cd38097d528a47d8c35df7b38736-245fd.png\\\" srcset=\\\"/static/registered-domains-e459cd38097d528a47d8c35df7b38736-7aee9.png 188w,\\n/static/registered-domains-e459cd38097d528a47d8c35df7b38736-2014b.png 375w,\\n/static/registered-domains-e459cd38097d528a47d8c35df7b38736-245fd.png 750w,\\n/static/registered-domains-e459cd38097d528a47d8c35df7b38736-a0f71.png 1125w,\\n/static/registered-domains-e459cd38097d528a47d8c35df7b38736-9b813.png 1500w,\\n/static/registered-domains-e459cd38097d528a47d8c35df7b38736-64938.png 1948w\\\" sizes=\\\"(max-width: 750px) 100vw, 750px\\\">\\n    </span>\\n  </span>\\n  \\n<p>Now, you need to add another record set which points the website domain name to CloudFront domain name.</p>\\n<p>For CloudFront domain name, go to CloudFront service page and find the distribution you just created, which should show you the domain name.</p>\\n<p>For the record set, click <em>Go to Record Sets->yourdomain.net->Create Record Set</em>, and create a record with these properties:</p>\\n<ul>\\n<li>Name: blog.yourdomain.net</li>\\n<li>Type: A - IPv4 address</li>\\n<li>Alias: Yes</li>\\n<li>Alias Target: d2n3whn1234567.cloudfront.net.</li>\\n<li>Alias Hosted Zone ID: Z2FDTNDATAQYW2</li>\\n<li>Routing Policy: Simple</li>\\n<li>Evaluate Target Health: No</li>\\n</ul>\\n<p>This is the CloudFormation template for the record set.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token key atrule\\\">RecourdSet</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Type</span> <span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::Route53::RecordSet\\\"</span>\\n  <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"blog.yourdomain.net\\\"</span>\\n    <span class=\\\"token key atrule\\\">Comment</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"A record for Blog\\\"</span>\\n    <span class=\\\"token key atrule\\\">HostedZoneId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"Z3MTVYTKZKL49\\\"</span>\\n    <span class=\\\"token key atrule\\\">AliasTarget</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">DNSName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> CloudFront.DomainName\\n      <span class=\\\"token key atrule\\\">HostedZoneId</span><span class=\\\"token punctuation\\\">:</span> Z2FDTNDATAQYW2\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> A\\n</code></pre>\\n      </div>\\n<h2>5. Upload your website</h2>\\n<p>By now, we’ve created S3 bucket, CloudFront distribution, a record set pointing to the CloudFront, and more importantly, connected them together. This allows a request to <em>blog.yourdomain.net</em> to be resolved to <em>abcdefg1234567.cloudfront.net</em>, which is eventaully routed to your S3 bucket <em>your.blog.s3-website-ap-southeast-2.amazonaws</em> - where the actual content lies - AWESOME! It’s time to throw some real content into the bucket so users can browse, yeah?</p>\\n<p>Remember in step 1 we ran <code>gatsby build</code> to generate all the website files into <code>/public</code> folder? Now you need to upload all the files to the S3 bucket. Please don’t be naive to upload them one by one; we should run a command to do this. Install <a href=\\\"https://aws.amazon.com/cli/\\\">AWS CLI</a> and run <code>aws configure</code> to configure your AWS credentials properly.</p>\\n<p>Done? Make sure you’re at project root folder, and run <code>aws s3 sync ./public/ s3://your.blog --storage-class REDUCED_REDUNDANCY --delete</code>. This will upload all the files in current directory to <em>your.blog</em> bucket, and also delete the remote files which don’t exist locally anymore - 100% synchronised. Note that I’m using <a href=\\\"https://aws.amazon.com/s3/reduced-redundancy/\\\">reduced redundancy</a> because it’s cheaper and even if I lose the files on S3, I can still regenerate all the files using Gatsby and re-upload them to S3 bucket.</p>\\n<p>Now you open <em><a href=\\\"https://blog.yourdomain.net\\\">https://blog.yourdomain.net</a></em>. Your site should be running, with one thing bugging you though: your browser complains “This website is NOT secure!“.</p>\\n<h2>6. Make it secure</h2>\\n<p>Before you go to Certificate Manager service page, make sure you’re under region US East (N. Virginia), according to <a href=\\\"https://docs.aws.amazon.com/acm/latest/userguide/acm-regions.html\\\">this article</a>: <em>“To use an ACM Certificate with Amazon CloudFront, you must request or import the certificate in the US East (N. Virginia) region.”</em>.</p>\\n<p>Click <em>Request Certificate</em> and type domain name *<em>.yourdomain.net</em>. Note that the aterisk will allow us to use this certificate for all domain names of this kind, such as <em>abc.yourdomain.net</em>, <em>batman.yourdomain.net</em> and so on.</p>\\n<p>Choose <em>DNS validation</em> and follow the instructions to complete the creation wizard. Now you should see a “Pending” certificate. Expand the certificate and you should see a button <em>Create Route53 Record Set</em>, clicking which will create a CNAME record in your hosted zone and a few minutes later the “Pending” status will be updated to “Issued”.</p>\\n<p>Phew, almost there! Remember in step 3 I mentioned <em>SSL Certificate</em>? Now take a note of the ARN of the certificate you just created. Go back to the CloudFront distribution, and fix its <em>SSL Certificate</em> to be this ARN. <strong>Pay attention</strong>: because you’re using CloudFront with a custom SSL certificate, it’s <strong>VERY IMPORTANT</strong> that you also set <em>Custom SSL Client Support</em> to <strong>Only Clients that Support Server Name Indication (SNI)</strong>. Look, I can’t stress this enough as I would have spent $600/month (thanks to my billing alarm, I didn’t) just because I accidentally chose the wrong option here. Anyway, $600 or $0, the choice is yours.</p>\\n<p>Give it some time, and it might take more than 10 minutes. Now open <em><a href=\\\"https://blog.yourdomain.net\\\">https://blog.yourdomain.net</a></em>, and your browser should tell you “Yep, this website is secure!“.</p>\\n<h2>CloudFormation</h2>\\n<p>I’m a big fan of CloudFormation and in reality I used CloudFormation to provision most of the AWS resources I needed for this website, except the hosted zone and certificate. Here’s the complete CloudFormation template I wrote (changed a few parameters), which you can borrow to provision your own website if you find clicking in AWS console is such a chore.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'2010-09-09'</span>\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Blog resources\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">S3Bucket</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::S3::Bucket\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">BucketName</span><span class=\\\"token punctuation\\\">:</span> your.blog\\n      <span class=\\\"token key atrule\\\">WebsiteConfiguration</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">IndexDocument</span><span class=\\\"token punctuation\\\">:</span> index.html\\n        <span class=\\\"token key atrule\\\">ErrorDocument</span><span class=\\\"token punctuation\\\">:</span> error.html\\n\\n  <span class=\\\"token key atrule\\\">S3BucketPolicy</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::S3::BucketPolicy\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span> \\n      <span class=\\\"token key atrule\\\">Bucket</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> S3Bucket\\n      <span class=\\\"token key atrule\\\">PolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span> \\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span> \\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"s3:GetObject\\\"</span>\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"Allow\\\"</span>\\n            <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Join</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"\\\"</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"arn:aws:s3:::\\\"</span>\\n                <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!Ref</span> S3Bucket\\n                <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"/*\\\"</span>\\n            <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">AWS</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n\\n  <span class=\\\"token key atrule\\\">CloudFront</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::CloudFront::Distribution\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">DistributionConfig</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Aliases</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">\\\"blog.disasterdev.net\\\"</span>\\n        <span class=\\\"token key atrule\\\">Comment</span><span class=\\\"token punctuation\\\">:</span> CloudFront for Blog\\n        <span class=\\\"token key atrule\\\">Enabled</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n        <span class=\\\"token key atrule\\\">DefaultCacheBehavior</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token key atrule\\\">Compress</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n          <span class=\\\"token key atrule\\\">ForwardedValues</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">QueryString</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n          <span class=\\\"token key atrule\\\">TargetOriginId</span><span class=\\\"token punctuation\\\">:</span> blog<span class=\\\"token punctuation\\\">-</span>origin\\n          <span class=\\\"token key atrule\\\">ViewerProtocolPolicy</span><span class=\\\"token punctuation\\\">:</span> redirect<span class=\\\"token punctuation\\\">-</span>to<span class=\\\"token punctuation\\\">-</span>https\\n          <span class=\\\"token key atrule\\\">DefaultTTL</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">3600 </span><span class=\\\"token comment\\\"># I prefer 1 hour so that my new post can be delivered quickly</span>\\n        <span class=\\\"token key atrule\\\">Origins</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">DomainName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Join</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">''</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!Ref</span> S3Bucket\\n                <span class=\\\"token punctuation\\\">-</span>  <span class=\\\"token string\\\">\\\".s3-website-ap-southeast-2.amazonaws.com\\\"</span>\\n            <span class=\\\"token key atrule\\\">CustomOriginConfig</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">HTTPPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">80</span>\\n              <span class=\\\"token key atrule\\\">HTTPSPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">443</span>\\n              <span class=\\\"token key atrule\\\">OriginProtocolPolicy</span><span class=\\\"token punctuation\\\">:</span> http<span class=\\\"token punctuation\\\">-</span>only\\n            <span class=\\\"token key atrule\\\">Id</span><span class=\\\"token punctuation\\\">:</span> blog<span class=\\\"token punctuation\\\">-</span>origin\\n        <span class=\\\"token key atrule\\\">PriceClass</span><span class=\\\"token punctuation\\\">:</span> PriceClass_All\\n        <span class=\\\"token key atrule\\\">ViewerCertificate</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token key atrule\\\">AcmCertificateArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"arn:aws:acm:us-east-1:504224764639:certificate/866de211-1111-1111-1111-db1180e6cddd\\\"</span>\\n          <span class=\\\"token key atrule\\\">SslSupportMethod</span><span class=\\\"token punctuation\\\">:</span> sni<span class=\\\"token punctuation\\\">-</span>only <span class=\\\"token comment\\\"># if you set this to vip, you'll be charged $600/month</span>\\n        <span class=\\\"token key atrule\\\">DefaultRootObject</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"index.html\\\"</span>\\n\\n  <span class=\\\"token key atrule\\\">RecourdSet</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span> <span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::Route53::RecordSet\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"blog.disasterdev.net\\\"</span>\\n      <span class=\\\"token key atrule\\\">Comment</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"A record for Blog\\\"</span>\\n      <span class=\\\"token key atrule\\\">HostedZoneId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"Z3MTVYT123456\\\"</span>\\n      <span class=\\\"token key atrule\\\">AliasTarget</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">DNSName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> CloudFront.DomainName\\n        <span class=\\\"token key atrule\\\">HostedZoneId</span><span class=\\\"token punctuation\\\">:</span> Z2FDTNDATAQYW2 <span class=\\\"token comment\\\"># hardcoded, found it here https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-route53-aliastarget.html</span>\\n      <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> A\\n</code></pre>\\n      </div>\\n<h2>Conclusion</h2>\\n<p>It tooke me a few hours to finally get this site up and running properly, but the journey was quite fun. Leveraging the power of AWS, I could host a static website that is highly available and fast for every location in the world costing me little, and all I need was just a laptop and AWS account - tell me how you beat that!</p>\\n<p>Gatsby is also a brilliant tool that helps you build the website easily with some <a href=\\\"https://www.gatsbyjs.org/docs/prpl-pattern/\\\">best practices</a> embeded.</p>\\n<p>All in all, I had a lot fun building this and I hope you will do too.</p>\",\"frontmatter\":{\"layout\":\"post\",\"title\":\"Build your ultimate blog with React, S3, CloudFront and Route53\",\"path\":\"/build-your-ultimate-blog-with-react-s3-cloudfront-and-route53/\",\"categories\":[\"AWS\",\"S3\",\"CloudFront\",\"Route53\",\"Certificate Manager\",\"CloudFormation\",\"React\"],\"date\":\"2018/01/01\"}}},{\"post\":{\"html\":\"<p>If you gave me face and read <a href=\\\"/build-your-ultimate-blog-with-react-s3-cloudfront-and-route53/\\\">Build your ultimate blog with React, S3, CloudFront and Route53</a>, then you know how <em>badass</em> this website is already. But young man, we’re not done yet, because as a developer, we want to</p>\\n\\n  <span class=\\\"gatsby-resp-image-wrapper\\\" style=\\\"position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 400px; margin-left: auto; margin-right: auto;\\\">\\n    <span class=\\\"gatsby-resp-image-background-image\\\" style=\\\"padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAUCAwT/xAAWAQEBAQAAAAAAAAAAAAAAAAACAwT/2gAMAwEAAhADEAAAAXdJjzpsRKn/xAAbEAABBAMAAAAAAAAAAAAAAAABAhEiMQADIf/aAAgBAQABBQJQfOOKVExRuFf/xAAWEQEBAQAAAAAAAAAAAAAAAAABEBH/2gAIAQMBAT8BDZ//xAAYEQADAQEAAAAAAAAAAAAAAAAAAQIREv/aAAgBAgEBPwHqnTRp/8QAGhAAAgIDAAAAAAAAAAAAAAAAARAAIQIRMf/aAAgBAQAGPwKUXsVker//xAAaEAEBAQEAAwAAAAAAAAAAAAABEQAxIUFR/9oACAEBAAE/IfEbioVfmEBmw9PMVJScd1RQu//aAAwDAQACAAMAAAAQZD//xAAWEQEBAQAAAAAAAAAAAAAAAAABEDH/2gAIAQMBAT8QXBP/xAAZEQACAwEAAAAAAAAAAAAAAAABMQARIUH/2gAIAQIBAT8QAaNZi43AdKf/xAAbEAEBAAMBAQEAAAAAAAAAAAABEQAhMVFBkf/aAAgBAQABPxAFSB0MRiBF01ffzKA2EuHjFgs4+YKaoBJqz7DLoZd3c//Z&apos;); background-size: cover; display: block;\\\">\\n      <img class=\\\"gatsby-resp-image-image\\\" style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\" alt=\\\"Automate everything\\\" title=\\\"\\\" src=\\\"/static/automate-everything-c09d5d1f91e89c001851bae8eeb1fd38-b0ab5.jpg\\\" srcset=\\\"/static/automate-everything-c09d5d1f91e89c001851bae8eeb1fd38-0852f.jpg 188w,\\n/static/automate-everything-c09d5d1f91e89c001851bae8eeb1fd38-ea616.jpg 375w,\\n/static/automate-everything-c09d5d1f91e89c001851bae8eeb1fd38-b0ab5.jpg 400w\\\" sizes=\\\"(max-width: 400px) 100vw, 400px\\\">\\n    </span>\\n  </span>\\n  \\n<p>So in this article I’m gonna talk about how I provisioned CICD pipeline to build and deploy this website.</p>\\n<p>What automation are we talking about? It’s quite straightforward:</p>\\n<ol>\\n<li>I pushed the source files, including all the articles to a Git service, such as GitHub.</li>\\n<li>I built an AWS CodeBuild project which takes in the source files of this website, builds it, and sync the built files to the S3 bucket hosting the website.</li>\\n<li>I built an AWS CodePipeline which automatically pulls the source files from Git and passes them down to CodeBuild project, which does the build and deployment.</li>\\n</ol>\\n<!--more-->\\n<p>And that’s it - simply 3 steps!</p>\\n<h2>Host source files</h2>\\n<p>I chose to host my source in AWS CodeCommit. <em>“Why not GitHub?”</em>, you’re asking. I guess for one, I’m too shy to share my terrible source code to everyone. Also, CodeCommit is seamlessly integrated with AWS CodePipeline, that is one of the main services I use for this CICD. See? They really know how to make you stick to AWS.</p>\\n<p>So I logged in AWS console, went to CodeCommit service page and created a repository called <em>blog</em>. Following the instructions, I also set up my <em>CodeCommit Credentials</em>.</p>\\n<p>With some basic AWS and Git knowledge, I got my source files checked in very quickly.</p>\\n<h2>Build CodeBuild</h2>\\n<p>Instead of provisioning and hosting your own build server, you can set up a CodeBuild project, which can be seen as a <em>serverless</em> (another fancy buzz word eh?) build machine that is provisioned by AWS on the fly when your build starts. This “serverless build machine” will execute build commands in <code>buildspec.yml</code> file, which should be put under the project root folder.</p>\\n<p>For example, this is my <code>buildspec.yml</code> file.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token key atrule\\\">version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">0.1</span>\\n\\n<span class=\\\"token key atrule\\\">phases</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">build</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">commands</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> echo \\\"Starting build `date` in `pwd`\\\"\\n      <span class=\\\"token punctuation\\\">-</span> npm install\\n      <span class=\\\"token punctuation\\\">-</span> npm run aws<span class=\\\"token punctuation\\\">-</span>build\\n  <span class=\\\"token key atrule\\\">post_build</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">commands</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> echo \\\"build completed on `date`\\\"\\n</code></pre>\\n      </div>\\n<p>I did two things in this file:</p>\\n<ol>\\n<li>I run <code>npm install</code> to install all the dependencies.</li>\\n<li>I run <code>npm run aws-build</code> to make a build and sync the built files to S3.</li>\\n</ol>\\n<p>Let me show you the magic of <code>aws-build</code> in <code>package.json</code>:</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-json\\\"><code><span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token property\\\">\\\"scripts\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token property\\\">\\\"sync-s3\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token string\\\">\\\"aws s3 sync public/. s3://my.blog --storage-class REDUCED_REDUNDANCY --delete\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token property\\\">\\\"aws-build\\\"</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token string\\\">\\\"npm run build &amp;&amp; npm run sync-s3\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n</code></pre>\\n      </div>\\n<p>In <code>aws-build</code> I first call <code>npm run build</code> to build the whole website and then I run <code>sync-s3</code> to synchronise all the files under <code>public/</code> directory to S3 bucket <code>my.blog</code>.</p>\\n<p>I didn’t go to CodeBuild service page because smart developers <strong>automate everything</strong>. I’m just going to pretend I’m smart here. Here’s the CloudFormation template to automate the provisioning.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token key atrule\\\">ArtifactBucket</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::S3::Bucket\\\"</span>\\n\\n<span class=\\\"token key atrule\\\">CodeBuildServiceRole</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::IAM::Role\\\"</span>\\n  <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"/\\\"</span>\\n    <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n          <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> codebuild.amazonaws.com\\n          <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n    <span class=\\\"token key atrule\\\">ManagedPolicyArns</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>iam<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>policy/AWSCodeCommitFullAccess\\n    <span class=\\\"token key atrule\\\">Policies</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">PolicyName</span><span class=\\\"token punctuation\\\">:</span> CodeBuildAccess\\n        <span class=\\\"token key atrule\\\">PolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n              <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n              <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span> logs<span class=\\\"token punctuation\\\">:</span>*\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>s3<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>$<span class=\\\"token punctuation\\\">{</span>ArtifactBucket<span class=\\\"token punctuation\\\">}</span>/*\\n              <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n              <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>GetObject\\n                <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>PutObject\\n                <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>GetObjectVersion\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n              <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n              <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span> s3<span class=\\\"token punctuation\\\">:</span>List*\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>s3<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ktei2008.blog/*\\n              <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n              <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>GetObject\\n                <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>PutObject\\n                <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>DeleteObject*\\n\\n<span class=\\\"token key atrule\\\">CodeBuildProject</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::CodeBuild::Project\\\"</span>\\n  <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> BlogBuildAndDeploy\\n    <span class=\\\"token key atrule\\\">Artifacts</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> S3\\n      <span class=\\\"token key atrule\\\">Location</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ArtifactBucket\\n    <span class=\\\"token key atrule\\\">Source</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> CODECOMMIT\\n      <span class=\\\"token key atrule\\\">Location</span><span class=\\\"token punctuation\\\">:</span> https<span class=\\\"token punctuation\\\">:</span>//git<span class=\\\"token punctuation\\\">-</span>codecommit.ap<span class=\\\"token punctuation\\\">-</span>southeast<span class=\\\"token punctuation\\\">-</span>2.amazonaws.com/v1/repos/blog\\n    <span class=\\\"token key atrule\\\">Environment</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">ComputeType</span><span class=\\\"token punctuation\\\">:</span> BUILD_GENERAL1_SMALL\\n      <span class=\\\"token key atrule\\\">Image</span><span class=\\\"token punctuation\\\">:</span> aws/codebuild/nodejs<span class=\\\"token punctuation\\\">:</span>7.0.0\\n      <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> LINUX_CONTAINER\\n    <span class=\\\"token key atrule\\\">ServiceRole</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> CodeBuildServiceRole\\n</code></pre>\\n      </div>\\n<p>A few things to notice here about CodeBuild:</p>\\n<ul>\\n<li>It needs certain permissions to synchronise built files to the blog bucket.</li>\\n<li>I set its <em>Environment->Image</em> to be <code>aws/codebuild/nodejs:7.0.0</code> because Gatsby is a  framework running on Node. There’re <a href=\\\"https://docs.aws.amazon.com/codebuild/latest/userguide/build-env-ref-available.html\\\">many images</a> you can choose from. You can even provision your own image.</li>\\n<li><em>ComputeType</em> is set to <em>BUILD<em>GENERAL1</em>SMALL</em> because I’m a cheapskate. If you think the build is too slow, upgrade this to <em>BUILD<em>GENERAL1</em>LARGE</em> and it’s usually much faster.</li>\\n</ul>\\n<h2>Build CodePipeline</h2>\\n<p>I’ve got all the pieces ready so it’s time to connect the dots. CodePipeline is perfect for this. I can create a CodePipeline and have 2 stages, the first of which is triggered whenever I push changes to CodeCommit repository. The first stage will clone the repository and put it in an artifacts S3 bucket, waiting for the CodeBuild in stage 2 to pick the source up.</p>\\n<p>In stage 2 I use CodeBuild to run <code>gatsby build</code> and synchronise built files to the blog bucket.</p>\\n<p>The final pipeline I created looks like this:</p>\\n\\n  <span class=\\\"gatsby-resp-image-wrapper\\\" style=\\\"position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 750px; margin-left: auto; margin-right: auto;\\\">\\n    <span class=\\\"gatsby-resp-image-background-image\\\" style=\\\"padding-bottom: 73.04116865869854%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAABJklEQVQ4y6WUaUrFMBSFu0cX4H+X4z9BcCm6BRFbau34OrcZOuXxOh3TSB/qL0kDh0AIX8695xLD8zyEYQjf9+G6rpJt23AcR51vsixLab9jmiY8ufO2h59xODHBqWzwmVAYhBAURYG6rpHnudrLsgBvGkzThHVdsSzLv2WEgY/Hlxh3T++4fXjDzf0rni2KaV6hs4xGOhmGAfM8/3ppc6YF5JxDCHGFbOBN2sCkoAgS2UcmVJmb23Ec9YHkzJENNWjP0XXd8ZLLpkUnxmsP91S1gSHPQBkDoxSUMjUqh4A74K+0gXESI01TRFGEqqqPOywqgjjJcJK6XEb0fX8s5Uac0Q6j0rJ8Q46FIoMIeAkmWjU2P9PWAn6QUKYsE5afBJVJH+3hFxlxlHKV/7OaAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\\\">\\n      <img class=\\\"gatsby-resp-image-image\\\" style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\" alt=\\\"Pipeline\\\" title=\\\"\\\" src=\\\"/static/pipeline-c1dec17bb1560e299d481e38573b653e-245fd.png\\\" srcset=\\\"/static/pipeline-c1dec17bb1560e299d481e38573b653e-7aee9.png 188w,\\n/static/pipeline-c1dec17bb1560e299d481e38573b653e-2014b.png 375w,\\n/static/pipeline-c1dec17bb1560e299d481e38573b653e-245fd.png 750w,\\n/static/pipeline-c1dec17bb1560e299d481e38573b653e-a0f71.png 1125w,\\n/static/pipeline-c1dec17bb1560e299d481e38573b653e-9b813.png 1500w,\\n/static/pipeline-c1dec17bb1560e299d481e38573b653e-697c4.png 1506w\\\" sizes=\\\"(max-width: 750px) 100vw, 750px\\\">\\n    </span>\\n  </span>\\n  \\n<p>And this is the CloudFormation template I used to create the pipeline.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token key atrule\\\">CodePipelineServiceRole</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::IAM::Role\\\"</span>\\n  <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"/\\\"</span>\\n    <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n          <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> codepipeline.amazonaws.com\\n          <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n    <span class=\\\"token key atrule\\\">ManagedPolicyArns</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>iam<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>policy/AWSCodeCommitFullAccess\\n    <span class=\\\"token key atrule\\\">Policies</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">PolicyName</span><span class=\\\"token punctuation\\\">:</span> CodePipelineAccess\\n        <span class=\\\"token key atrule\\\">PolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n              <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n              <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> iam<span class=\\\"token punctuation\\\">:</span>PassRole\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> CodeBuildProject.Arn\\n              <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n              <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> codebuild<span class=\\\"token punctuation\\\">:</span>StartBuild\\n                <span class=\\\"token punctuation\\\">-</span> codebuild<span class=\\\"token punctuation\\\">:</span>BatchGetBuilds\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>s3<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>$<span class=\\\"token punctuation\\\">{</span>ArtifactBucket<span class=\\\"token punctuation\\\">}</span>/*\\n              <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n              <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>*\\n\\n<span class=\\\"token key atrule\\\">Pipeline</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::CodePipeline::Pipeline\\\"</span>\\n  <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">RoleArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> CodePipelineServiceRole.Arn\\n    <span class=\\\"token key atrule\\\">ArtifactStore</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> S3\\n      <span class=\\\"token key atrule\\\">Location</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ArtifactBucket\\n    <span class=\\\"token key atrule\\\">Stages</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Source\\n        <span class=\\\"token key atrule\\\">Actions</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Source\\n            <span class=\\\"token key atrule\\\">ActionTypeId</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Category</span><span class=\\\"token punctuation\\\">:</span> Source\\n              <span class=\\\"token key atrule\\\">Owner</span><span class=\\\"token punctuation\\\">:</span> AWS\\n              <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n              <span class=\\\"token key atrule\\\">Provider</span><span class=\\\"token punctuation\\\">:</span> CodeCommit\\n            <span class=\\\"token key atrule\\\">Configuration</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">RepositoryName</span><span class=\\\"token punctuation\\\">:</span> blog\\n              <span class=\\\"token key atrule\\\">BranchName</span><span class=\\\"token punctuation\\\">:</span> master\\n            <span class=\\\"token key atrule\\\">OutputArtifacts</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Source\\n\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> BuildAndDeploy\\n        <span class=\\\"token key atrule\\\">Actions</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> BuildAndDeploy\\n            <span class=\\\"token key atrule\\\">ActionTypeId</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Category</span><span class=\\\"token punctuation\\\">:</span> Build\\n              <span class=\\\"token key atrule\\\">Owner</span><span class=\\\"token punctuation\\\">:</span> AWS\\n              <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n              <span class=\\\"token key atrule\\\">Provider</span><span class=\\\"token punctuation\\\">:</span> CodeBuild\\n            <span class=\\\"token key atrule\\\">Configuration</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">ProjectName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> CodeBuildProject\\n            <span class=\\\"token key atrule\\\">InputArtifacts</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Source\\n</code></pre>\\n      </div>\\n<p>Now I’ve built a simple CICD pipeline for my own website. This frees me up as I don’t need to worry about deployment anymore, while I can focus on wrting more bad or worse articles to <del>mislead</del> help you - disaster dev eh?</p>\\n<h1>Conclusion</h1>\\n<p>With the help of AWS CodeCommit, CodeBuild and CodePipeline, I managed to create a smooth CICD experience for my own website and it costs me little. We all want to be smart devs, and smart devs are usually lazy bastards - because they’ve automated everything for themselves! Don’t you wanna be one of them?</p>\",\"frontmatter\":{\"layout\":\"post\",\"title\":\"Build a simple CICD with AWS CodeCommit, CodeBuild and CodePipeline\",\"path\":\"/build-a-simple-cicd-with-aws-codecommit-codebuild-and-codepipeline/\",\"categories\":[\"AWS\",\"DevOps\",\"CodeCommit\",\"CodeBuild\",\"CodePipeline\",\"CloudFormation\"],\"date\":\"2018/01/02\"}}},{\"post\":{\"html\":\"<p>AWS is an enormous jungle. It has more than 50 services, the number of which keeps increasing every year. For beginners like myself, it’s pretty easy to get lost in this jungle. Thanks to my terrible memory, I think it’s useful for me to write down this blog to showcase how I built a simple AWS infrastructure using CloudFormation, and deployed a container on ECS, just in case I forget one day.</p>\\n<!--more-->\\n<p>First of all, I truly believe that <em>everything that can be automated should be automated</em>, so CloudFormation is going to be my main tool to provision the infrastructure. In fact, it’s one of the two services (another is AWS Lambda) that really got me into AWS.</p>\\n<p>So what I built here is a simple cloud infrastructure in which there’re VPC, subnets, load balancer, ECS clusters so on so forth. This infrastructure allows you to deploy containers on ECS clusters which is secure to some extent, and highly available.</p>\\n<p>In short, here is a poorly drawn diagram to illustrate what I built in a high level. I used <a href=\\\"https://www.draw.io/\\\">draw.io</a> to draw this and it actually costed me some effort so don’t you judge it!</p>\\n\\n  <span class=\\\"gatsby-resp-image-wrapper\\\" style=\\\"position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 722px; margin-left: auto; margin-right: auto;\\\">\\n    <span class=\\\"gatsby-resp-image-background-image\\\" style=\\\"padding-bottom: 100.13850415512466%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAChUlEQVQ4y5VUS2/TQBDOX+VKz0hckDgiIY49gFQQ4nEo5YKqitJSECqCJhUtEkIkUIkkjb21Ha9f63Wc2B87W6/TPCBipNE+PP72m5lvt4EVNh6PcXF6AOtoG6PRaFU4GkXkYvx9H0mSLLjv+2CMIXl6HeLRNT0fDodLY8npwIbz8yuSkx0EZydIW1v6B+OWZemRHW6iv/dwZm/e0zRFFEVoEAtfbUirjezHBxTOL+SHGyjzFFJEapTwTlUGZ8co1DyNOMrxCPnRc0z6p/o7rUM+vGTY6/X0ppQSuVDpsw7C7Tvo97o6gL6dN3fh79+HjAPEgQsRc/hv1hG3PyEMQ107iguCoAJUJxBd+8sDvWnbNvx2E9y1kYkYZVGAWQMEQw+scwCvewTHcXRswH0NShhTwArd8zwdGLsDyGdryI+3EHgXmIQOxEVXsZvWzHVdyPeK9Ysb+t8FhrQwRql2P+9gyM4VKxfZ67uQr24jCbmWkTHn20f83nusD1jK8KqRDMiIodc+Bu804bHBDGChSiGEWM2QjJqkARVDM/ccNgNo4jTgPEPO+WWRK6da0p4I/Row8l1d5/k4kt4CQ127hOmR0jDXjL4ZQJlEmGTKc6GFTPtlWdZxMwyp9fbJRn0qjcSQtGcAE9Vl1nmnZNOayqbyBYbUKSMbYmhsvoaUnomrY5bV0DSlYG3wl7dQji5BuctqQLfqcpnFCJ6sYeL3p4B/63IhY8RbN5G1NvXa6ne1PLTu7AqwmEC8XUe6e281wyzLdEpXdWiMboqRDd0USv+fDOedmpLGYQ2YS7EgGxNXM6RmcFX4cpxVPpod1TNmzDxVZZ4tjPXzRYB5ni9l+D9OYKSOP0B58Dc2a6c9AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\\\">\\n      <img class=\\\"gatsby-resp-image-image\\\" style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\" alt=\\\"Infrastructure\\\" title=\\\"\\\" src=\\\"/static/infrastructure-8f75cbdb4a671c074a696017b5aeb1af-5ba46.png\\\" srcset=\\\"/static/infrastructure-8f75cbdb4a671c074a696017b5aeb1af-584f6.png 188w,\\n/static/infrastructure-8f75cbdb4a671c074a696017b5aeb1af-a48bd.png 375w,\\n/static/infrastructure-8f75cbdb4a671c074a696017b5aeb1af-5ba46.png 722w\\\" sizes=\\\"(max-width: 722px) 100vw, 722px\\\">\\n    </span>\\n  </span>\\n  \\n<h2>Infrastructure</h2>\\n<p>To make my infrastructure highly availalbe, I choose to use 2 available zones - which I’ll call AZ1 and AZ2 just for simplicity. I divide each zone into 3 subnets, although from the diagram you can only see 2.</p>\\n<h3>Public subnet</h3>\\n<p>The Internet facing subnet (my <a href=\\\"https://en.wikipedia.org/wiki/DMZ_(computing)\\\">DMZ</a>), which I call public subnet is where I put things like <em>jumpbox</em> or <em>NAT gateway</em>. Any EC2 instance I deploy in this subnet will automatically have an assigned public IP, which means if I open port 22 through its security groups, I can SSH to the terminal from the Internet. As you can imagine, this is not a good place for your application servers, as this is the front line between the evil world and your happy private paradise, so we need to leave our servers and databases out of this area. However, this is the right place for everything that should be public facing, such as NAT gateway.</p>\\n<h3>Service subnet</h3>\\n<p>This is where I deploy my ECS clusters. The idea is that only load balancer can forward the requests from public subnets to these clusters, so all I need to do is to allow ALB (application load balancer) to hit the clusters. I can achieve this by creating a security group for ALB to listen to Internet requests on port 443, and then attaching a security group on clusters, which grants the inbound access for instances belonging to ALB security group, which is the ALB itself.</p>\\n<p>Another caveat I encountered was that to register EC2 instances to a ECS cluster, those instances need to have public IPs. If you think about it, instances in private subnets don’t have public IPs, so that seems like a conflict now? Not really, because you can put a NAT gateway - well, technically 2 for high availability - in public subnets, and then add a route <em>0.0.0.0/0->NAT</em> for the instances, so outgoing traffic will all go through the NAT gateway, which will translate their private IPs into public IPs, so that ECS agents can work properly.</p>\\n<h3>Application load balancer</h3>\\n<p>There’s not much to say about this but do understand one thing, that the traffic between the ALB and the ECS clusters may or may not be secure, which is totally up to how you implement your services. You can force the HTTP encryption between ALB and ECS, but that requires your web server - kestrel (.NET Core) for example - to be able to decrypt the traffic, given the SSL/TLS certificate. However, if your application server cannot decrypt it, then you can’t encrypt the traffic, otherwise nothing works.</p>\\n<h3>Data subnet</h3>\\n<p>This is something I left for future. At the moment I’m not planning to run any RDS (they’re indeed way more expensive than small EC2 instances). But as the name suggests, this is where you put data servers. ALB should not have access to this area. In fact, this subnet should be mostly protected as it’s the place for your data, which has not public facing responsibility. If somehow this area is compromised, you’ll be in trouble.</p>\\n<h3>Spot instance</h3>\\n<p>I chose to run spot instances for ECS clusters, as they’re way cheaper than on-demand instances. Beause I’m not running any commercial website, I can just put a very low bid price there hoping that the price will always be slightly higher than spot instance price, which will keep all my instances running. In fact, I use spot instances in my company for test environment and the website went down ever since. It makes a lot sense to do this especially when you run small business or startup, in which you want to save every cent of your money but also enjoy the power that AWS brings to you, so spot instance is a fine choice fro you.</p>\\n<h2>CloudFormation</h2>\\n<p>So far you should understand the infrastructure from a high level. Now it’s time to build it. With CloudFormation, I can deploy the whole infrastructure without endless cliking in AWS console, so here’re the templates I used to provision my infrastructure. You can read them and reuse them or roll your own, so let’s have a look.</p>\\n<p>With the CloudFormation templates below, I built the infrastructure depicted in the diagram. If you want to reuse them, make sure you run them in such correct sequence and use the stack name I provided here:</p>\\n<ul>\\n<li>infra-vpc</li>\\n<li>infra-sgs</li>\\n<li>infra-alb</li>\\n<li>infra-ecs-cluster</li>\\n</ul>\\n<h3>VPC - (infra-vpc)</h3>\\n<p>This template built VPC where 6 subnets (public subnets, service subnets and data subnets) exist. I added a parameter <code>EnableNat</code> which controls whether or not I build NAT gateways as I don’t want to run NAT gateways for personal AWS account - it costs money!</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2010-09-09</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> VPC and subnets\\n\\n<span class=\\\"token key atrule\\\">Parameters</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">VpcCidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for VPC\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.61.0/22\\n\\n  <span class=\\\"token key atrule\\\">EnableNat</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Whether to create NAT gateways for private subnets\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">false</span>\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for public subnet 1\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.61.0/26\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for public subnet 2\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.61.64/26\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for service (private) subnet 1\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.62.0/26\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for service (private) subnet 2\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.62.64/26\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for data (private) subnet 1\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.63.0/26\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for data (private) subnet 2\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.63.64/26\\n\\n<span class=\\\"token key atrule\\\">Conditions</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">EnableNat</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Equals</span> <span class=\\\"token punctuation\\\">[</span> <span class=\\\"token tag\\\">!Ref</span> EnableNat<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"true\\\"</span> <span class=\\\"token punctuation\\\">]</span>\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Vpc</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VPC\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> VpcCidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Vpc\\n\\n  <span class=\\\"token key atrule\\\">InternetGateway</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>InternetGateway\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>InternetGateway\\n\\n  <span class=\\\"token key atrule\\\">InternetGatewayVpcAttachment</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VPCGatewayAttachment\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">InternetGatewayId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> InternetGateway\\n\\n  <span class=\\\"token key atrule\\\">NatGatewayAz1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>NatGateway\\n    <span class=\\\"token key atrule\\\">Condition</span><span class=\\\"token punctuation\\\">:</span> EnableNat\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span> InternetGatewayVpcAttachment\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AllocationId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> NatEipAz1.AllocationId\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1\\n\\n  <span class=\\\"token key atrule\\\">NatEipAz1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EIP\\n    <span class=\\\"token key atrule\\\">Condition</span><span class=\\\"token punctuation\\\">:</span> EnableNat\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span> InternetGatewayVpcAttachment\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Domain</span><span class=\\\"token punctuation\\\">:</span> vpc\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">0</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1Cidr\\n      <span class=\\\"token key atrule\\\">MapPublicIpOnLaunch</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">1</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet2Cidr\\n      <span class=\\\"token key atrule\\\">MapPublicIpOnLaunch</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnetsRouteTable</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>RouteTable\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnetsRouteTable\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet1Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet2\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnetsInternetGatewayRoute</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Route\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span> InternetGatewayVpcAttachment\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">DestinationCidrBlock</span><span class=\\\"token punctuation\\\">:</span> 0.0.0.0/0\\n      <span class=\\\"token key atrule\\\">GatewayId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> InternetGateway    \\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">0</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet1Cidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet1\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">1</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet2Cidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet2\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnetsRouteTable</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>RouteTable\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnetsRouteTable\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet1\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet2\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnetsNatGatewayAz1Route</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Route\\n    <span class=\\\"token key atrule\\\">Condition</span><span class=\\\"token punctuation\\\">:</span> EnableNat\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">DestinationCidrBlock</span><span class=\\\"token punctuation\\\">:</span> 0.0.0.0/0\\n      <span class=\\\"token key atrule\\\">NatGatewayId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> NatGatewayAz1\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">0</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet1Cidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet1\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">1</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet2Cidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet2\\n\\n  <span class=\\\"token key atrule\\\">DataSubnetsRouteTable</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>RouteTable\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnetsRouteTable\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet1\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet2\\n\\n  <span class=\\\"token key atrule\\\">DataSubnetsNatGatewayAz1Route</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Route\\n    <span class=\\\"token key atrule\\\">Condition</span><span class=\\\"token punctuation\\\">:</span> EnableNat\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">DestinationCidrBlock</span><span class=\\\"token punctuation\\\">:</span> 0.0.0.0/0\\n      <span class=\\\"token key atrule\\\">NatGatewayId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> NatGatewayAz1\\n\\n<span class=\\\"token key atrule\\\">Outputs</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> VPC ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n\\n  <span class=\\\"token key atrule\\\">VpcCidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> VPC CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> VpcCidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcCidr\\n  \\n  <span class=\\\"token key atrule\\\">PublicSubnet1Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Public subnet 1 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1Id\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Public subnet 1 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1Cidr\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Public subnet 2 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet2\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2Id\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Public subnet 2 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet2Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2Cidr\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Service subnet 1 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet1\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet1Id\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Service subnet 1 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet1Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet1Cidr\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Service subnet 2 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet2\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet2Id\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Service subnet 2 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet2Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet2Cidr\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Data subnet 1 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet1\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet1Id\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Data subnet 1 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet1Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet1Cidr\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Data subnet 2 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet2\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet2Id\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Data subnet 2 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet2Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet2Cidr\\n</code></pre>\\n      </div>\\n<h3>Shared security groups - (infra-sgs)</h3>\\n<p>I usually define some shared security groups for other resources to share.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2010-09-09</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Shared security groups\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">DefaultIngressSg</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SecurityGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">GroupDescription</span><span class=\\\"token punctuation\\\">:</span> SSH access across the VPC\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n      <span class=\\\"token key atrule\\\">SecurityGroupIngress</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> icmp\\n          <span class=\\\"token key atrule\\\">FromPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">8</span>\\n          <span class=\\\"token key atrule\\\">ToPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">8</span>\\n          <span class=\\\"token key atrule\\\">CidrIp</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcCidr\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> tcp\\n          <span class=\\\"token key atrule\\\">FromPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">22</span>\\n          <span class=\\\"token key atrule\\\">ToPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">22</span>\\n          <span class=\\\"token key atrule\\\">CidrIp</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcCidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DefaultIngressSg\\n\\n<span class=\\\"token key atrule\\\">Outputs</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">DefaultIngressSgId</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Default ingress security group id\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DefaultIngressSg\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DefaultIngressSgId\\n</code></pre>\\n      </div>\\n<h3>ALB - (infra-alb)</h3>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2010-09-09</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Application load balancer\\n\\n<span class=\\\"token key atrule\\\">Parameters</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">CertificateArn</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The ARN of the SSL/TLS certificate for ALB port 443 listener\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>acm<span class=\\\"token punctuation\\\">:</span>ap<span class=\\\"token punctuation\\\">-</span>southeast<span class=\\\"token punctuation\\\">-</span>2<span class=\\\"token punctuation\\\">:</span>504224764639<span class=\\\"token punctuation\\\">:</span>certificate/ce5a2456<span class=\\\"token punctuation\\\">-</span>f97b<span class=\\\"token punctuation\\\">-</span>49ed<span class=\\\"token punctuation\\\">-</span>91fd<span class=\\\"token punctuation\\\">-</span>323b0e290fb8\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">LoadBalancer</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ElasticLoadBalancingV2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancer\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Subnets</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1Id\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2Id\\n      <span class=\\\"token key atrule\\\">SecurityGroups</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!Ref</span> LoadBalancerSg\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancer\\n\\n  <span class=\\\"token key atrule\\\">LoadBalancerSg</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SecurityGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">GroupDescription</span><span class=\\\"token punctuation\\\">:</span> Public access to ALB\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n      <span class=\\\"token key atrule\\\">SecurityGroupIngress</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">CidrIp</span><span class=\\\"token punctuation\\\">:</span> 0.0.0.0/0\\n          <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> tcp\\n          <span class=\\\"token key atrule\\\">FromPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">443</span>\\n          <span class=\\\"token key atrule\\\">ToPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">443</span>\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerSg\\n  \\n  <span class=\\\"token comment\\\"># We're not going to use the default group but we need this to create ALB</span>\\n  <span class=\\\"token key atrule\\\">DefaultTargetGroup</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ElasticLoadBalancingV2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>TargetGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Port</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">80</span>\\n      <span class=\\\"token key atrule\\\">Protocol</span><span class=\\\"token punctuation\\\">:</span> HTTP\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DefaultTargetGroup\\n\\n  <span class=\\\"token key atrule\\\">LoadBalancerListener</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ElasticLoadBalancingV2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Listener\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">LoadBalancerArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> LoadBalancer\\n      <span class=\\\"token key atrule\\\">Port</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">443</span>\\n      <span class=\\\"token key atrule\\\">Protocol</span><span class=\\\"token punctuation\\\">:</span> HTTPS\\n      <span class=\\\"token key atrule\\\">Certificates</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">CertificateArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> CertificateArn\\n      <span class=\\\"token key atrule\\\">DefaultActions</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">TargetGroupArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DefaultTargetGroup\\n          <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> forward\\n\\n<span class=\\\"token key atrule\\\">Outputs</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">LoadBalancerListenerArn</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> LoadBalancerListener\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerListenerArn\\n\\n  <span class=\\\"token key atrule\\\">LoadBalancerSgId</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> LoadBalancerSg\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerSgId\\n</code></pre>\\n      </div>\\n<h3>ECS cluster (infra-ecs-cluster)</h3>\\n<p>Here’s the how I provisioned an ECS cluster based on a spot fleet request. Notice that here I put EC2 instances in public subnets, which is not best practice in terms of security, but it saves me money as otherwise I need to put NAT gateways in public subnets so that my EC2 instances in private subnets can have public IPs for ECS agents to talk to ECS service.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2010-09-09</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> ECS cluster of spot fleet\\n\\n<span class=\\\"token key atrule\\\">Parameters</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">ClusterName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Name of the ECS cluster\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> ApplicationCluster\\n\\n  <span class=\\\"token key atrule\\\">TargetCapacity</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> Number\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> How many EC2 instances do we want\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1 </span><span class=\\\"token comment\\\"># HA needs at least 2</span>\\n\\n  <span class=\\\"token key atrule\\\">InstanceType</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedValues</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> t2.micro\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> EC2 instance type to use for ECS cluster\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> t2.micro\\n\\n  <span class=\\\"token key atrule\\\">KeyName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>KeyPair<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>KeyName\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Name of an existing EC2 KeyPair to enable SSH access to the EC2 instances\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> default<span class=\\\"token punctuation\\\">-</span>keypair\\n\\n  <span class=\\\"token key atrule\\\">SpotBidPrice</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Maximum price that you are willing to pay per hour per instance\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">0.0035</span>\\n\\n<span class=\\\"token key atrule\\\">Mappings</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">AWSRegionToECSAMI</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">ap-northeast-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>af46dbc9\\n    <span class=\\\"token key atrule\\\">ap-southeast-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>fec3b482\\n    <span class=\\\"token key atrule\\\">ap-southeast-2</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>b88e7cda\\n    <span class=\\\"token key atrule\\\">ca-central-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>e8cb4e8c\\n    <span class=\\\"token key atrule\\\">eu-central-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>b378e8dc\\n    <span class=\\\"token key atrule\\\">eu-west-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>7827b301\\n    <span class=\\\"token key atrule\\\">eu-west-2</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>acd5cdc8\\n    <span class=\\\"token key atrule\\\">us-east-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span><span class=\\\"token number\\\">13401669</span>\\n    <span class=\\\"token key atrule\\\">us-east-2</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>901338f5\\n    <span class=\\\"token key atrule\\\">us-west-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>b3adacd3\\n    <span class=\\\"token key atrule\\\">us-west-2</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>9a02a9e2\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">EcsCluster</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ECS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Cluster\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">ClusterName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ClusterName\\n\\n  <span class=\\\"token key atrule\\\">EcsHostSg</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SecurityGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n      <span class=\\\"token key atrule\\\">GroupDescription</span><span class=\\\"token punctuation\\\">:</span> Access to the ECS hosts and the tasks/containers that run on them\\n      <span class=\\\"token key atrule\\\">SecurityGroupIngress</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token comment\\\"># allow free access for ALB</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"-1\\\"</span>\\n          <span class=\\\"token key atrule\\\">SourceSecurityGroupId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>alb<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerSgId\\n        <span class=\\\"token comment\\\"># SSH for jumpbox</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> tcp\\n          <span class=\\\"token key atrule\\\">FromPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">22</span>\\n          <span class=\\\"token key atrule\\\">ToPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">22</span>\\n          <span class=\\\"token key atrule\\\">CidrIp</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcCidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EcsHostSg\\n\\n  <span class=\\\"token key atrule\\\">SpotFleet</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SpotFleet\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> SpotFleetRole\\n      <span class=\\\"token punctuation\\\">-</span> SpotFleetInstanceProfile\\n      <span class=\\\"token punctuation\\\">-</span> EcsHostSg\\n      <span class=\\\"token punctuation\\\">-</span> EcsCluster\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">SpotFleetRequestConfigData</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">AllocationStrategy</span><span class=\\\"token punctuation\\\">:</span> lowestPrice\\n        <span class=\\\"token key atrule\\\">IamFleetRole</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> SpotFleetRole.Arn\\n        <span class=\\\"token key atrule\\\">LaunchSpecifications</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IamInstanceProfile</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Arn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> SpotFleetInstanceProfile.Arn\\n            <span class=\\\"token key atrule\\\">ImageId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!FindInMap</span> <span class=\\\"token punctuation\\\">[</span>AWSRegionToECSAMI<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">\\\"AWS::Region\\\"</span><span class=\\\"token punctuation\\\">,</span> AMI<span class=\\\"token punctuation\\\">]</span>\\n            <span class=\\\"token key atrule\\\">InstanceType</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> InstanceType\\n            <span class=\\\"token key atrule\\\">KeyName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> KeyName\\n            <span class=\\\"token key atrule\\\">Monitoring</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Enabled</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n            <span class=\\\"token key atrule\\\">SecurityGroups</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">GroupId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> EcsHostSg\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">GroupId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>sgs<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DefaultIngressSgId\\n\\n            <span class=\\\"token comment\\\"># EC2 instances need to have public IPs to register ECS:</span>\\n            <span class=\\\"token comment\\\"># https://stackoverflow.com/questions/31036600/why-cant-my-ecs-service-register-available-ec2-instances-with-my-elb</span>\\n            <span class=\\\"token comment\\\"># I can either use public subnets, which is not best security practice, but it saves</span>\\n            <span class=\\\"token comment\\\"># me money from running NAT gateways.</span>\\n            <span class=\\\"token comment\\\"># Or, I can use service subnets, which is better practice, but I need to run NAT gateways.</span>\\n            <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Join</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">','</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1Id\\n                <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2Id\\n\\n            <span class=\\\"token key atrule\\\">UserData</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">\\\"Fn::Base64\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> <span class=\\\"token punctuation\\\">|</span><span class=\\\"token scalar string\\\">\\n                #!/bin/bash\\n                yum install -y aws-cfn-bootstrap\\n                echo ECS_CLUSTER=${EcsCluster} >> /etc/ecs/ecs.config</span>\\n        <span class=\\\"token key atrule\\\">SpotPrice</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> SpotBidPrice\\n        <span class=\\\"token key atrule\\\">TargetCapacity</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> TargetCapacity\\n        <span class=\\\"token key atrule\\\">TerminateInstancesWithExpiration</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n\\n  <span class=\\\"token key atrule\\\">SpotFleetInstanceProfile</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>IAM<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>InstanceProfile\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> SpotFleetInstanceRole\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> /\\n      <span class=\\\"token key atrule\\\">Roles</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Ref</span><span class=\\\"token punctuation\\\">:</span> SpotFleetInstanceRole\\n\\n  <span class=\\\"token key atrule\\\">SpotFleetInstanceRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>IAM<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Role\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2012-10-17</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> ec2.amazonaws.com\\n      <span class=\\\"token key atrule\\\">ManagedPolicyArns</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>iam<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>policy/service<span class=\\\"token punctuation\\\">-</span>role/AmazonEC2ContainerServiceforEC2Role\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> /\\n\\n  <span class=\\\"token key atrule\\\">SpotFleetRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>IAM<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Role\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2012-10-17</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> spotfleet.amazonaws.com\\n      <span class=\\\"token key atrule\\\">ManagedPolicyArns</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>iam<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>policy/service<span class=\\\"token punctuation\\\">-</span>role/AmazonEC2SpotFleetRole\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> /\\n\\n<span class=\\\"token key atrule\\\">Outputs</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">EcsClusterName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ClusterName\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EcsClusterName\\n</code></pre>\\n      </div>\\n<h2>Conclusion</h2>\\n<p>This is not the final conclusion yet, but so far you can basically understand what I built and why I built in such way. Also, by reading these boring CloudFormation templates (to prove that your life is probably as boring as mine), you’ll have an even better understanding about AWS infrastructure and its automation. Anyway, this is part 1 and now let’s take a break and to be continued…</p>\",\"frontmatter\":{\"layout\":\"post\",\"title\":\"Build your AWS infrastructure - Part 1\",\"path\":\"/build-your-aws-infrastructure-part-1/\",\"categories\":[\"AWS\",\"DevOps\",\"CloudFormation\",\"VPC\",\"ECS\",\"SpotInstance\"],\"date\":\"2018/01/08\"}}},{\"post\":{\"html\":\"<p>Hey fellas, you’re reading part 2 of <a href=\\\"/build-your-aws-infrastructure-part-1/\\\">Build your AWS infrastructure</a>. In part 1, I showed you how I built the basic infrastrucutre from VPC to load balancer and then to ECS cluster. Since we’ve got the foundation by now, let’s start building applications!</p>\\n<!--more-->\\n<h2>Overview</h2>\\n<p>Here’s an overview of what I did: I built a simple .NET core application, deployed it as a container on ECS and added a Route53 record set pointing to my application load balancer which points to my ECS cluster. Here’s an example: when users type <code>www.disasterdev.net</code> in their browser,the request is forwarded to my load balancer first, and then, based on the path of the request, the ALB (application load balancer) knows how to route the request to the corresponding container. Let’s see how I did all these in details.</p>\\n<h2>Build .NET core application</h2>\\n<p>You probably have heard of <a href=\\\"https://www.microsoft.com/net/learn/get-started/macos\\\">.NET core</a> already. Prior to its brith, we could only deploy .NET applications on windows servers (yeah yeah… I there’s Mono). Most importantly, it was very difficult to run .NET applications as containers - now that really sucks. Microsoft knew how important container technology would be, so it rewrote .NET framework from scratch, which is aimed to be cross-platform. Now with .NET core, I can deploy it as containers on Linux, which is huge benefit as now I can easily deploy a .NET core application on AWS cloud!</p>\\n<p>If you’re a .NET developer, do yourself a favor and start learning .NET core today - I believe it’ll gradually replace traditional .NET applications, and most importantly, you don’t have to worry cross-plat form issue anymore.</p>\\n<p>I assume you have installed .NET core SDK and runtime. Open terminal, and type</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-none\\\"><code>mkdir SampleNetCoreAWS\\ncd SampleNetCoreAWS\\ndotnet new web\\ndotnet restore\\ndotnet run</code></pre>\\n      </div>\\n<p>Bang! There’s your first .NET core application running on <code>http://localhost:5000</code> already. Before deploying it to AWS, I did a few changes:</p>\\n<p>In <code>Program.cs</code>:</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-csharp\\\"><code><span class=\\\"token keyword\\\">public</span> <span class=\\\"token keyword\\\">static</span> IWebHost <span class=\\\"token function\\\">BuildWebHost</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">string</span><span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">]</span> args<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=</span><span class=\\\"token operator\\\">></span>\\n    WebHost<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">CreateDefaultBuilder</span><span class=\\\"token punctuation\\\">(</span>args<span class=\\\"token punctuation\\\">)</span>\\n        <span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">UseKestrel</span><span class=\\\"token punctuation\\\">(</span>options <span class=\\\"token operator\\\">=</span><span class=\\\"token operator\\\">></span>\\n        <span class=\\\"token punctuation\\\">{</span>\\n            <span class=\\\"token comment\\\">// kestrel listens to port 5000 of any IPs</span>\\n            options<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">Listen</span><span class=\\\"token punctuation\\\">(</span>IPAddress<span class=\\\"token punctuation\\\">.</span>Any<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token keyword\\\">int</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">Parse</span><span class=\\\"token punctuation\\\">(</span>Environment<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">GetEnvironmentVariable</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"PORT\\\"</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">?</span><span class=\\\"token operator\\\">?</span> <span class=\\\"token string\\\">\\\"5000\\\"</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span>\\n        <span class=\\\"token punctuation\\\">.</span><span class=\\\"token generic-method function\\\">UseStartup<span class=\\\"token punctuation\\\">&lt;</span>Startup<span class=\\\"token punctuation\\\">></span></span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span>\\n        <span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">Build</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n</code></pre>\\n      </div>\\n<p>In <code>Startup.cs</code>:</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-csharp\\\"><code><span class=\\\"token keyword\\\">public</span> <span class=\\\"token keyword\\\">void</span> <span class=\\\"token function\\\">Configure</span><span class=\\\"token punctuation\\\">(</span>IApplicationBuilder app<span class=\\\"token punctuation\\\">,</span> IHostingEnvironment env<span class=\\\"token punctuation\\\">)</span>\\n<span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>env<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">IsDevelopment</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span>\\n    <span class=\\\"token punctuation\\\">{</span>\\n        app<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">UseDeveloperExceptionPage</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span>\\n\\n    app<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">Map</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"/app/healthcheck\\\"</span><span class=\\\"token punctuation\\\">,</span> HandleHealthCheck<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n    app<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">Map</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"/app\\\"</span><span class=\\\"token punctuation\\\">,</span> HandleApp<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n\\n<span class=\\\"token keyword\\\">private</span> <span class=\\\"token keyword\\\">static</span> <span class=\\\"token keyword\\\">void</span> <span class=\\\"token function\\\">HandleApp</span><span class=\\\"token punctuation\\\">(</span>IApplicationBuilder app<span class=\\\"token punctuation\\\">)</span>\\n<span class=\\\"token punctuation\\\">{</span>\\n    app<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">Run</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">async</span> context <span class=\\\"token operator\\\">=</span><span class=\\\"token operator\\\">></span>\\n    <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">await</span> context<span class=\\\"token punctuation\\\">.</span>Response<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">WriteAsync</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"Hello world!\\\"</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n\\n<span class=\\\"token keyword\\\">private</span> <span class=\\\"token keyword\\\">static</span> <span class=\\\"token keyword\\\">void</span> <span class=\\\"token function\\\">HandleHealthCheck</span><span class=\\\"token punctuation\\\">(</span>IApplicationBuilder app<span class=\\\"token punctuation\\\">)</span>\\n<span class=\\\"token punctuation\\\">{</span>\\n    app<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">Run</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">async</span> context <span class=\\\"token operator\\\">=</span><span class=\\\"token operator\\\">></span>\\n    <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">await</span> context<span class=\\\"token punctuation\\\">.</span>Response<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">WriteAsync</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"I'm running\\\"</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n</code></pre>\\n      </div>\\n<p>Notice that this code was written in the way to fit my scenario only. You can write your own application however you like, but do remember to configure <em>kestrel</em> to listen to <code>IPAddress.Any</code> on port 5000, otherwise you application won’t work, because ECS will have no way to send send traffic to your containers.</p>\\n<p>Don’t forget to add a Dockerfile to build your image:</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-docker\\\"><code><span class=\\\"token keyword\\\">FROM</span> microsoft/dotnet<span class=\\\"token punctuation\\\">:</span>2.0.4<span class=\\\"token punctuation\\\">-</span>sdk<span class=\\\"token punctuation\\\">-</span>2.1.3 as builder\\n\\n<span class=\\\"token keyword\\\">COPY</span> . /app\\n<span class=\\\"token keyword\\\">WORKDIR</span> /app\\n<span class=\\\"token keyword\\\">RUN</span> <span class=\\\"token punctuation\\\">[</span><span class=\\\"token string\\\">\\\"dotnet\\\"</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"restore\\\"</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"--no-cache\\\"</span><span class=\\\"token punctuation\\\">]</span>\\n<span class=\\\"token keyword\\\">RUN</span> dotnet publish <span class=\\\"token punctuation\\\">-</span>c Release <span class=\\\"token punctuation\\\">-</span>r linux<span class=\\\"token punctuation\\\">-</span>x64\\n\\n<span class=\\\"token keyword\\\">FROM</span> microsoft/dotnet<span class=\\\"token punctuation\\\">:</span>2.0.4<span class=\\\"token punctuation\\\">-</span>runtime\\n<span class=\\\"token keyword\\\">WORKDIR</span> /app\\n<span class=\\\"token keyword\\\">COPY</span> <span class=\\\"token punctuation\\\">-</span><span class=\\\"token punctuation\\\">-</span>from=builder /app/bin/Release/netcoreapp2.0/linux<span class=\\\"token punctuation\\\">-</span>64/publish .\\n<span class=\\\"token keyword\\\">EXPOSE</span> 5000\\n<span class=\\\"token keyword\\\">ENTRYPOINT</span> <span class=\\\"token punctuation\\\">[</span><span class=\\\"token string\\\">\\\"dotnet\\\"</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"SampleNetCoreAWS.dll\\\"</span><span class=\\\"token punctuation\\\">]</span>\\n</code></pre>\\n      </div>\\n<p>We also need a buildspec.yml, that is for AWS CodeBuild, which we’ll see later.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token key atrule\\\">version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">0.1</span>\\n\\n<span class=\\\"token key atrule\\\">phases</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">pre_build</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">commands</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> echo <span class=\\\"token punctuation\\\">-</span>n \\\"$CODEBUILD_BUILD_ID\\\" <span class=\\\"token punctuation\\\">|</span> sed \\\"s/.*<span class=\\\"token punctuation\\\">:</span>\\\\(<span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">:</span>xdigit<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">]</span>\\\\<span class=\\\"token punctuation\\\">{</span>7\\\\<span class=\\\"token punctuation\\\">}</span>\\\\).*/\\\\1/\\\" <span class=\\\"token punctuation\\\">></span> /tmp/build_id.out\\n      <span class=\\\"token punctuation\\\">-</span> printf '<span class=\\\"token punctuation\\\">{</span>\\\"tag\\\"<span class=\\\"token punctuation\\\">:</span><span class=\\\"token string\\\">\\\"%s\\\"</span><span class=\\\"token punctuation\\\">}</span>' \\\"$(cat /tmp/build_id.out)\\\" <span class=\\\"token punctuation\\\">></span> build.json\\n      <span class=\\\"token punctuation\\\">-</span> echo Logging in to Amazon ECR\\n      <span class=\\\"token punctuation\\\">-</span> $(aws ecr get<span class=\\\"token punctuation\\\">-</span>login <span class=\\\"token punctuation\\\">-</span><span class=\\\"token punctuation\\\">-</span>region $AWS_DEFAULT_REGION <span class=\\\"token punctuation\\\">-</span><span class=\\\"token punctuation\\\">-</span>no<span class=\\\"token punctuation\\\">-</span>include<span class=\\\"token punctuation\\\">-</span>email)\\n  <span class=\\\"token key atrule\\\">build</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">commands</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> echo Build started on `date` for $ASPNETCORE_ENVIRONMENT\\n      <span class=\\\"token punctuation\\\">-</span> docker build <span class=\\\"token punctuation\\\">-</span><span class=\\\"token punctuation\\\">-</span>tag \\\"$REPOSITORY_URI<span class=\\\"token punctuation\\\">:</span>$(cat /tmp/build_id.out)\\\" .\\n  <span class=\\\"token key atrule\\\">post_build</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">commands</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> echo Build completed on `date`\\n      <span class=\\\"token punctuation\\\">-</span> echo Pushing the Docker image<span class=\\\"token punctuation\\\">...</span>\\n      <span class=\\\"token punctuation\\\">-</span> docker push \\\"$REPOSITORY_URI<span class=\\\"token punctuation\\\">:</span>$(cat /tmp/build_id.out)\\\"\\n<span class=\\\"token key atrule\\\">artifacts</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">files</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token punctuation\\\">-</span> build.json\\n    <span class=\\\"token punctuation\\\">-</span> cfn/**/*\\n</code></pre>\\n      </div>\\n<h2>Deployment</h2>\\n<p>To run a container on ECS, we need to define an ECS service, for which we need to define a task definition. A task definition is like a recipe for <em>cooking</em> a container. It tells ECS how to spin up a container, including what Docker image it should use, how much memory it can allocate to the service, what container port it should deploy to, so on so forth. Once the task defined, ECS will maintain desired number of containers running for the task.</p>\\n<p>In <em>SampleNetCoreAWS</em> project, I added the <code>cfn/deploy.yml</code>, which contains the task definition as below. By executing this CloudFormation file, an applicatin stack <code>app-sample-netcore</code> will be created or updated if it exists. The idea is that each deployment produces a brand new version of task definition in the form of CloudFormation. We (technically not we, but the build machine) then applies this new task definition to the ECS service. ECS service detects that its task definition has been updated, so it starts to re-run containers based on the lastet task definition including pulling the new container image, spinning up desired number of containers etc. In short, <code>deploy.yml</code> tells AWS how to deploy our sample .NET core application. Here’s the <code>deploy.yml</code>.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'2010-09-09'</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> ECS Service <span class=\\\"token punctuation\\\">-</span> sample<span class=\\\"token punctuation\\\">-</span>netcore\\n\\n<span class=\\\"token key atrule\\\">Parameters</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">ApplicationName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The name of the application we're trying to deploy<span class=\\\"token punctuation\\\">,</span> which will be\\n      used for service name and container name etc.\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> sample<span class=\\\"token punctuation\\\">-</span>netcore\\n\\n  <span class=\\\"token key atrule\\\">EnvironmentName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The runtime environment name for this application<span class=\\\"token punctuation\\\">,</span> e.g. ASPNETCORE_ENVIRONMENT\\n      for Dotnet Core<span class=\\\"token punctuation\\\">,</span> NODE_ENV for Node\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> Development\\n\\n  <span class=\\\"token key atrule\\\">BaseImageName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The docker image name\\n\\n  <span class=\\\"token key atrule\\\">EnableHttps</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Set this to true if you want to encrpyted traffic between ALB and ECS\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">false</span>\\n\\n  <span class=\\\"token key atrule\\\">ClusterName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The name of the ECS cluster where this service is about to be deployed\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> ApplicationCluster\\n\\n  <span class=\\\"token key atrule\\\">DesiredCount</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> Number\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> How many instance of this task should we run across our cluster<span class=\\\"token punctuation\\\">?</span>\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n\\n  <span class=\\\"token key atrule\\\">Priority</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Priority to evaluate Path rules\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> Number\\n    <span class=\\\"token key atrule\\\">MaxValue</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">50000</span>\\n    <span class=\\\"token key atrule\\\">MinValue</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n\\n  <span class=\\\"token key atrule\\\">ImageTag</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The docker image tag\\n\\n  <span class=\\\"token key atrule\\\">HealthCheckPath</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Every container must provide a health url for the load balancer to\\n      test with\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> /app/healthcheck\\n\\n  <span class=\\\"token key atrule\\\">DeregistrationDelay</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> Number\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The duration (in seconds) ECS waits for before degistrating a container\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">5</span>\\n\\n  <span class=\\\"token key atrule\\\">Memory</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> Number\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> 'Soft memory limit of this task<span class=\\\"token punctuation\\\">:</span> the service cannot use memory above\\n      this number'\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">256</span>\\n\\n  <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The path to register with the ALB\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> /app*\\n\\n  <span class=\\\"token key atrule\\\">ContainerPort</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> Number\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The port the load balancer will map traffic to on the container;\\n      this application should listen to this port as well\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">5000</span>\\n\\n<span class=\\\"token key atrule\\\">Conditions</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">httpsEnabled</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Equals</span>\\n    <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'EnableHttps'</span>\\n    <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token boolean important\\\">true</span>\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ECS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Service\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">LoadBalancers</span><span class=\\\"token punctuation\\\">:</span> \\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">ContainerName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'ApplicationName'</span>\\n            <span class=\\\"token key atrule\\\">TargetGroupArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'TargetGroup'</span>\\n            <span class=\\\"token key atrule\\\">ContainerPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'ContainerPort'</span>\\n      <span class=\\\"token key atrule\\\">Cluster</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'ClusterName'</span>\\n      <span class=\\\"token key atrule\\\">Role</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'ServiceRole'</span>\\n      <span class=\\\"token key atrule\\\">TaskDefinition</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'TaskDefinition'</span>\\n      <span class=\\\"token key atrule\\\">DesiredCount</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'DesiredCount'</span>\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span> ListenerRule\\n\\n  <span class=\\\"token key atrule\\\">ServiceRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>IAM<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Role\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> /\\n      <span class=\\\"token key atrule\\\">Policies</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">PolicyName</span><span class=\\\"token punctuation\\\">:</span> ECSService\\n          <span class=\\\"token key atrule\\\">PolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'2012-10-17'</span>\\n            <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n                  <span class=\\\"token punctuation\\\">-</span> ec2<span class=\\\"token punctuation\\\">:</span>AuthorizeSecurityGroupIngress\\n                  <span class=\\\"token punctuation\\\">-</span> ec2<span class=\\\"token punctuation\\\">:</span>Describe*\\n                  <span class=\\\"token punctuation\\\">-</span> elasticloadbalancing<span class=\\\"token punctuation\\\">:</span>DeregisterInstancesFromLoadBalancer\\n                  <span class=\\\"token punctuation\\\">-</span> elasticloadbalancing<span class=\\\"token punctuation\\\">:</span>Describe*\\n                  <span class=\\\"token punctuation\\\">-</span> elasticloadbalancing<span class=\\\"token punctuation\\\">:</span>RegisterInstancesWithLoadBalancer\\n                  <span class=\\\"token punctuation\\\">-</span> elasticloadbalancing<span class=\\\"token punctuation\\\">:</span>DeregisterTargets\\n                  <span class=\\\"token punctuation\\\">-</span> elasticloadbalancing<span class=\\\"token punctuation\\\">:</span>DescribeTargetGroups\\n                  <span class=\\\"token punctuation\\\">-</span> elasticloadbalancing<span class=\\\"token punctuation\\\">:</span>DescribeTargetHealth\\n                  <span class=\\\"token punctuation\\\">-</span> elasticloadbalancing<span class=\\\"token punctuation\\\">:</span>RegisterTargets\\n                <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'*'</span>\\n                <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> ecs.amazonaws.com\\n\\n  <span class=\\\"token key atrule\\\">TaskRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>IAM<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Role\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span> ecs<span class=\\\"token punctuation\\\">-</span>tasks.amazonaws.com\\n\\n  <span class=\\\"token key atrule\\\">TaskDefinition</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ECS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>TaskDefinition\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">TaskRoleArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> <span class=\\\"token string\\\">'TaskRole.Arn'</span>\\n      <span class=\\\"token key atrule\\\">ContainerDefinitions</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Environment</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> ASPNETCORE_ENVIRONMENT\\n              <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'EnvironmentName'</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> PORT\\n              <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'ContainerPort'</span>\\n          <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'ApplicationName'</span>\\n          <span class=\\\"token key atrule\\\">Image</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> <span class=\\\"token string\\\">'${BaseImageName}:${ImageTag}'</span>\\n          <span class=\\\"token key atrule\\\">PortMappings</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">ContainerPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'ContainerPort'</span>\\n          <span class=\\\"token key atrule\\\">LogConfiguration</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">LogDriver</span><span class=\\\"token punctuation\\\">:</span> awslogs\\n            <span class=\\\"token key atrule\\\">Options</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">awslogs-group</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'AWS::StackName'</span>\\n              <span class=\\\"token key atrule\\\">awslogs-region</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'AWS::Region'</span>\\n          <span class=\\\"token key atrule\\\">Memory</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'Memory'</span>\\n          <span class=\\\"token key atrule\\\">Essential</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span> CloudWatchLogsGroup\\n\\n  <span class=\\\"token key atrule\\\">CloudWatchLogsGroup</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Logs<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LogGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RetentionInDays</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">60</span>\\n      <span class=\\\"token key atrule\\\">LogGroupName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'AWS::StackName'</span>\\n\\n  <span class=\\\"token key atrule\\\">TargetGroup</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ElasticLoadBalancingV2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>TargetGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">HealthyThresholdCount</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">2</span>\\n      <span class=\\\"token key atrule\\\">HealthCheckIntervalSeconds</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">10</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> <span class=\\\"token string\\\">'infra-vpc::VpcId'</span>\\n      <span class=\\\"token key atrule\\\">Protocol</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!If</span>\\n        <span class=\\\"token punctuation\\\">-</span> httpsEnabled\\n        <span class=\\\"token punctuation\\\">-</span> HTTPS\\n        <span class=\\\"token punctuation\\\">-</span> HTTP\\n      <span class=\\\"token key atrule\\\">Matcher</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">HttpCode</span><span class=\\\"token punctuation\\\">:</span> 200<span class=\\\"token punctuation\\\">-</span><span class=\\\"token number\\\">299</span>\\n      <span class=\\\"token key atrule\\\">HealthCheckPath</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'HealthCheckPath'</span>\\n      <span class=\\\"token key atrule\\\">HealthCheckTimeoutSeconds</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">5</span>\\n      <span class=\\\"token key atrule\\\">TargetGroupAttributes</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'DeregistrationDelay'</span>\\n          <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> deregistration_delay.timeout_seconds\\n      <span class=\\\"token key atrule\\\">HealthCheckProtocol</span><span class=\\\"token punctuation\\\">:</span> HTTP\\n      <span class=\\\"token key atrule\\\">Port</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!If</span>\\n        <span class=\\\"token punctuation\\\">-</span> httpsEnabled\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">443</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">80</span>\\n\\n  <span class=\\\"token key atrule\\\">ListenerRule</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ElasticLoadBalancingV2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ListenerRule\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Priority</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'Priority'</span>\\n      <span class=\\\"token key atrule\\\">Conditions</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Field</span><span class=\\\"token punctuation\\\">:</span> path<span class=\\\"token punctuation\\\">-</span>pattern\\n          <span class=\\\"token key atrule\\\">Values</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'Path'</span>\\n      <span class=\\\"token key atrule\\\">Actions</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">TargetGroupArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">'TargetGroup'</span>\\n          <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> forward\\n      <span class=\\\"token key atrule\\\">ListenerArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>alb<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerListenerArn\\n</code></pre>\\n      </div>\\n<h2>CICD</h2>\\n<p>We’re almost there. I love AWS CodePipeline + CodeBuild because they’re both managed services, which means I don’t need to run and maintain a build server. CodeBuild provides you with an ephemeral build machine where you can run commands to build docker images and push them to ECR. CodePipeline defines your CICD automation process by letting you define different stages where you can pull source code, build it and deploy your applications. For example the diagram below illustrates a way to make your CICD on AWS.</p>\\n\\n  <span class=\\\"gatsby-resp-image-wrapper\\\" style=\\\"position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 750px; margin-left: auto; margin-right: auto;\\\">\\n    <span class=\\\"gatsby-resp-image-background-image\\\" style=\\\"padding-bottom: 46.49204864359214%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABJUlEQVQoz5WQXU6EMBSFWatbcA0uwAXogzHx0RCMMf48qA8Qw5jMGIMjpQHCj0wrDExLKSB6mSaaGB3jeTpp+/Wce7X3/6jrOpqXSlVVaRsfDzf2CRcluDZP2uVixfiFOXMcx3Vd3/d/hRnnKcl3j7af8H32WhH7LLMMgC+th/laGOMvOI5jSimYRooVL+q6llJyzpqmGZPbVggxwuYMSIRQEARamqaEkHhRnBvHU/sOQq6tU+N2D6b63oXxz2SoPcIqAe4iktOSrUNkLTicg8/LDCYH0/dvZcVUMswMfBiG2o8rhZKQ80KXO/tbj9iEOnyit9ahSlZwFEWbtj0MQ5g+w1fgZc3qgkCfqYMwmnue9zcMFfq+Vx4EO8siNLk60HU9SZIP5k74tbLXLOUAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\\\">\\n      <img class=\\\"gatsby-resp-image-image\\\" style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\" alt=\\\"CICD\\\" title=\\\"\\\" src=\\\"/static/CICD-54ff3498ed5c058ef90acb6ccac28e5f-245fd.png\\\" srcset=\\\"/static/CICD-54ff3498ed5c058ef90acb6ccac28e5f-7aee9.png 188w,\\n/static/CICD-54ff3498ed5c058ef90acb6ccac28e5f-2014b.png 375w,\\n/static/CICD-54ff3498ed5c058ef90acb6ccac28e5f-245fd.png 750w,\\n/static/CICD-54ff3498ed5c058ef90acb6ccac28e5f-952c5.png 1069w\\\" sizes=\\\"(max-width: 750px) 100vw, 750px\\\">\\n    </span>\\n  </span>\\n  \\n<ul>\\n<li>Developers commit code to GitHub repository.</li>\\n<li>CodePipeline polls the source code and passes it to CodeBuild.</li>\\n<li>CodeBuild builds a container image based on <code>buildspec.yml</code> file included in the project root, pushes it to ECR.</li>\\n<li>CodePipeline then runs a CloudFormation template to create a new task definition, and then updates ECS service.</li>\\n<li>ECS service is instructed by the new task definition to pull the container image from ECR and starts the containers using that image.</li>\\n</ul>\\n<p>The steps mentioned above is the complete flow of how CICD works using AWS managed tools and services. I find this approach neat and wasy, and heavily use it in my daily work - no build servers to maintain anymore!</p>\\n<p>Another reason I like this is that - yeah you pretty much have gussed it - you can CloudFormation it! This means I can write a generic CloudFormation template to serve the creation or update of most CICD pipelines. To build a new pipeline, all I need to do is to change a few parameters in the template and deploy it as a new CloudFormation stack. Usually, it only takes less than 1 minute to do so. Even better, I can write a CLI to generate such template and deploy it automatically - all of sudden life is so good already.</p>\\n<p>Here’s the CICD CloudFormation I used for this sample .NET core application.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'2010-09-09'</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"CICD - ECS Service - sample-netcore\\\"</span>\\n\\n<span class=\\\"token key atrule\\\">Parameters</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">ApplicationName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"The name of the application we're about to deploy using this CICD\\\"</span>\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"sample-netcore\\\"</span>\\n\\n  <span class=\\\"token key atrule\\\">RepoName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"The GitHub repository name for this application\\\"</span>\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"SampleNetCoreAWS\\\"</span>\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Repository</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::ECR::Repository\\\"</span>\\n\\n  <span class=\\\"token key atrule\\\">CloudFormationExecutionRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::IAM::Role\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"/\\\"</span>\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n          <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation.amazonaws.com\\n          <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n      <span class=\\\"token key atrule\\\">Policies</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">PolicyName</span><span class=\\\"token punctuation\\\">:</span> CloudFormationExecutionAccess\\n        <span class=\\\"token key atrule\\\">PolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'2012-10-17'</span>\\n          <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation<span class=\\\"token punctuation\\\">:</span>CreateStack\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation<span class=\\\"token punctuation\\\">:</span>DeleteStack\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation<span class=\\\"token punctuation\\\">:</span>DescribeStack*\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation<span class=\\\"token punctuation\\\">:</span>UpdateStack\\n            <span class=\\\"token punctuation\\\">-</span> ec2<span class=\\\"token punctuation\\\">:</span>Describe*\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>*\\n            <span class=\\\"token punctuation\\\">-</span> elasticloadbalancing<span class=\\\"token punctuation\\\">:</span>*\\n            <span class=\\\"token punctuation\\\">-</span> events<span class=\\\"token punctuation\\\">:</span>DescribeRule\\n            <span class=\\\"token punctuation\\\">-</span> events<span class=\\\"token punctuation\\\">:</span>DeleteRule\\n            <span class=\\\"token punctuation\\\">-</span> events<span class=\\\"token punctuation\\\">:</span>ListRuleNamesByTarget\\n            <span class=\\\"token punctuation\\\">-</span> events<span class=\\\"token punctuation\\\">:</span>ListTargetsByRule\\n            <span class=\\\"token punctuation\\\">-</span> events<span class=\\\"token punctuation\\\">:</span>PutRule\\n            <span class=\\\"token punctuation\\\">-</span> events<span class=\\\"token punctuation\\\">:</span>PutTargets\\n            <span class=\\\"token punctuation\\\">-</span> events<span class=\\\"token punctuation\\\">:</span>RemoveTargets\\n            <span class=\\\"token punctuation\\\">-</span> ecs<span class=\\\"token punctuation\\\">:</span>DescribeServices\\n            <span class=\\\"token punctuation\\\">-</span> ecs<span class=\\\"token punctuation\\\">:</span>UpdateService\\n            <span class=\\\"token punctuation\\\">-</span> ecs<span class=\\\"token punctuation\\\">:</span>RegisterTaskDefinition\\n            <span class=\\\"token punctuation\\\">-</span> ecs<span class=\\\"token punctuation\\\">:</span>DeregisterTaskDefinition\\n            <span class=\\\"token punctuation\\\">-</span> ecs<span class=\\\"token punctuation\\\">:</span>CreateService\\n            <span class=\\\"token punctuation\\\">-</span> iam<span class=\\\"token punctuation\\\">:</span>*\\n            <span class=\\\"token punctuation\\\">-</span> logs<span class=\\\"token punctuation\\\">:</span>CreateLogGroup\\n            <span class=\\\"token punctuation\\\">-</span> logs<span class=\\\"token punctuation\\\">:</span>CreateLogStream\\n            <span class=\\\"token punctuation\\\">-</span> logs<span class=\\\"token punctuation\\\">:</span>DescribeLogGroups\\n            <span class=\\\"token punctuation\\\">-</span> logs<span class=\\\"token punctuation\\\">:</span>DeleteLogGroup\\n            <span class=\\\"token punctuation\\\">-</span> logs<span class=\\\"token punctuation\\\">:</span>PutRetentionPolicy\\n\\n  <span class=\\\"token key atrule\\\">CodeBuildServiceRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::IAM::Role\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"/\\\"</span>\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n          <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> codebuild.amazonaws.com\\n          <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n      <span class=\\\"token key atrule\\\">Policies</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">PolicyName</span><span class=\\\"token punctuation\\\">:</span> CodeBuildAccess\\n        <span class=\\\"token key atrule\\\">PolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'2012-10-17'</span>\\n          <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> logs<span class=\\\"token punctuation\\\">:</span>CreateLogGroup\\n            <span class=\\\"token punctuation\\\">-</span> logs<span class=\\\"token punctuation\\\">:</span>CreateLogStream\\n            <span class=\\\"token punctuation\\\">-</span> logs<span class=\\\"token punctuation\\\">:</span>PutLogEvents\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>GetAuthorizationToken\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>s3<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>$<span class=\\\"token punctuation\\\">{</span>ArtifactBucket<span class=\\\"token punctuation\\\">}</span>/*\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>GetObject\\n            <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>PutObject\\n            <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>GetObjectVersion\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>ecr<span class=\\\"token punctuation\\\">:</span>$<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span>$<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>AccountId<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span>repository/$<span class=\\\"token punctuation\\\">{</span>Repository<span class=\\\"token punctuation\\\">}</span>\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>GetDownloadUrlForLayer\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>BatchGetImage\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>BatchCheckLayerAvailability\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>PutImage\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>InitiateLayerUpload\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>UploadLayerPart\\n            <span class=\\\"token punctuation\\\">-</span> ecr<span class=\\\"token punctuation\\\">:</span>CompleteLayerUpload\\n      \\n  <span class=\\\"token key atrule\\\">CodePipelineServiceRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::IAM::Role\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"/\\\"</span>\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n          <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> codepipeline.amazonaws.com\\n          <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n      <span class=\\\"token key atrule\\\">Policies</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">PolicyName</span><span class=\\\"token punctuation\\\">:</span> CodePipelineAccess\\n        <span class=\\\"token key atrule\\\">PolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'2012-10-17'</span>\\n          <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!Sub</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>s3<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>$<span class=\\\"token punctuation\\\">{</span>ArtifactBucket<span class=\\\"token punctuation\\\">}</span>/*\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>PutObject\\n            <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>GetObject\\n            <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>GetObjectVersion\\n            <span class=\\\"token punctuation\\\">-</span> s3<span class=\\\"token punctuation\\\">:</span>GetBucketVersioning\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Resource</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"*\\\"</span>\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> codebuild<span class=\\\"token punctuation\\\">:</span>StartBuild\\n            <span class=\\\"token punctuation\\\">-</span> codebuild<span class=\\\"token punctuation\\\">:</span>BatchGetBuilds\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation<span class=\\\"token punctuation\\\">:</span>CreateStack\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation<span class=\\\"token punctuation\\\">:</span>DeleteStack\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation<span class=\\\"token punctuation\\\">:</span>DescribeStack*\\n            <span class=\\\"token punctuation\\\">-</span> cloudformation<span class=\\\"token punctuation\\\">:</span>UpdateStack\\n            <span class=\\\"token punctuation\\\">-</span> iam<span class=\\\"token punctuation\\\">:</span>PassRole\\n\\n  <span class=\\\"token key atrule\\\">ArtifactBucket</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::S3::Bucket\\\"</span>\\n\\n  <span class=\\\"token key atrule\\\">CodeBuildProject</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::CodeBuild::Project\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Artifacts</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Location</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token key atrule\\\">Ref</span><span class=\\\"token punctuation\\\">:</span> ArtifactBucket\\n        <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> S3\\n      <span class=\\\"token key atrule\\\">Source</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Location</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> https<span class=\\\"token punctuation\\\">:</span>//github.com/ticklesource/$<span class=\\\"token punctuation\\\">{</span>RepoName<span class=\\\"token punctuation\\\">}</span>.git\\n        <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> GITHUB\\n      <span class=\\\"token key atrule\\\">Environment</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">ComputeType</span><span class=\\\"token punctuation\\\">:</span> BUILD_GENERAL1_LARGE\\n        <span class=\\\"token key atrule\\\">Image</span><span class=\\\"token punctuation\\\">:</span> aws/codebuild/docker<span class=\\\"token punctuation\\\">:</span>17.09.0\\n        <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> LINUX_CONTAINER\\n        <span class=\\\"token comment\\\"># PrivilegedMode: true</span>\\n        <span class=\\\"token key atrule\\\">EnvironmentVariables</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> AWS_DEFAULT_REGION\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> REPOSITORY_URI\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> <span class=\\\"token string\\\">\\\"${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${Repository}\\\"</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ApplicationName\\n      <span class=\\\"token key atrule\\\">ServiceRole</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> CodeBuildServiceRole\\n\\n  <span class=\\\"token key atrule\\\">Pipeline</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"AWS::CodePipeline::Pipeline\\\"</span>\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ApplicationName\\n      <span class=\\\"token key atrule\\\">RoleArn</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token tag\\\">!GetAtt</span>\\n        <span class=\\\"token punctuation\\\">-</span> CodePipelineServiceRole\\n        <span class=\\\"token punctuation\\\">-</span> Arn\\n      <span class=\\\"token key atrule\\\">ArtifactStore</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> S3\\n        <span class=\\\"token key atrule\\\">Location</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ArtifactBucket\\n      <span class=\\\"token key atrule\\\">Stages</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Source\\n        <span class=\\\"token key atrule\\\">Actions</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Source\\n          <span class=\\\"token key atrule\\\">ActionTypeId</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Category</span><span class=\\\"token punctuation\\\">:</span> Source\\n            <span class=\\\"token key atrule\\\">Owner</span><span class=\\\"token punctuation\\\">:</span> ThirdParty\\n            <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n            <span class=\\\"token key atrule\\\">Provider</span><span class=\\\"token punctuation\\\">:</span> GitHub\\n          <span class=\\\"token key atrule\\\">Configuration</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Owner</span><span class=\\\"token punctuation\\\">:</span> ktei\\n            <span class=\\\"token key atrule\\\">Repo</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> RepoName\\n            <span class=\\\"token key atrule\\\">Branch</span><span class=\\\"token punctuation\\\">:</span> develop\\n            <span class=\\\"token key atrule\\\">OAuthToken</span><span class=\\\"token punctuation\\\">:</span> your_github_oauth_token <span class=\\\"token comment\\\"># create your own token</span>\\n          <span class=\\\"token key atrule\\\">OutputArtifacts</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Source\\n          <span class=\\\"token key atrule\\\">RunOrder</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Build\\n        <span class=\\\"token key atrule\\\">Actions</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Build\\n          <span class=\\\"token key atrule\\\">ActionTypeId</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Category</span><span class=\\\"token punctuation\\\">:</span> Build\\n            <span class=\\\"token key atrule\\\">Owner</span><span class=\\\"token punctuation\\\">:</span> AWS\\n            <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n            <span class=\\\"token key atrule\\\">Provider</span><span class=\\\"token punctuation\\\">:</span> CodeBuild\\n          <span class=\\\"token key atrule\\\">Configuration</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">ProjectName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> CodeBuildProject\\n          <span class=\\\"token key atrule\\\">InputArtifacts</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Source\\n          <span class=\\\"token key atrule\\\">OutputArtifacts</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> BuildOutput\\n      <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Deploy\\n        <span class=\\\"token key atrule\\\">Actions</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> Deploy\\n          <span class=\\\"token key atrule\\\">ActionTypeId</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">Category</span><span class=\\\"token punctuation\\\">:</span> Deploy\\n            <span class=\\\"token key atrule\\\">Owner</span><span class=\\\"token punctuation\\\">:</span> AWS\\n            <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1</span>\\n            <span class=\\\"token key atrule\\\">Provider</span><span class=\\\"token punctuation\\\">:</span> CloudFormation\\n          <span class=\\\"token key atrule\\\">Configuration</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token key atrule\\\">ChangeSetName</span><span class=\\\"token punctuation\\\">:</span> Deploy\\n            <span class=\\\"token key atrule\\\">ActionMode</span><span class=\\\"token punctuation\\\">:</span> CREATE_UPDATE\\n            <span class=\\\"token key atrule\\\">StackName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> <span class=\\\"token string\\\">\\\"app-${ApplicationName}\\\"</span>\\n            <span class=\\\"token key atrule\\\">Capabilities</span><span class=\\\"token punctuation\\\">:</span> CAPABILITY_NAMED_IAM\\n            <span class=\\\"token key atrule\\\">TemplatePath</span><span class=\\\"token punctuation\\\">:</span> BuildOutput<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>cfn/deploy.yml\\n            <span class=\\\"token key atrule\\\">RoleArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> <span class=\\\"token punctuation\\\">[</span> CloudFormationExecutionRole<span class=\\\"token punctuation\\\">,</span> Arn <span class=\\\"token punctuation\\\">]</span>\\n            <span class=\\\"token key atrule\\\">ParameterOverrides</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Fn::Sub</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token punctuation\\\">|</span><span class=\\\"token punctuation\\\">-</span>\\n                <span class=\\\"token punctuation\\\">{</span>\\n                  <span class=\\\"token key atrule\\\">\\\"BaseImageName\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${Repository}\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n                  <span class=\\\"token key atrule\\\">\\\"ImageTag\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token punctuation\\\">{</span>\\n                    <span class=\\\"token key atrule\\\">\\\"Fn::GetParam\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token punctuation\\\">[</span>\\n                      <span class=\\\"token string\\\">\\\"BuildOutput\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n                      <span class=\\\"token string\\\">\\\"build.json\\\"</span><span class=\\\"token punctuation\\\">,</span>\\n                      <span class=\\\"token string\\\">\\\"tag\\\"</span>\\n                    <span class=\\\"token punctuation\\\">]</span>\\n                  <span class=\\\"token punctuation\\\">}</span>\\n                <span class=\\\"token punctuation\\\">}</span>\\n          <span class=\\\"token key atrule\\\">InputArtifacts</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> BuildOutput\\n</code></pre>\\n      </div>\\n<h2>Don’t forget Route53</h2>\\n<p>After you build CICD, it’ll start the first build and deployment automatically. If it succeeds, you can access your website through <a href=\\\"https://your-aws-load-balancer-dns-name.aws.com/app\\\">https://your-aws-load-balancer-dns-name.aws.com/app</a>. But this URL is too long to remember and most importantly, you won’t have SSL/TLS certificate to protect the ALB domain. However, if you have bought a domain then you should have at least one hosted zone in Route53 service. Go to that service page and create a new record set, where you should define an A record, for instance <code>www.mydomain.io</code>, pointing to your ALB domain name. Also, you need to use AWS Certificate Manager service to create an SSL/TLS certificate to protect <code>*.mydomain.io</code>. With all these set up, you can then browse <code>https://www.mydomain.io/app</code>.</p>\\n<h2>Conclusion</h2>\\n<p>From <a href=\\\"/build-your-aws-infrastructure-part-1/\\\">Part 1</a> to this Part 2, I’ve showed you how I utilized AWS resources and CloudFomration to build a secure and highly available .NET core website running on AWS ECS within my own VPC. I believe that there’s a lot to digest here if you’re absolutely a beginner on AWS and .NET core. However, I still hope that this article will at least give you some ideas and maybe inspire you in areas such as programming, cloud or DevOps. I enjoyed the journey of doing so and I hope you will too!</p>\",\"frontmatter\":{\"layout\":\"post\",\"title\":\"Build your AWS infrastructure - Part 2\",\"path\":\"/build-your-aws-infrastructure-part-2/\",\"categories\":[\"AWS\",\"DevOps\",\"CloudFormation\",\"ECS\",\"CodePipeline\",\"CodeBuild\",\".NET Core\"],\"date\":\"2018/01/10\"}}},{\"post\":{\"html\":\"<p>Surely when you see the title you’ll probably wonder: <em>“Hmmm… my lambda can access Internet without a problem. What the heck are you talk about?”</em>. Well, when you provision an AWS lambda, you can choose a VPC, and if you do that, then you need to configure your VPC properly otherwise the lambda will lose Internet access.</p>\\n<p>Hold on a second, why do we want lambda to reside in a VPC? A classic example would be: what if you want your lambda to read data from a Redis cluster? This, is when you need VPC, otherwise there’s no way for your lambda to access Redis. Alright, I’m writing this blog because today I had this problem that my lambda within VPC couldn’t access the Internet. It took me a while to figure out why. In fact, I should’ve followed the official documentation in the first place, which would’ve saved me a lot time. But anyway, let’s have a look how to do it.</p>\\n<!--more-->\\n<h2>Background story</h2>\\n<p>Let’s assume your VPC CIDR is <code>10.60.0.0/16</code> and you have two public subnets:</p>\\n<ul>\\n<li><strong>subnet1</strong>: <code>10.60.1.0/24</code></li>\\n<li><strong>subnet2</strong>: <code>10.60.2.0/24</code>.</li>\\n</ul>\\n<p>Also, you have depoyed a Redis cluster across these two subnets, which means the nodes of the cluster are deployed across these two subnets. Alright, now we want to deploy a lambda in this VPC, and allow it to access the Redis and the Internet. So what should we do?</p>\\n<h2>Create a lambda</h2>\\n<p>I assume you’ve got some experience using lambda, so I’m not gonna show you how to create lambda. A good practice is to provision it by CloudFormation, and the easiest way is to login AWS console and click a bunch of things to make it work. When you create the lambda, make sure you scroll down to <em>Configuration</em> section and choose VPC <code>10.60.0.0/16</code>. Then you’ll be asked to choose subnets, just choose both of them (<strong>subnet1</strong> and <strong>subnet2</strong>). By doing this, you can imagine that AWS will provision your lambda on containers running within these subnets.</p>\\n<h2>Security group for Redis</h2>\\n<p>Redis runs on TCP 6379, so the first thing we need to do is to create a RedisSecurityGroup:</p>\\n<ul>\\n<li>VPC: <code>10.60.0.0/16</code></li>\\n<li>Inbound: <code>Allow TCP 6379 from 10.60.0/0/16</code></li>\\n</ul>\\n<p>Attach this security group to both your lambda and Redis cluster. This esures that they can communicate with each other within VPC.</p>\\n<h2>Check your route table</h2>\\n<p>By now, you subnets <code>10.60.1.0/24</code> and <code>10.60.2.0/24</code> should be associated with a route table which has these routes like this:</p>\\n<table>\\n<thead>\\n<tr>\\n<th>Destination</th>\\n<th>Target</th>\\n<th></th>\\n</tr>\\n</thead>\\n<tbody>\\n<tr>\\n<td>10.60.0.0/16</td>\\n<td>local</td>\\n<td></td>\\n</tr>\\n<tr>\\n<td>0.0.0.0/0</td>\\n<td>igw-1234567</td>\\n<td></td>\\n</tr>\\n</tbody>\\n</table>\\n<p>This route table ensures that outgoing traffic will go through Internet gateway and eventually reach the Internet. Now if you think about it, by this logic, lambda should be able to access the Internet already. Well, unfortunately, our lambda doesn’t have public IP yet, which prevents the Internet access.</p>\\n<h2>Add NAT gateway</h2>\\n<p>To give the lambda a public IP, we need a NAT instance or gateway. AWS recommends us to use NAT gateway as it’s managed service. So let’s create a third <strong>subnet3</strong> in AZ3 (it doesn’t have to be in AZ3 though; any AZ is fine): <code>10.60.3.0/24</code>. Then go to VPC service page and create a NAT gateway in this subnet. Add a route table for this subnet with routes like this:</p>\\n<table>\\n<thead>\\n<tr>\\n<th>Destination</th>\\n<th>Target</th>\\n<th></th>\\n</tr>\\n</thead>\\n<tbody>\\n<tr>\\n<td>10.60.0.0/16</td>\\n<td>local</td>\\n<td></td>\\n</tr>\\n<tr>\\n<td>0.0.0.0/0</td>\\n<td>igw-1234567</td>\\n<td></td>\\n</tr>\\n</tbody>\\n</table>\\n<h2>Change routes for subnet1 and subnet2</h2>\\n<p>Suppose your NAT gateway ID is nat-7654321. Now change the route table for <strong>subnet1</strong> and <strong>subnet2</strong>:</p>\\n<table>\\n<thead>\\n<tr>\\n<th>Destination</th>\\n<th>Target</th>\\n<th></th>\\n</tr>\\n</thead>\\n<tbody>\\n<tr>\\n<td>10.60.0.0/16</td>\\n<td>local</td>\\n<td></td>\\n</tr>\\n<tr>\\n<td>0.0.0.0/0</td>\\n<td>nat-7654321</td>\\n<td></td>\\n</tr>\\n</tbody>\\n</table>\\n<p>There you go, now your routes work like this: <em>subnet1/2 -> nat-7654321 -> igw-1234567</em>.</p>\\n<h2>Conclusion</h2>\\n<p>There seems to be a lot steps to get this working, but it’s actually not that hard. What we did here is create a public subnet - <strong>subnet3</strong> where we put a NAT gateway. This public subnet is responsible for all the outgoing traffic to access the Internet. In the meantime, we made <strong>subnet1</strong> and <strong>subnet2</strong> private by removing the route <code>0.0.0.0/0 -> igw-1234567</code>. Instead, we re-route all the outgoing traffic to the NAT gateway residing in <strong>subnet3</strong>. Because <strong>subnet3</strong> has the route to access the Internet, the lambda in <strong>subnet1</strong> and <strong>subnet2</strong> will eventually have their access to Internet. Easy, right?</p>\",\"frontmatter\":{\"layout\":\"post\",\"title\":\"Let your lambda within a VPC access Internet\",\"path\":\"/let-lambda-within-vpc-access-internet/\",\"categories\":[\"AWS\",\"Lambda\",\"VPC\"],\"date\":\"2018/01/17\"}}}]}},\"pathContext\":{}}\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/json-loader!./.cache/json/index.json\n// module id = 382\n// module chunks = 142629428675168"],"sourceRoot":""}