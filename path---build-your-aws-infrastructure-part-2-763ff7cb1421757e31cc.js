webpackJsonp([77006927621628],{380:function(n,a){n.exports={data:{site:{meta:{title:"DisasterDev",description:"The blog of a disaster developer",url:"https://blog.disasterdev.net",author:"Rui Cheng",adsense:""}},post:{id:"/Users/rui/dev/ktei.github.io/src/pages/articles/2018-01-10-build-your-aws-infrastructure-part-2/index.md absPath of file >>> MarkdownRemark",html:'<p>Hey fellas, you’re reading part 2 of <a href="/build-your-aws-infrastructure-part-1/">Build your AWS infrastructure</a>. In part 1, I showed you how I built the basic infrastrucutre from VPC to load balancer and then to ECS cluster. Since we’ve got the foundation by now, let’s start building applications!</p>\n<!--more-->\n<h2>Overview</h2>\n<p>Here’s an overview of what I did: I built a simple .NET core application, deployed it as a container on ECS and added a Route53 record set pointing to my application load balancer which points to my ECS cluster. Here’s an example: when users type <code>www.disasterdev.net</code> in their browser,the request is forwarded to my load balancer first, and then, based on the path of the request, the ALB (application load balancer) knows how to route the request to the corresponding container. Let’s see how I did all these in details.</p>\n<h2>Build .NET core application</h2>\n<p>You probably have heard of <a href="https://www.microsoft.com/net/learn/get-started/macos">.NET core</a> already. Prior to its brith, we could only deploy .NET applications on windows servers (yeah yeah… I there’s Mono). Most importantly, it was very difficult to run .NET applications as containers - now that really sucks. Microsoft knew how important container technology would be, so it rewrote .NET framework from scratch, which is aimed to be cross-platform. Now with .NET core, I can deploy it as containers on Linux, which is huge benefit as now I can easily deploy a .NET core application on AWS cloud!</p>\n<p>If you’re a .NET developer, do yourself a favor and start learning .NET core today - I believe it’ll gradually replace traditional .NET applications, and most importantly, you don’t have to worry cross-plat form issue anymore.</p>\n<p>I assume you have installed .NET core SDK and runtime. Open terminal, and type</p>\n<div class="gatsby-highlight">\n      <pre class="language-none"><code>mkdir SampleNetCoreAWS\ncd SampleNetCoreAWS\ndotnet new web\ndotnet restore\ndotnet run</code></pre>\n      </div>\n<p>Bang! There’s your first .NET core application running on <code>http://localhost:5000</code> already. Before deploying it to AWS, I did a few changes:</p>\n<p>In <code>Program.cs</code>:</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> IWebHost <span class="token function">BuildWebHost</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>\n    WebHost<span class="token punctuation">.</span><span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>\n        <span class="token punctuation">.</span><span class="token function">UseKestrel</span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">></span>\n        <span class="token punctuation">{</span>\n            <span class="token comment">// kestrel listens to port 5000 of any IPs</span>\n            options<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span>IPAddress<span class="token punctuation">.</span>Any<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">GetEnvironmentVariable</span><span class="token punctuation">(</span><span class="token string">"PORT"</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token string">"5000"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n        <span class="token punctuation">.</span><span class="token generic-method function">UseStartup<span class="token punctuation">&lt;</span>Startup<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>In <code>Startup.cs</code>:</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span>IApplicationBuilder app<span class="token punctuation">,</span> IHostingEnvironment env<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        app<span class="token punctuation">.</span><span class="token function">UseDeveloperExceptionPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    app<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span><span class="token string">"/app/healthcheck"</span><span class="token punctuation">,</span> HandleHealthCheck<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    app<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span><span class="token string">"/app"</span><span class="token punctuation">,</span> HandleApp<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">HandleApp</span><span class="token punctuation">(</span>IApplicationBuilder app<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">async</span> context <span class="token operator">=</span><span class="token operator">></span>\n    <span class="token punctuation">{</span>\n        <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">"Hello world!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">HandleHealthCheck</span><span class="token punctuation">(</span>IApplicationBuilder app<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">async</span> context <span class="token operator">=</span><span class="token operator">></span>\n    <span class="token punctuation">{</span>\n        <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">"I\'m running"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre>\n      </div>\n<p>Notice that this code was written in the way to fit my scenario only. You can write your own application however you like, but do remember to configure <em>kestrel</em> to listen to <code>IPAddress.Any</code> on port 5000, otherwise you application won’t work, because ECS will have no way to send send traffic to your containers.</p>\n<p>Don’t forget to add a Dockerfile to build your image:</p>\n<div class="gatsby-highlight">\n      <pre class="language-docker"><code><span class="token keyword">FROM</span> microsoft/dotnet<span class="token punctuation">:</span>2.0.4<span class="token punctuation">-</span>sdk<span class="token punctuation">-</span>2.1.3 as builder\n\n<span class="token keyword">COPY</span> . /app\n<span class="token keyword">WORKDIR</span> /app\n<span class="token keyword">RUN</span> <span class="token punctuation">[</span><span class="token string">"dotnet"</span><span class="token punctuation">,</span> <span class="token string">"restore"</span><span class="token punctuation">,</span> <span class="token string">"--no-cache"</span><span class="token punctuation">]</span>\n<span class="token keyword">RUN</span> dotnet publish <span class="token punctuation">-</span>c Release <span class="token punctuation">-</span>r linux<span class="token punctuation">-</span>x64\n\n<span class="token keyword">FROM</span> microsoft/dotnet<span class="token punctuation">:</span>2.0.4<span class="token punctuation">-</span>runtime\n<span class="token keyword">WORKDIR</span> /app\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=builder /app/bin/Release/netcoreapp2.0/linux<span class="token punctuation">-</span>64/publish .\n<span class="token keyword">EXPOSE</span> 5000\n<span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span><span class="token string">"dotnet"</span><span class="token punctuation">,</span> <span class="token string">"SampleNetCoreAWS.dll"</span><span class="token punctuation">]</span>\n</code></pre>\n      </div>\n<p>We also need a buildspec.yml, that is for AWS CodeBuild, which we’ll see later.</p>\n<div class="gatsby-highlight">\n      <pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">0.1</span>\n\n<span class="token key atrule">phases</span><span class="token punctuation">:</span>\n  <span class="token key atrule">pre_build</span><span class="token punctuation">:</span>\n    <span class="token key atrule">commands</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> echo <span class="token punctuation">-</span>n "$CODEBUILD_BUILD_ID" <span class="token punctuation">|</span> sed "s/.*<span class="token punctuation">:</span>\\(<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">:</span>xdigit<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\\<span class="token punctuation">{</span>7\\<span class="token punctuation">}</span>\\).*/\\1/" <span class="token punctuation">></span> /tmp/build_id.out\n      <span class="token punctuation">-</span> printf \'<span class="token punctuation">{</span>"tag"<span class="token punctuation">:</span><span class="token string">"%s"</span><span class="token punctuation">}</span>\' "$(cat /tmp/build_id.out)" <span class="token punctuation">></span> build.json\n      <span class="token punctuation">-</span> echo Logging in to Amazon ECR\n      <span class="token punctuation">-</span> $(aws ecr get<span class="token punctuation">-</span>login <span class="token punctuation">-</span><span class="token punctuation">-</span>region $AWS_DEFAULT_REGION <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>include<span class="token punctuation">-</span>email)\n  <span class="token key atrule">build</span><span class="token punctuation">:</span>\n    <span class="token key atrule">commands</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> echo Build started on `date` for $ASPNETCORE_ENVIRONMENT\n      <span class="token punctuation">-</span> docker build <span class="token punctuation">-</span><span class="token punctuation">-</span>tag "$REPOSITORY_URI<span class="token punctuation">:</span>$(cat /tmp/build_id.out)" .\n  <span class="token key atrule">post_build</span><span class="token punctuation">:</span>\n    <span class="token key atrule">commands</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> echo Build completed on `date`\n      <span class="token punctuation">-</span> echo Pushing the Docker image<span class="token punctuation">...</span>\n      <span class="token punctuation">-</span> docker push "$REPOSITORY_URI<span class="token punctuation">:</span>$(cat /tmp/build_id.out)"\n<span class="token key atrule">artifacts</span><span class="token punctuation">:</span>\n  <span class="token key atrule">files</span><span class="token punctuation">:</span>\n    <span class="token punctuation">-</span> build.json\n    <span class="token punctuation">-</span> cfn/**/*\n</code></pre>\n      </div>\n<h2>Deployment</h2>\n<p>To run a container on ECS, we need to define an ECS service, for which we need to define a task definition. A task definition is like a recipe for <em>cooking</em> a container. It tells ECS how to spin up a container, including what Docker image it should use, how much memory it can allocate to the service, what container port it should deploy to, so on so forth. Once the task defined, ECS will maintain desired number of containers running for the task.</p>\n<p>In <em>SampleNetCoreAWS</em> project, I added the <code>cfn/deploy.yml</code>, which contains the task definition as below. By executing this CloudFormation file, an applicatin stack <code>app-sample-netcore</code> will be created or updated if it exists. The idea is that each deployment produces a brand new version of task definition in the form of CloudFormation. We (technically not we, but the build machine) then applies this new task definition to the ECS service. ECS service detects that its task definition has been updated, so it starts to re-run containers based on the lastet task definition including pulling the new container image, spinning up desired number of containers etc. In short, <code>deploy.yml</code> tells AWS how to deploy our sample .NET core application. Here’s the <code>deploy.yml</code>.</p>\n<div class="gatsby-highlight">\n      <pre class="language-yaml"><code><span class="token key atrule">AWSTemplateFormatVersion</span><span class="token punctuation">:</span> <span class="token string">\'2010-09-09\'</span>\n\n<span class="token key atrule">Description</span><span class="token punctuation">:</span> ECS Service <span class="token punctuation">-</span> sample<span class="token punctuation">-</span>netcore\n\n<span class="token key atrule">Parameters</span><span class="token punctuation">:</span>\n  <span class="token key atrule">ApplicationName</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> String\n    <span class="token key atrule">Description</span><span class="token punctuation">:</span> The name of the application we\'re trying to deploy<span class="token punctuation">,</span> which will be\n      used for service name and container name etc.\n    <span class="token key atrule">Default</span><span class="token punctuation">:</span> sample<span class="token punctuation">-</span>netcore\n\n  <span class="token key atrule">EnvironmentName</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> String\n    <span class="token key atrule">Description</span><span class="token punctuation">:</span> The runtime environment name for this application<span class="token punctuation">,</span> e.g. ASPNETCORE_ENVIRONMENT\n      for Dotnet Core<span class="token punctuation">,</span> NODE_ENV for Node\n    <span class="token key atrule">Default</span><span class="token punctuation">:</span> Development\n\n  <span class="token key atrule">BaseImageName</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> String\n    <span class="token key atrule">Description</span><span class="token punctuation">:</span> The docker image name\n\n  <span class="token key atrule">EnableHttps</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> String\n    <span class="token key atrule">Description</span><span class="token punctuation">:</span> Set this to true if you want to encrpyted traffic between ALB and ECS\n    <span class="token key atrule">Default</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>\n\n  <span class="token key atrule">ClusterName</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> String\n    <span class="token key atrule">Description</span><span class="token punctuation">:</span> The name of the ECS cluster where this service is about to be deployed\n    <span class="token key atrule">Default</span><span class="token punctuation">:</span> ApplicationCluster\n\n  <span class="token key atrule">DesiredCount</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> Number\n    <span class="token key atrule">Description</span><span class="token punctuation">:</span> How many instance of this task should we run across our cluster<span class="token punctuation">?</span>\n    <span class="token key atrule">Default</span><span class="token punctuation">:</span> <span class="token number">1</span>\n\n  <span class="token key atrule">Priority</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Description</span><span class="token punctuation">:</span> Priority to evaluate Path rules\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> Number\n    <span class="token key atrule">MaxValue</span><span class="token punctuation">:</span> <span class="token number">50000</span>\n    <span class="token key atrule">MinValue</span><span class="token punctuation">:</span> <span class="token number">1</span>\n    <span class="token key atrule">Default</span><span class="token punctuation">:</span> <span class="token number">1</span>\n\n  <span class="token key atrule">ImageTag</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> String\n    <span class="token key atrule">Description</span><span class="token punctuation">:</span> The docker image tag\n\n  <span class="token key atrule">HealthCheckPath</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> String\n    <span class="token key atrule">Description</span><span class="token punctuation">:</span> Every container must provide a health url for the load balancer to\n      test with\n    <span class="token key atrule">Default</span><span class="token punctuation">:</span> /app/healthcheck\n\n  <span class="token key atrule">DeregistrationDelay</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> Number\n    <span class="token key atrule">Description</span><span class="token punctuation">:</span> The duration (in seconds) ECS waits for before degistrating a container\n    <span class="token key atrule">Default</span><span class="token punctuation">:</span> <span class="token number">5</span>\n\n  <span class="token key atrule">Memory</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> Number\n    <span class="token key atrule">Description</span><span class="token punctuation">:</span> \'Soft memory limit of this task<span class="token punctuation">:</span> the service cannot use memory above\n      this number\'\n    <span class="token key atrule">Default</span><span class="token punctuation">:</span> <span class="token number">256</span>\n\n  <span class="token key atrule">Path</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> String\n    <span class="token key atrule">Description</span><span class="token punctuation">:</span> The path to register with the ALB\n    <span class="token key atrule">Default</span><span class="token punctuation">:</span> /app*\n\n  <span class="token key atrule">ContainerPort</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> Number\n    <span class="token key atrule">Description</span><span class="token punctuation">:</span> The port the load balancer will map traffic to on the container;\n      this application should listen to this port as well\n    <span class="token key atrule">Default</span><span class="token punctuation">:</span> <span class="token number">5000</span>\n\n<span class="token key atrule">Conditions</span><span class="token punctuation">:</span>\n  <span class="token key atrule">httpsEnabled</span><span class="token punctuation">:</span> <span class="token tag">!Equals</span>\n    <span class="token punctuation">-</span> <span class="token tag">!Ref</span> <span class="token string">\'EnableHttps\'</span>\n    <span class="token punctuation">-</span> <span class="token boolean important">true</span>\n\n<span class="token key atrule">Resources</span><span class="token punctuation">:</span>\n  <span class="token key atrule">Service</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>ECS<span class="token punctuation">:</span><span class="token punctuation">:</span>Service\n    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>\n      <span class="token key atrule">LoadBalancers</span><span class="token punctuation">:</span> \n          <span class="token punctuation">-</span> <span class="token key atrule">ContainerName</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'ApplicationName\'</span>\n            <span class="token key atrule">TargetGroupArn</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'TargetGroup\'</span>\n            <span class="token key atrule">ContainerPort</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'ContainerPort\'</span>\n      <span class="token key atrule">Cluster</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'ClusterName\'</span>\n      <span class="token key atrule">Role</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'ServiceRole\'</span>\n      <span class="token key atrule">TaskDefinition</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'TaskDefinition\'</span>\n      <span class="token key atrule">DesiredCount</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'DesiredCount\'</span>\n    <span class="token key atrule">DependsOn</span><span class="token punctuation">:</span> ListenerRule\n\n  <span class="token key atrule">ServiceRole</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>IAM<span class="token punctuation">:</span><span class="token punctuation">:</span>Role\n    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>\n      <span class="token key atrule">Path</span><span class="token punctuation">:</span> /\n      <span class="token key atrule">Policies</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">PolicyName</span><span class="token punctuation">:</span> ECSService\n          <span class="token key atrule">PolicyDocument</span><span class="token punctuation">:</span>\n            <span class="token key atrule">Version</span><span class="token punctuation">:</span> <span class="token string">\'2012-10-17\'</span>\n            <span class="token key atrule">Statement</span><span class="token punctuation">:</span>\n              <span class="token punctuation">-</span> <span class="token key atrule">Action</span><span class="token punctuation">:</span>\n                  <span class="token punctuation">-</span> ec2<span class="token punctuation">:</span>AuthorizeSecurityGroupIngress\n                  <span class="token punctuation">-</span> ec2<span class="token punctuation">:</span>Describe*\n                  <span class="token punctuation">-</span> elasticloadbalancing<span class="token punctuation">:</span>DeregisterInstancesFromLoadBalancer\n                  <span class="token punctuation">-</span> elasticloadbalancing<span class="token punctuation">:</span>Describe*\n                  <span class="token punctuation">-</span> elasticloadbalancing<span class="token punctuation">:</span>RegisterInstancesWithLoadBalancer\n                  <span class="token punctuation">-</span> elasticloadbalancing<span class="token punctuation">:</span>DeregisterTargets\n                  <span class="token punctuation">-</span> elasticloadbalancing<span class="token punctuation">:</span>DescribeTargetGroups\n                  <span class="token punctuation">-</span> elasticloadbalancing<span class="token punctuation">:</span>DescribeTargetHealth\n                  <span class="token punctuation">-</span> elasticloadbalancing<span class="token punctuation">:</span>RegisterTargets\n                <span class="token key atrule">Resource</span><span class="token punctuation">:</span> <span class="token string">\'*\'</span>\n                <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow\n      <span class="token key atrule">AssumeRolePolicyDocument</span><span class="token punctuation">:</span>\n        <span class="token key atrule">Statement</span><span class="token punctuation">:</span>\n          <span class="token punctuation">-</span> <span class="token key atrule">Action</span><span class="token punctuation">:</span>\n              <span class="token punctuation">-</span> sts<span class="token punctuation">:</span>AssumeRole\n            <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow\n            <span class="token key atrule">Principal</span><span class="token punctuation">:</span>\n              <span class="token key atrule">Service</span><span class="token punctuation">:</span>\n                <span class="token punctuation">-</span> ecs.amazonaws.com\n\n  <span class="token key atrule">TaskRole</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>IAM<span class="token punctuation">:</span><span class="token punctuation">:</span>Role\n    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>\n      <span class="token key atrule">AssumeRolePolicyDocument</span><span class="token punctuation">:</span>\n        <span class="token key atrule">Statement</span><span class="token punctuation">:</span>\n          <span class="token punctuation">-</span> <span class="token key atrule">Action</span><span class="token punctuation">:</span> sts<span class="token punctuation">:</span>AssumeRole\n            <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow\n            <span class="token key atrule">Principal</span><span class="token punctuation">:</span>\n              <span class="token key atrule">Service</span><span class="token punctuation">:</span> ecs<span class="token punctuation">-</span>tasks.amazonaws.com\n\n  <span class="token key atrule">TaskDefinition</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>ECS<span class="token punctuation">:</span><span class="token punctuation">:</span>TaskDefinition\n    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>\n      <span class="token key atrule">TaskRoleArn</span><span class="token punctuation">:</span> <span class="token tag">!GetAtt</span> <span class="token string">\'TaskRole.Arn\'</span>\n      <span class="token key atrule">ContainerDefinitions</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">Environment</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">Name</span><span class="token punctuation">:</span> ASPNETCORE_ENVIRONMENT\n              <span class="token key atrule">Value</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'EnvironmentName\'</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">Name</span><span class="token punctuation">:</span> PORT\n              <span class="token key atrule">Value</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'ContainerPort\'</span>\n          <span class="token key atrule">Name</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'ApplicationName\'</span>\n          <span class="token key atrule">Image</span><span class="token punctuation">:</span> <span class="token tag">!Sub</span> <span class="token string">\'${BaseImageName}:${ImageTag}\'</span>\n          <span class="token key atrule">PortMappings</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">ContainerPort</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'ContainerPort\'</span>\n          <span class="token key atrule">LogConfiguration</span><span class="token punctuation">:</span>\n            <span class="token key atrule">LogDriver</span><span class="token punctuation">:</span> awslogs\n            <span class="token key atrule">Options</span><span class="token punctuation">:</span>\n              <span class="token key atrule">awslogs-group</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'AWS::StackName\'</span>\n              <span class="token key atrule">awslogs-region</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'AWS::Region\'</span>\n          <span class="token key atrule">Memory</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'Memory\'</span>\n          <span class="token key atrule">Essential</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n    <span class="token key atrule">DependsOn</span><span class="token punctuation">:</span> CloudWatchLogsGroup\n\n  <span class="token key atrule">CloudWatchLogsGroup</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>Logs<span class="token punctuation">:</span><span class="token punctuation">:</span>LogGroup\n    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>\n      <span class="token key atrule">RetentionInDays</span><span class="token punctuation">:</span> <span class="token number">60</span>\n      <span class="token key atrule">LogGroupName</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'AWS::StackName\'</span>\n\n  <span class="token key atrule">TargetGroup</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>ElasticLoadBalancingV2<span class="token punctuation">:</span><span class="token punctuation">:</span>TargetGroup\n    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>\n      <span class="token key atrule">HealthyThresholdCount</span><span class="token punctuation">:</span> <span class="token number">2</span>\n      <span class="token key atrule">HealthCheckIntervalSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>\n      <span class="token key atrule">VpcId</span><span class="token punctuation">:</span> <span class="token tag">!ImportValue</span> <span class="token string">\'infra-vpc::VpcId\'</span>\n      <span class="token key atrule">Protocol</span><span class="token punctuation">:</span> <span class="token tag">!If</span>\n        <span class="token punctuation">-</span> httpsEnabled\n        <span class="token punctuation">-</span> HTTPS\n        <span class="token punctuation">-</span> HTTP\n      <span class="token key atrule">Matcher</span><span class="token punctuation">:</span>\n        <span class="token key atrule">HttpCode</span><span class="token punctuation">:</span> 200<span class="token punctuation">-</span><span class="token number">299</span>\n      <span class="token key atrule">HealthCheckPath</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'HealthCheckPath\'</span>\n      <span class="token key atrule">HealthCheckTimeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>\n      <span class="token key atrule">TargetGroupAttributes</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">Value</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'DeregistrationDelay\'</span>\n          <span class="token key atrule">Key</span><span class="token punctuation">:</span> deregistration_delay.timeout_seconds\n      <span class="token key atrule">HealthCheckProtocol</span><span class="token punctuation">:</span> HTTP\n      <span class="token key atrule">Port</span><span class="token punctuation">:</span> <span class="token tag">!If</span>\n        <span class="token punctuation">-</span> httpsEnabled\n        <span class="token punctuation">-</span> <span class="token number">443</span>\n        <span class="token punctuation">-</span> <span class="token number">80</span>\n\n  <span class="token key atrule">ListenerRule</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>ElasticLoadBalancingV2<span class="token punctuation">:</span><span class="token punctuation">:</span>ListenerRule\n    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>\n      <span class="token key atrule">Priority</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'Priority\'</span>\n      <span class="token key atrule">Conditions</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">Field</span><span class="token punctuation">:</span> path<span class="token punctuation">-</span>pattern\n          <span class="token key atrule">Values</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> <span class="token tag">!Ref</span> <span class="token string">\'Path\'</span>\n      <span class="token key atrule">Actions</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">TargetGroupArn</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> <span class="token string">\'TargetGroup\'</span>\n          <span class="token key atrule">Type</span><span class="token punctuation">:</span> forward\n      <span class="token key atrule">ListenerArn</span><span class="token punctuation">:</span> <span class="token tag">!ImportValue</span> infra<span class="token punctuation">-</span>alb<span class="token punctuation">:</span><span class="token punctuation">:</span>LoadBalancerListenerArn\n</code></pre>\n      </div>\n<h2>CICD</h2>\n<p>We’re almost there. I love AWS CodePipeline + CodeBuild because they’re both managed services, which means I don’t need to run and maintain a build server. CodeBuild provides you with an ephemeral build machine where you can run commands to build docker images and push them to ECR. CodePipeline defines your CICD automation process by letting you define different stages where you can pull source code, build it and deploy your applications. For example the diagram below illustrates a way to make your CICD on AWS.</p>\n\n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 750px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.49204864359214%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABJUlEQVQoz5WQXU6EMBSFWatbcA0uwAXogzHx0RCMMf48qA8Qw5jMGIMjpQHCj0wrDExLKSB6mSaaGB3jeTpp+/Wce7X3/6jrOpqXSlVVaRsfDzf2CRcluDZP2uVixfiFOXMcx3Vd3/d/hRnnKcl3j7af8H32WhH7LLMMgC+th/laGOMvOI5jSimYRooVL+q6llJyzpqmGZPbVggxwuYMSIRQEARamqaEkHhRnBvHU/sOQq6tU+N2D6b63oXxz2SoPcIqAe4iktOSrUNkLTicg8/LDCYH0/dvZcVUMswMfBiG2o8rhZKQ80KXO/tbj9iEOnyit9ahSlZwFEWbtj0MQ5g+w1fgZc3qgkCfqYMwmnue9zcMFfq+Vx4EO8siNLk60HU9SZIP5k74tbLXLOUAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;" alt="CICD" title="" src="/static/CICD-54ff3498ed5c058ef90acb6ccac28e5f-245fd.png" srcset="/static/CICD-54ff3498ed5c058ef90acb6ccac28e5f-7aee9.png 188w,\n/static/CICD-54ff3498ed5c058ef90acb6ccac28e5f-2014b.png 375w,\n/static/CICD-54ff3498ed5c058ef90acb6ccac28e5f-245fd.png 750w,\n/static/CICD-54ff3498ed5c058ef90acb6ccac28e5f-952c5.png 1069w" sizes="(max-width: 750px) 100vw, 750px">\n    </span>\n  </span>\n  \n<ul>\n<li>Developers commit code to GitHub repository.</li>\n<li>CodePipeline polls the source code and passes it to CodeBuild.</li>\n<li>CodeBuild builds a container image based on <code>buildspec.yml</code> file included in the project root, pushes it to ECR.</li>\n<li>CodePipeline then runs a CloudFormation template to create a new task definition, and then updates ECS service.</li>\n<li>ECS service is instructed by the new task definition to pull the container image from ECR and starts the containers using that image.</li>\n</ul>\n<p>The steps mentioned above is the complete flow of how CICD works using AWS managed tools and services. I find this approach neat and wasy, and heavily use it in my daily work - no build servers to maintain anymore!</p>\n<p>Another reason I like this is that - yeah you pretty much have gussed it - you can CloudFormation it! This means I can write a generic CloudFormation template to serve the creation or update of most CICD pipelines. To build a new pipeline, all I need to do is to change a few parameters in the template and deploy it as a new CloudFormation stack. Usually, it only takes less than 1 minute to do so. Even better, I can write a CLI to generate such template and deploy it automatically - all of sudden life is so good already.</p>\n<p>Here’s the CICD CloudFormation I used for this sample .NET core application.</p>\n<div class="gatsby-highlight">\n      <pre class="language-yaml"><code><span class="token punctuation">---</span>\n<span class="token key atrule">AWSTemplateFormatVersion</span><span class="token punctuation">:</span> <span class="token string">\'2010-09-09\'</span>\n\n<span class="token key atrule">Description</span><span class="token punctuation">:</span> <span class="token string">"CICD - ECS Service - sample-netcore"</span>\n\n<span class="token key atrule">Parameters</span><span class="token punctuation">:</span>\n  <span class="token key atrule">ApplicationName</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> String\n    <span class="token key atrule">Description</span><span class="token punctuation">:</span> <span class="token string">"The name of the application we\'re about to deploy using this CICD"</span>\n    <span class="token key atrule">Default</span><span class="token punctuation">:</span> <span class="token string">"sample-netcore"</span>\n\n  <span class="token key atrule">RepoName</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> String\n    <span class="token key atrule">Description</span><span class="token punctuation">:</span> <span class="token string">"The GitHub repository name for this application"</span>\n    <span class="token key atrule">Default</span><span class="token punctuation">:</span> <span class="token string">"SampleNetCoreAWS"</span>\n\n<span class="token key atrule">Resources</span><span class="token punctuation">:</span>\n  <span class="token key atrule">Repository</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">"AWS::ECR::Repository"</span>\n\n  <span class="token key atrule">CloudFormationExecutionRole</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">"AWS::IAM::Role"</span>\n    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>\n      <span class="token key atrule">Path</span><span class="token punctuation">:</span> <span class="token string">"/"</span>\n      <span class="token key atrule">AssumeRolePolicyDocument</span><span class="token punctuation">:</span>\n        <span class="token key atrule">Statement</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow\n          <span class="token key atrule">Principal</span><span class="token punctuation">:</span>\n            <span class="token key atrule">Service</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> cloudformation.amazonaws.com\n          <span class="token key atrule">Action</span><span class="token punctuation">:</span>\n          <span class="token punctuation">-</span> sts<span class="token punctuation">:</span>AssumeRole\n      <span class="token key atrule">Policies</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token key atrule">PolicyName</span><span class="token punctuation">:</span> CloudFormationExecutionAccess\n        <span class="token key atrule">PolicyDocument</span><span class="token punctuation">:</span>\n          <span class="token key atrule">Version</span><span class="token punctuation">:</span> <span class="token string">\'2012-10-17\'</span>\n          <span class="token key atrule">Statement</span><span class="token punctuation">:</span>\n          <span class="token punctuation">-</span> <span class="token key atrule">Resource</span><span class="token punctuation">:</span> <span class="token string">"*"</span>\n            <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow\n            <span class="token key atrule">Action</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> cloudformation<span class="token punctuation">:</span>CreateStack\n            <span class="token punctuation">-</span> cloudformation<span class="token punctuation">:</span>DeleteStack\n            <span class="token punctuation">-</span> cloudformation<span class="token punctuation">:</span>DescribeStack*\n            <span class="token punctuation">-</span> cloudformation<span class="token punctuation">:</span>UpdateStack\n            <span class="token punctuation">-</span> ec2<span class="token punctuation">:</span>Describe*\n            <span class="token punctuation">-</span> ecr<span class="token punctuation">:</span>*\n            <span class="token punctuation">-</span> elasticloadbalancing<span class="token punctuation">:</span>*\n            <span class="token punctuation">-</span> events<span class="token punctuation">:</span>DescribeRule\n            <span class="token punctuation">-</span> events<span class="token punctuation">:</span>DeleteRule\n            <span class="token punctuation">-</span> events<span class="token punctuation">:</span>ListRuleNamesByTarget\n            <span class="token punctuation">-</span> events<span class="token punctuation">:</span>ListTargetsByRule\n            <span class="token punctuation">-</span> events<span class="token punctuation">:</span>PutRule\n            <span class="token punctuation">-</span> events<span class="token punctuation">:</span>PutTargets\n            <span class="token punctuation">-</span> events<span class="token punctuation">:</span>RemoveTargets\n            <span class="token punctuation">-</span> ecs<span class="token punctuation">:</span>DescribeServices\n            <span class="token punctuation">-</span> ecs<span class="token punctuation">:</span>UpdateService\n            <span class="token punctuation">-</span> ecs<span class="token punctuation">:</span>RegisterTaskDefinition\n            <span class="token punctuation">-</span> ecs<span class="token punctuation">:</span>DeregisterTaskDefinition\n            <span class="token punctuation">-</span> ecs<span class="token punctuation">:</span>CreateService\n            <span class="token punctuation">-</span> iam<span class="token punctuation">:</span>*\n            <span class="token punctuation">-</span> logs<span class="token punctuation">:</span>CreateLogGroup\n            <span class="token punctuation">-</span> logs<span class="token punctuation">:</span>CreateLogStream\n            <span class="token punctuation">-</span> logs<span class="token punctuation">:</span>DescribeLogGroups\n            <span class="token punctuation">-</span> logs<span class="token punctuation">:</span>DeleteLogGroup\n            <span class="token punctuation">-</span> logs<span class="token punctuation">:</span>PutRetentionPolicy\n\n  <span class="token key atrule">CodeBuildServiceRole</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">"AWS::IAM::Role"</span>\n    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>\n      <span class="token key atrule">Path</span><span class="token punctuation">:</span> <span class="token string">"/"</span>\n      <span class="token key atrule">AssumeRolePolicyDocument</span><span class="token punctuation">:</span>\n        <span class="token key atrule">Statement</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow\n          <span class="token key atrule">Principal</span><span class="token punctuation">:</span>\n            <span class="token key atrule">Service</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> codebuild.amazonaws.com\n          <span class="token key atrule">Action</span><span class="token punctuation">:</span>\n          <span class="token punctuation">-</span> sts<span class="token punctuation">:</span>AssumeRole\n      <span class="token key atrule">Policies</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token key atrule">PolicyName</span><span class="token punctuation">:</span> CodeBuildAccess\n        <span class="token key atrule">PolicyDocument</span><span class="token punctuation">:</span>\n          <span class="token key atrule">Version</span><span class="token punctuation">:</span> <span class="token string">\'2012-10-17\'</span>\n          <span class="token key atrule">Statement</span><span class="token punctuation">:</span>\n          <span class="token punctuation">-</span> <span class="token key atrule">Resource</span><span class="token punctuation">:</span> <span class="token string">"*"</span>\n            <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow\n            <span class="token key atrule">Action</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> logs<span class="token punctuation">:</span>CreateLogGroup\n            <span class="token punctuation">-</span> logs<span class="token punctuation">:</span>CreateLogStream\n            <span class="token punctuation">-</span> logs<span class="token punctuation">:</span>PutLogEvents\n            <span class="token punctuation">-</span> ecr<span class="token punctuation">:</span>GetAuthorizationToken\n          <span class="token punctuation">-</span> <span class="token key atrule">Resource</span><span class="token punctuation">:</span> <span class="token tag">!Sub</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>s3<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>ArtifactBucket<span class="token punctuation">}</span>/*\n            <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow\n            <span class="token key atrule">Action</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> s3<span class="token punctuation">:</span>GetObject\n            <span class="token punctuation">-</span> s3<span class="token punctuation">:</span>PutObject\n            <span class="token punctuation">-</span> s3<span class="token punctuation">:</span>GetObjectVersion\n          <span class="token punctuation">-</span> <span class="token key atrule">Resource</span><span class="token punctuation">:</span> <span class="token tag">!Sub</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>ecr<span class="token punctuation">:</span>$<span class="token punctuation">{</span>AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>Region<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>AccountId<span class="token punctuation">}</span><span class="token punctuation">:</span>repository/$<span class="token punctuation">{</span>Repository<span class="token punctuation">}</span>\n            <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow\n            <span class="token key atrule">Action</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> ecr<span class="token punctuation">:</span>GetDownloadUrlForLayer\n            <span class="token punctuation">-</span> ecr<span class="token punctuation">:</span>BatchGetImage\n            <span class="token punctuation">-</span> ecr<span class="token punctuation">:</span>BatchCheckLayerAvailability\n            <span class="token punctuation">-</span> ecr<span class="token punctuation">:</span>PutImage\n            <span class="token punctuation">-</span> ecr<span class="token punctuation">:</span>InitiateLayerUpload\n            <span class="token punctuation">-</span> ecr<span class="token punctuation">:</span>UploadLayerPart\n            <span class="token punctuation">-</span> ecr<span class="token punctuation">:</span>CompleteLayerUpload\n      \n  <span class="token key atrule">CodePipelineServiceRole</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">"AWS::IAM::Role"</span>\n    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>\n      <span class="token key atrule">Path</span><span class="token punctuation">:</span> <span class="token string">"/"</span>\n      <span class="token key atrule">AssumeRolePolicyDocument</span><span class="token punctuation">:</span>\n        <span class="token key atrule">Statement</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow\n          <span class="token key atrule">Principal</span><span class="token punctuation">:</span>\n            <span class="token key atrule">Service</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> codepipeline.amazonaws.com\n          <span class="token key atrule">Action</span><span class="token punctuation">:</span>\n          <span class="token punctuation">-</span> sts<span class="token punctuation">:</span>AssumeRole\n      <span class="token key atrule">Policies</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token key atrule">PolicyName</span><span class="token punctuation">:</span> CodePipelineAccess\n        <span class="token key atrule">PolicyDocument</span><span class="token punctuation">:</span>\n          <span class="token key atrule">Version</span><span class="token punctuation">:</span> <span class="token string">\'2012-10-17\'</span>\n          <span class="token key atrule">Statement</span><span class="token punctuation">:</span>\n          <span class="token punctuation">-</span> <span class="token key atrule">Resource</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> <span class="token tag">!Sub</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>s3<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>ArtifactBucket<span class="token punctuation">}</span>/*\n            <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow\n            <span class="token key atrule">Action</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> s3<span class="token punctuation">:</span>PutObject\n            <span class="token punctuation">-</span> s3<span class="token punctuation">:</span>GetObject\n            <span class="token punctuation">-</span> s3<span class="token punctuation">:</span>GetObjectVersion\n            <span class="token punctuation">-</span> s3<span class="token punctuation">:</span>GetBucketVersioning\n          <span class="token punctuation">-</span> <span class="token key atrule">Resource</span><span class="token punctuation">:</span> <span class="token string">"*"</span>\n            <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow\n            <span class="token key atrule">Action</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> codebuild<span class="token punctuation">:</span>StartBuild\n            <span class="token punctuation">-</span> codebuild<span class="token punctuation">:</span>BatchGetBuilds\n            <span class="token punctuation">-</span> cloudformation<span class="token punctuation">:</span>CreateStack\n            <span class="token punctuation">-</span> cloudformation<span class="token punctuation">:</span>DeleteStack\n            <span class="token punctuation">-</span> cloudformation<span class="token punctuation">:</span>DescribeStack*\n            <span class="token punctuation">-</span> cloudformation<span class="token punctuation">:</span>UpdateStack\n            <span class="token punctuation">-</span> iam<span class="token punctuation">:</span>PassRole\n\n  <span class="token key atrule">ArtifactBucket</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">"AWS::S3::Bucket"</span>\n\n  <span class="token key atrule">CodeBuildProject</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">"AWS::CodeBuild::Project"</span>\n    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>\n      <span class="token key atrule">Artifacts</span><span class="token punctuation">:</span>\n        <span class="token key atrule">Location</span><span class="token punctuation">:</span>\n          <span class="token key atrule">Ref</span><span class="token punctuation">:</span> ArtifactBucket\n        <span class="token key atrule">Type</span><span class="token punctuation">:</span> S3\n      <span class="token key atrule">Source</span><span class="token punctuation">:</span>\n        <span class="token key atrule">Location</span><span class="token punctuation">:</span> <span class="token tag">!Sub</span> https<span class="token punctuation">:</span>//github.com/ticklesource/$<span class="token punctuation">{</span>RepoName<span class="token punctuation">}</span>.git\n        <span class="token key atrule">Type</span><span class="token punctuation">:</span> GITHUB\n      <span class="token key atrule">Environment</span><span class="token punctuation">:</span>\n        <span class="token key atrule">ComputeType</span><span class="token punctuation">:</span> BUILD_GENERAL1_LARGE\n        <span class="token key atrule">Image</span><span class="token punctuation">:</span> aws/codebuild/docker<span class="token punctuation">:</span>17.09.0\n        <span class="token key atrule">Type</span><span class="token punctuation">:</span> LINUX_CONTAINER\n        <span class="token comment"># PrivilegedMode: true</span>\n        <span class="token key atrule">EnvironmentVariables</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">Name</span><span class="token punctuation">:</span> AWS_DEFAULT_REGION\n          <span class="token key atrule">Value</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>Region\n        <span class="token punctuation">-</span> <span class="token key atrule">Name</span><span class="token punctuation">:</span> REPOSITORY_URI\n          <span class="token key atrule">Value</span><span class="token punctuation">:</span> <span class="token tag">!Sub</span> <span class="token string">"${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${Repository}"</span>\n      <span class="token key atrule">Name</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> ApplicationName\n      <span class="token key atrule">ServiceRole</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> CodeBuildServiceRole\n\n  <span class="token key atrule">Pipeline</span><span class="token punctuation">:</span>\n    <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">"AWS::CodePipeline::Pipeline"</span>\n    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>\n      <span class="token key atrule">Name</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> ApplicationName\n      <span class="token key atrule">RoleArn</span><span class="token punctuation">:</span>\n        <span class="token tag">!GetAtt</span>\n        <span class="token punctuation">-</span> CodePipelineServiceRole\n        <span class="token punctuation">-</span> Arn\n      <span class="token key atrule">ArtifactStore</span><span class="token punctuation">:</span>\n        <span class="token key atrule">Type</span><span class="token punctuation">:</span> S3\n        <span class="token key atrule">Location</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> ArtifactBucket\n      <span class="token key atrule">Stages</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token key atrule">Name</span><span class="token punctuation">:</span> Source\n        <span class="token key atrule">Actions</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">Name</span><span class="token punctuation">:</span> Source\n          <span class="token key atrule">ActionTypeId</span><span class="token punctuation">:</span>\n            <span class="token key atrule">Category</span><span class="token punctuation">:</span> Source\n            <span class="token key atrule">Owner</span><span class="token punctuation">:</span> ThirdParty\n            <span class="token key atrule">Version</span><span class="token punctuation">:</span> <span class="token number">1</span>\n            <span class="token key atrule">Provider</span><span class="token punctuation">:</span> GitHub\n          <span class="token key atrule">Configuration</span><span class="token punctuation">:</span>\n            <span class="token key atrule">Owner</span><span class="token punctuation">:</span> ktei\n            <span class="token key atrule">Repo</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> RepoName\n            <span class="token key atrule">Branch</span><span class="token punctuation">:</span> develop\n            <span class="token key atrule">OAuthToken</span><span class="token punctuation">:</span> your_github_oauth_token <span class="token comment"># create your own token</span>\n          <span class="token key atrule">OutputArtifacts</span><span class="token punctuation">:</span>\n          <span class="token punctuation">-</span> <span class="token key atrule">Name</span><span class="token punctuation">:</span> Source\n          <span class="token key atrule">RunOrder</span><span class="token punctuation">:</span> <span class="token number">1</span>\n      <span class="token punctuation">-</span> <span class="token key atrule">Name</span><span class="token punctuation">:</span> Build\n        <span class="token key atrule">Actions</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">Name</span><span class="token punctuation">:</span> Build\n          <span class="token key atrule">ActionTypeId</span><span class="token punctuation">:</span>\n            <span class="token key atrule">Category</span><span class="token punctuation">:</span> Build\n            <span class="token key atrule">Owner</span><span class="token punctuation">:</span> AWS\n            <span class="token key atrule">Version</span><span class="token punctuation">:</span> <span class="token number">1</span>\n            <span class="token key atrule">Provider</span><span class="token punctuation">:</span> CodeBuild\n          <span class="token key atrule">Configuration</span><span class="token punctuation">:</span>\n            <span class="token key atrule">ProjectName</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> CodeBuildProject\n          <span class="token key atrule">InputArtifacts</span><span class="token punctuation">:</span>\n          <span class="token punctuation">-</span> <span class="token key atrule">Name</span><span class="token punctuation">:</span> Source\n          <span class="token key atrule">OutputArtifacts</span><span class="token punctuation">:</span>\n          <span class="token punctuation">-</span> <span class="token key atrule">Name</span><span class="token punctuation">:</span> BuildOutput\n      <span class="token punctuation">-</span> <span class="token key atrule">Name</span><span class="token punctuation">:</span> Deploy\n        <span class="token key atrule">Actions</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">Name</span><span class="token punctuation">:</span> Deploy\n          <span class="token key atrule">ActionTypeId</span><span class="token punctuation">:</span>\n            <span class="token key atrule">Category</span><span class="token punctuation">:</span> Deploy\n            <span class="token key atrule">Owner</span><span class="token punctuation">:</span> AWS\n            <span class="token key atrule">Version</span><span class="token punctuation">:</span> <span class="token number">1</span>\n            <span class="token key atrule">Provider</span><span class="token punctuation">:</span> CloudFormation\n          <span class="token key atrule">Configuration</span><span class="token punctuation">:</span>\n            <span class="token key atrule">ChangeSetName</span><span class="token punctuation">:</span> Deploy\n            <span class="token key atrule">ActionMode</span><span class="token punctuation">:</span> CREATE_UPDATE\n            <span class="token key atrule">StackName</span><span class="token punctuation">:</span> <span class="token tag">!Sub</span> <span class="token string">"app-${ApplicationName}"</span>\n            <span class="token key atrule">Capabilities</span><span class="token punctuation">:</span> CAPABILITY_NAMED_IAM\n            <span class="token key atrule">TemplatePath</span><span class="token punctuation">:</span> BuildOutput<span class="token punctuation">:</span><span class="token punctuation">:</span>cfn/deploy.yml\n            <span class="token key atrule">RoleArn</span><span class="token punctuation">:</span> <span class="token tag">!GetAtt</span> <span class="token punctuation">[</span> CloudFormationExecutionRole<span class="token punctuation">,</span> Arn <span class="token punctuation">]</span>\n            <span class="token key atrule">ParameterOverrides</span><span class="token punctuation">:</span>\n              <span class="token key atrule">Fn::Sub</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>\n                <span class="token punctuation">{</span>\n                  <span class="token key atrule">"BaseImageName"</span><span class="token punctuation">:</span> <span class="token string">"${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${Repository}"</span><span class="token punctuation">,</span>\n                  <span class="token key atrule">"ImageTag"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                    <span class="token key atrule">"Fn::GetParam"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                      <span class="token string">"BuildOutput"</span><span class="token punctuation">,</span>\n                      <span class="token string">"build.json"</span><span class="token punctuation">,</span>\n                      <span class="token string">"tag"</span>\n                    <span class="token punctuation">]</span>\n                  <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n          <span class="token key atrule">InputArtifacts</span><span class="token punctuation">:</span>\n          <span class="token punctuation">-</span> <span class="token key atrule">Name</span><span class="token punctuation">:</span> BuildOutput\n</code></pre>\n      </div>\n<h2>Don’t forget Route53</h2>\n<p>After you build CICD, it’ll start the first build and deployment automatically. If it succeeds, you can access your website through <a href="https://your-aws-load-balancer-dns-name.aws.com/app">https://your-aws-load-balancer-dns-name.aws.com/app</a>. But this URL is too long to remember and most importantly, you won’t have SSL/TLS certificate to protect the ALB domain. However, if you have bought a domain then you should have at least one hosted zone in Route53 service. Go to that service page and create a new record set, where you should define an A record, for instance <code>www.mydomain.io</code>, pointing to your ALB domain name. Also, you need to use AWS Certificate Manager service to create an SSL/TLS certificate to protect <code>*.mydomain.io</code>. With all these set up, you can then browse <code>https://www.mydomain.io/app</code>.</p>\n<h2>Conclusion</h2>\n<p>From <a href="/build-your-aws-infrastructure-part-1/">Part 1</a> to this Part 2, I’ve showed you how I utilized AWS resources and CloudFomration to build a secure and highly available .NET core website running on AWS ECS within my own VPC. I believe that there’s a lot to digest here if you’re absolutely a beginner on AWS and .NET core. However, I still hope that this article will at least give you some ideas and maybe inspire you in areas such as programming, cloud or DevOps. I enjoyed the journey of doing so and I hope you will too!</p>',
frontmatter:{layout:"post",title:"Build your AWS infrastructure - Part 2",path:"/build-your-aws-infrastructure-part-2/",categories:["AWS","DevOps","CloudFormation","ECS","CodePipeline","CodeBuild",".NET Core"],date:"2018/01/10"}}},pathContext:{path:"/build-your-aws-infrastructure-part-2/"}}}});
//# sourceMappingURL=path---build-your-aws-infrastructure-part-2-763ff7cb1421757e31cc.js.map