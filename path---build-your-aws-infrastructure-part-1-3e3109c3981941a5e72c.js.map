{"version":3,"sources":["webpack:///path---build-your-aws-infrastructure-part-1-3e3109c3981941a5e72c.js","webpack:///./.cache/json/build-your-aws-infrastructure-part-1.json"],"names":["webpackJsonp","379","module","exports","data","site","meta","title","description","url","author","adsense","post","id","html","frontmatter","layout","path","categories","date","pathContext"],"mappings":"AAAAA,cAAc,iBAERC,IACA,SAAUC,EAAQC,GCHxBD,EAAAC,SAAkBC,MAAQC,MAAQC,MAAQC,MAAA,cAAAC,YAAA,mCAAAC,IAAA,+BAAAC,OAAA,YAAAC,QAAA,KAA+IC,MAASC,GAAA,+IAAAC,KAAA;AAAy+1FC,aAAyjBC,OAAA,OAAAT,MAAA,yCAAAU,KAAA,yCAAAC,YAAA,4DAAAC,KAAA,gBAAiNC,aAAgBH,KAAA","file":"path---build-your-aws-infrastructure-part-1-3e3109c3981941a5e72c.js","sourcesContent":["webpackJsonp([142854424372053],{\n\n/***/ 379:\n/***/ (function(module, exports) {\n\n\tmodule.exports = {\"data\":{\"site\":{\"meta\":{\"title\":\"DisasterDev\",\"description\":\"The blog of a disaster developer\",\"url\":\"https://blog.disasterdev.net\",\"author\":\"Rui Cheng\",\"adsense\":\"\"}},\"post\":{\"id\":\"/Users/rui/dev/ktei.github.io/src/pages/articles/2018-01-08-build-your-aws-infrastructure-part-1/index.md absPath of file >>> MarkdownRemark\",\"html\":\"<p>AWS is an enormous jungle. It has more than 50 services, the number of which keeps increasing every year. For beginners like myself, it’s pretty easy to get lost in this jungle. Thanks to my terrible memory, I think it’s useful for me to write down this blog to showcase how I built a simple AWS infrastructure using CloudFormation, and deployed a container on ECS, just in case I forget one day.</p>\\n<!--more-->\\n<p>First of all, I truly believe that <em>everything that can be automated should be automated</em>, so CloudFormation is going to be my main tool to provision the infrastructure. In fact, it’s one of the two services (another is AWS Lambda) that really got me into AWS.</p>\\n<p>So what I built here is a simple cloud infrastructure in which there’re VPC, subnets, load balancer, ECS clusters so on so forth. This infrastructure allows you to deploy containers on ECS clusters which is secure to some extent, and highly available.</p>\\n<p>In short, here is a poorly drawn diagram to illustrate what I built in a high level. I used <a href=\\\"https://www.draw.io/\\\">draw.io</a> to draw this and it actually costed me some effort so don’t you judge it!</p>\\n\\n  <span class=\\\"gatsby-resp-image-wrapper\\\" style=\\\"position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 722px; margin-left: auto; margin-right: auto;\\\">\\n    <span class=\\\"gatsby-resp-image-background-image\\\" style=\\\"padding-bottom: 100.13850415512466%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAChUlEQVQ4y5VUS2/TQBDOX+VKz0hckDgiIY49gFQQ4nEo5YKqitJSECqCJhUtEkIkUIkkjb21Ha9f63Wc2B87W6/TPCBipNE+PP72m5lvt4EVNh6PcXF6AOtoG6PRaFU4GkXkYvx9H0mSLLjv+2CMIXl6HeLRNT0fDodLY8npwIbz8yuSkx0EZydIW1v6B+OWZemRHW6iv/dwZm/e0zRFFEVoEAtfbUirjezHBxTOL+SHGyjzFFJEapTwTlUGZ8co1DyNOMrxCPnRc0z6p/o7rUM+vGTY6/X0ppQSuVDpsw7C7Tvo97o6gL6dN3fh79+HjAPEgQsRc/hv1hG3PyEMQ107iguCoAJUJxBd+8sDvWnbNvx2E9y1kYkYZVGAWQMEQw+scwCvewTHcXRswH0NShhTwArd8zwdGLsDyGdryI+3EHgXmIQOxEVXsZvWzHVdyPeK9Ysb+t8FhrQwRql2P+9gyM4VKxfZ67uQr24jCbmWkTHn20f83nusD1jK8KqRDMiIodc+Bu804bHBDGChSiGEWM2QjJqkARVDM/ccNgNo4jTgPEPO+WWRK6da0p4I/Row8l1d5/k4kt4CQ127hOmR0jDXjL4ZQJlEmGTKc6GFTPtlWdZxMwyp9fbJRn0qjcSQtGcAE9Vl1nmnZNOayqbyBYbUKSMbYmhsvoaUnomrY5bV0DSlYG3wl7dQji5BuctqQLfqcpnFCJ6sYeL3p4B/63IhY8RbN5G1NvXa6ne1PLTu7AqwmEC8XUe6e281wyzLdEpXdWiMboqRDd0USv+fDOedmpLGYQ2YS7EgGxNXM6RmcFX4cpxVPpod1TNmzDxVZZ4tjPXzRYB5ni9l+D9OYKSOP0B58Dc2a6c9AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\\\">\\n      <img class=\\\"gatsby-resp-image-image\\\" style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\" alt=\\\"Infrastructure\\\" title=\\\"\\\" src=\\\"/static/infrastructure-8f75cbdb4a671c074a696017b5aeb1af-5ba46.png\\\" srcset=\\\"/static/infrastructure-8f75cbdb4a671c074a696017b5aeb1af-584f6.png 188w,\\n/static/infrastructure-8f75cbdb4a671c074a696017b5aeb1af-a48bd.png 375w,\\n/static/infrastructure-8f75cbdb4a671c074a696017b5aeb1af-5ba46.png 722w\\\" sizes=\\\"(max-width: 722px) 100vw, 722px\\\">\\n    </span>\\n  </span>\\n  \\n<h2>Infrastructure</h2>\\n<p>To make my infrastructure highly availalbe, I choose to use 2 available zones - which I’ll call AZ1 and AZ2 just for simplicity. I divide each zone into 3 subnets, although from the diagram you can only see 2.</p>\\n<h3>Public subnet</h3>\\n<p>The Internet facing subnet (my <a href=\\\"https://en.wikipedia.org/wiki/DMZ_(computing)\\\">DMZ</a>), which I call public subnet is where I put things like <em>jumpbox</em> or <em>NAT gateway</em>. Any EC2 instance I deploy in this subnet will automatically have an assigned public IP, which means if I open port 22 through its security groups, I can SSH to the terminal from the Internet. As you can imagine, this is not a good place for your application servers, as this is the front line between the evil world and your happy private paradise, so we need to leave our servers and databases out of this area. However, this is the right place for everything that should be public facing, such as NAT gateway.</p>\\n<h3>Service subnet</h3>\\n<p>This is where I deploy my ECS clusters. The idea is that only load balancer can forward the requests from public subnets to these clusters, so all I need to do is to allow ALB (application load balancer) to hit the clusters. I can achieve this by creating a security group for ALB to listen to Internet requests on port 443, and then attaching a security group on clusters, which grants the inbound access for instances belonging to ALB security group, which is the ALB itself.</p>\\n<p>Another caveat I encountered was that to register EC2 instances to a ECS cluster, those instances need to have public IPs. If you think about it, instances in private subnets don’t have public IPs, so that seems like a conflict now? Not really, because you can put a NAT gateway - well, technically 2 for high availability - in public subnets, and then add a route <em>0.0.0.0/0->NAT</em> for the instances, so outgoing traffic will all go through the NAT gateway, which will translate their private IPs into public IPs, so that ECS agents can work properly.</p>\\n<h3>Application load balancer</h3>\\n<p>There’s not much to say about this but do understand one thing, that the traffic between the ALB and the ECS clusters may or may not be secure, which is totally up to how you implement your services. You can force the HTTP encryption between ALB and ECS, but that requires your web server - kestrel (.NET Core) for example - to be able to decrypt the traffic, given the SSL/TLS certificate. However, if your application server cannot decrypt it, then you can’t encrypt the traffic, otherwise nothing works.</p>\\n<h3>Data subnet</h3>\\n<p>This is something I left for future. At the moment I’m not planning to run any RDS (they’re indeed way more expensive than small EC2 instances). But as the name suggests, this is where you put data servers. ALB should not have access to this area. In fact, this subnet should be mostly protected as it’s the place for your data, which has not public facing responsibility. If somehow this area is compromised, you’ll be in trouble.</p>\\n<h3>Spot instance</h3>\\n<p>I chose to run spot instances for ECS clusters, as they’re way cheaper than on-demand instances. Beause I’m not running any commercial website, I can just put a very low bid price there hoping that the price will always be slightly higher than spot instance price, which will keep all my instances running. In fact, I use spot instances in my company for test environment and the website went down ever since. It makes a lot sense to do this especially when you run small business or startup, in which you want to save every cent of your money but also enjoy the power that AWS brings to you, so spot instance is a fine choice fro you.</p>\\n<h2>CloudFormation</h2>\\n<p>So far you should understand the infrastructure from a high level. Now it’s time to build it. With CloudFormation, I can deploy the whole infrastructure without endless cliking in AWS console, so here’re the templates I used to provision my infrastructure. You can read them and reuse them or roll your own, so let’s have a look.</p>\\n<p>With the CloudFormation templates below, I built the infrastructure depicted in the diagram. If you want to reuse them, make sure you run them in such correct sequence and use the stack name I provided here:</p>\\n<ul>\\n<li>infra-vpc</li>\\n<li>infra-sgs</li>\\n<li>infra-alb</li>\\n<li>infra-ecs-cluster</li>\\n</ul>\\n<h3>VPC - (infra-vpc)</h3>\\n<p>This template built VPC where 6 subnets (public subnets, service subnets and data subnets) exist. I added a parameter <code>EnableNat</code> which controls whether or not I build NAT gateways as I don’t want to run NAT gateways for personal AWS account - it costs money!</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2010-09-09</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> VPC and subnets\\n\\n<span class=\\\"token key atrule\\\">Parameters</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">VpcCidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for VPC\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.61.0/22\\n\\n  <span class=\\\"token key atrule\\\">EnableNat</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Whether to create NAT gateways for private subnets\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">false</span>\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for public subnet 1\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.61.0/26\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for public subnet 2\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.61.64/26\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for service (private) subnet 1\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.62.0/26\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for service (private) subnet 2\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.62.64/26\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for data (private) subnet 1\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.63.0/26\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for data (private) subnet 2\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.63.64/26\\n\\n<span class=\\\"token key atrule\\\">Conditions</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">EnableNat</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Equals</span> <span class=\\\"token punctuation\\\">[</span> <span class=\\\"token tag\\\">!Ref</span> EnableNat<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"true\\\"</span> <span class=\\\"token punctuation\\\">]</span>\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Vpc</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VPC\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> VpcCidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Vpc\\n\\n  <span class=\\\"token key atrule\\\">InternetGateway</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>InternetGateway\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>InternetGateway\\n\\n  <span class=\\\"token key atrule\\\">InternetGatewayVpcAttachment</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VPCGatewayAttachment\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">InternetGatewayId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> InternetGateway\\n\\n  <span class=\\\"token key atrule\\\">NatGatewayAz1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>NatGateway\\n    <span class=\\\"token key atrule\\\">Condition</span><span class=\\\"token punctuation\\\">:</span> EnableNat\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span> InternetGatewayVpcAttachment\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AllocationId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> NatEipAz1.AllocationId\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1\\n\\n  <span class=\\\"token key atrule\\\">NatEipAz1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EIP\\n    <span class=\\\"token key atrule\\\">Condition</span><span class=\\\"token punctuation\\\">:</span> EnableNat\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span> InternetGatewayVpcAttachment\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Domain</span><span class=\\\"token punctuation\\\">:</span> vpc\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">0</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1Cidr\\n      <span class=\\\"token key atrule\\\">MapPublicIpOnLaunch</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">1</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet2Cidr\\n      <span class=\\\"token key atrule\\\">MapPublicIpOnLaunch</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnetsRouteTable</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>RouteTable\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnetsRouteTable\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet1Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet2\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnetsInternetGatewayRoute</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Route\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span> InternetGatewayVpcAttachment\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">DestinationCidrBlock</span><span class=\\\"token punctuation\\\">:</span> 0.0.0.0/0\\n      <span class=\\\"token key atrule\\\">GatewayId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> InternetGateway    \\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">0</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet1Cidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet1\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">1</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet2Cidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet2\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnetsRouteTable</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>RouteTable\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnetsRouteTable\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet1\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet2\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnetsNatGatewayAz1Route</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Route\\n    <span class=\\\"token key atrule\\\">Condition</span><span class=\\\"token punctuation\\\">:</span> EnableNat\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">DestinationCidrBlock</span><span class=\\\"token punctuation\\\">:</span> 0.0.0.0/0\\n      <span class=\\\"token key atrule\\\">NatGatewayId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> NatGatewayAz1\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">0</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet1Cidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet1\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">1</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet2Cidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet2\\n\\n  <span class=\\\"token key atrule\\\">DataSubnetsRouteTable</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>RouteTable\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnetsRouteTable\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet1\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet2\\n\\n  <span class=\\\"token key atrule\\\">DataSubnetsNatGatewayAz1Route</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Route\\n    <span class=\\\"token key atrule\\\">Condition</span><span class=\\\"token punctuation\\\">:</span> EnableNat\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">DestinationCidrBlock</span><span class=\\\"token punctuation\\\">:</span> 0.0.0.0/0\\n      <span class=\\\"token key atrule\\\">NatGatewayId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> NatGatewayAz1\\n\\n<span class=\\\"token key atrule\\\">Outputs</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> VPC ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n\\n  <span class=\\\"token key atrule\\\">VpcCidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> VPC CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> VpcCidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcCidr\\n  \\n  <span class=\\\"token key atrule\\\">PublicSubnet1Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Public subnet 1 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1Id\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Public subnet 1 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1Cidr\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Public subnet 2 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet2\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2Id\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Public subnet 2 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet2Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2Cidr\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Service subnet 1 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet1\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet1Id\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Service subnet 1 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet1Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet1Cidr\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Service subnet 2 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet2\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet2Id\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Service subnet 2 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet2Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet2Cidr\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Data subnet 1 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet1\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet1Id\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Data subnet 1 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet1Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet1Cidr\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Data subnet 2 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet2\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet2Id\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Data subnet 2 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet2Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet2Cidr\\n</code></pre>\\n      </div>\\n<h3>Shared security groups - (infra-sgs)</h3>\\n<p>I usually define some shared security groups for other resources to share.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2010-09-09</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Shared security groups\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">DefaultIngressSg</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SecurityGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">GroupDescription</span><span class=\\\"token punctuation\\\">:</span> SSH access across the VPC\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n      <span class=\\\"token key atrule\\\">SecurityGroupIngress</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> icmp\\n          <span class=\\\"token key atrule\\\">FromPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">8</span>\\n          <span class=\\\"token key atrule\\\">ToPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">8</span>\\n          <span class=\\\"token key atrule\\\">CidrIp</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcCidr\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> tcp\\n          <span class=\\\"token key atrule\\\">FromPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">22</span>\\n          <span class=\\\"token key atrule\\\">ToPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">22</span>\\n          <span class=\\\"token key atrule\\\">CidrIp</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcCidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DefaultIngressSg\\n\\n<span class=\\\"token key atrule\\\">Outputs</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">DefaultIngressSgId</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Default ingress security group id\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DefaultIngressSg\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DefaultIngressSgId\\n</code></pre>\\n      </div>\\n<h3>ALB - (infra-alb)</h3>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2010-09-09</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Application load balancer\\n\\n<span class=\\\"token key atrule\\\">Parameters</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">CertificateArn</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The ARN of the SSL/TLS certificate for ALB port 443 listener\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>acm<span class=\\\"token punctuation\\\">:</span>ap<span class=\\\"token punctuation\\\">-</span>southeast<span class=\\\"token punctuation\\\">-</span>2<span class=\\\"token punctuation\\\">:</span>504224764639<span class=\\\"token punctuation\\\">:</span>certificate/ce5a2456<span class=\\\"token punctuation\\\">-</span>f97b<span class=\\\"token punctuation\\\">-</span>49ed<span class=\\\"token punctuation\\\">-</span>91fd<span class=\\\"token punctuation\\\">-</span>323b0e290fb8\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">LoadBalancer</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ElasticLoadBalancingV2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancer\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Subnets</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1Id\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2Id\\n      <span class=\\\"token key atrule\\\">SecurityGroups</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!Ref</span> LoadBalancerSg\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancer\\n\\n  <span class=\\\"token key atrule\\\">LoadBalancerSg</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SecurityGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">GroupDescription</span><span class=\\\"token punctuation\\\">:</span> Public access to ALB\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n      <span class=\\\"token key atrule\\\">SecurityGroupIngress</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">CidrIp</span><span class=\\\"token punctuation\\\">:</span> 0.0.0.0/0\\n          <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> tcp\\n          <span class=\\\"token key atrule\\\">FromPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">443</span>\\n          <span class=\\\"token key atrule\\\">ToPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">443</span>\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerSg\\n  \\n  <span class=\\\"token comment\\\"># We're not going to use the default group but we need this to create ALB</span>\\n  <span class=\\\"token key atrule\\\">DefaultTargetGroup</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ElasticLoadBalancingV2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>TargetGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Port</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">80</span>\\n      <span class=\\\"token key atrule\\\">Protocol</span><span class=\\\"token punctuation\\\">:</span> HTTP\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DefaultTargetGroup\\n\\n  <span class=\\\"token key atrule\\\">LoadBalancerListener</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ElasticLoadBalancingV2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Listener\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">LoadBalancerArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> LoadBalancer\\n      <span class=\\\"token key atrule\\\">Port</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">443</span>\\n      <span class=\\\"token key atrule\\\">Protocol</span><span class=\\\"token punctuation\\\">:</span> HTTPS\\n      <span class=\\\"token key atrule\\\">Certificates</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">CertificateArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> CertificateArn\\n      <span class=\\\"token key atrule\\\">DefaultActions</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">TargetGroupArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DefaultTargetGroup\\n          <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> forward\\n\\n<span class=\\\"token key atrule\\\">Outputs</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">LoadBalancerListenerArn</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> LoadBalancerListener\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerListenerArn\\n\\n  <span class=\\\"token key atrule\\\">LoadBalancerSgId</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> LoadBalancerSg\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerSgId\\n</code></pre>\\n      </div>\\n<h3>ECS cluster (infra-ecs-cluster)</h3>\\n<p>Here’s the how I provisioned an ECS cluster based on a spot fleet request. Notice that here I put EC2 instances in public subnets, which is not best practice in terms of security, but it saves me money as otherwise I need to put NAT gateways in public subnets so that my EC2 instances in private subnets can have public IPs for ECS agents to talk to ECS service.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2010-09-09</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> ECS cluster of spot fleet\\n\\n<span class=\\\"token key atrule\\\">Parameters</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">ClusterName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Name of the ECS cluster\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> ApplicationCluster\\n\\n  <span class=\\\"token key atrule\\\">TargetCapacity</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> Number\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> How many EC2 instances do we want\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1 </span><span class=\\\"token comment\\\"># HA needs at least 2</span>\\n\\n  <span class=\\\"token key atrule\\\">InstanceType</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedValues</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> t2.micro\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> EC2 instance type to use for ECS cluster\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> t2.micro\\n\\n  <span class=\\\"token key atrule\\\">KeyName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>KeyPair<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>KeyName\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Name of an existing EC2 KeyPair to enable SSH access to the EC2 instances\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> default<span class=\\\"token punctuation\\\">-</span>keypair\\n\\n  <span class=\\\"token key atrule\\\">SpotBidPrice</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Maximum price that you are willing to pay per hour per instance\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">0.0035</span>\\n\\n<span class=\\\"token key atrule\\\">Mappings</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">AWSRegionToECSAMI</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">ap-northeast-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>af46dbc9\\n    <span class=\\\"token key atrule\\\">ap-southeast-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>fec3b482\\n    <span class=\\\"token key atrule\\\">ap-southeast-2</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>b88e7cda\\n    <span class=\\\"token key atrule\\\">ca-central-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>e8cb4e8c\\n    <span class=\\\"token key atrule\\\">eu-central-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>b378e8dc\\n    <span class=\\\"token key atrule\\\">eu-west-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>7827b301\\n    <span class=\\\"token key atrule\\\">eu-west-2</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>acd5cdc8\\n    <span class=\\\"token key atrule\\\">us-east-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span><span class=\\\"token number\\\">13401669</span>\\n    <span class=\\\"token key atrule\\\">us-east-2</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>901338f5\\n    <span class=\\\"token key atrule\\\">us-west-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>b3adacd3\\n    <span class=\\\"token key atrule\\\">us-west-2</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>9a02a9e2\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">EcsCluster</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ECS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Cluster\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">ClusterName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ClusterName\\n\\n  <span class=\\\"token key atrule\\\">EcsHostSg</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SecurityGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n      <span class=\\\"token key atrule\\\">GroupDescription</span><span class=\\\"token punctuation\\\">:</span> Access to the ECS hosts and the tasks/containers that run on them\\n      <span class=\\\"token key atrule\\\">SecurityGroupIngress</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token comment\\\"># allow free access for ALB</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"-1\\\"</span>\\n          <span class=\\\"token key atrule\\\">SourceSecurityGroupId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>alb<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerSgId\\n        <span class=\\\"token comment\\\"># SSH for jumpbox</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> tcp\\n          <span class=\\\"token key atrule\\\">FromPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">22</span>\\n          <span class=\\\"token key atrule\\\">ToPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">22</span>\\n          <span class=\\\"token key atrule\\\">CidrIp</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcCidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EcsHostSg\\n\\n  <span class=\\\"token key atrule\\\">SpotFleet</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SpotFleet\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> SpotFleetRole\\n      <span class=\\\"token punctuation\\\">-</span> SpotFleetInstanceProfile\\n      <span class=\\\"token punctuation\\\">-</span> EcsHostSg\\n      <span class=\\\"token punctuation\\\">-</span> EcsCluster\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">SpotFleetRequestConfigData</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">AllocationStrategy</span><span class=\\\"token punctuation\\\">:</span> lowestPrice\\n        <span class=\\\"token key atrule\\\">IamFleetRole</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> SpotFleetRole.Arn\\n        <span class=\\\"token key atrule\\\">LaunchSpecifications</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IamInstanceProfile</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Arn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> SpotFleetInstanceProfile.Arn\\n            <span class=\\\"token key atrule\\\">ImageId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!FindInMap</span> <span class=\\\"token punctuation\\\">[</span>AWSRegionToECSAMI<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">\\\"AWS::Region\\\"</span><span class=\\\"token punctuation\\\">,</span> AMI<span class=\\\"token punctuation\\\">]</span>\\n            <span class=\\\"token key atrule\\\">InstanceType</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> InstanceType\\n            <span class=\\\"token key atrule\\\">KeyName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> KeyName\\n            <span class=\\\"token key atrule\\\">Monitoring</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Enabled</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n            <span class=\\\"token key atrule\\\">SecurityGroups</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">GroupId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> EcsHostSg\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">GroupId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>sgs<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DefaultIngressSgId\\n\\n            <span class=\\\"token comment\\\"># EC2 instances need to have public IPs to register ECS:</span>\\n            <span class=\\\"token comment\\\"># https://stackoverflow.com/questions/31036600/why-cant-my-ecs-service-register-available-ec2-instances-with-my-elb</span>\\n            <span class=\\\"token comment\\\"># I can either use public subnets, which is not best security practice, but it saves</span>\\n            <span class=\\\"token comment\\\"># me money from running NAT gateways.</span>\\n            <span class=\\\"token comment\\\"># Or, I can use service subnets, which is better practice, but I need to run NAT gateways.</span>\\n            <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Join</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">','</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1Id\\n                <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2Id\\n\\n            <span class=\\\"token key atrule\\\">UserData</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">\\\"Fn::Base64\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> <span class=\\\"token punctuation\\\">|</span><span class=\\\"token scalar string\\\">\\n                #!/bin/bash\\n                yum install -y aws-cfn-bootstrap\\n                echo ECS_CLUSTER=${EcsCluster} >> /etc/ecs/ecs.config</span>\\n        <span class=\\\"token key atrule\\\">SpotPrice</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> SpotBidPrice\\n        <span class=\\\"token key atrule\\\">TargetCapacity</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> TargetCapacity\\n        <span class=\\\"token key atrule\\\">TerminateInstancesWithExpiration</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n\\n  <span class=\\\"token key atrule\\\">SpotFleetInstanceProfile</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>IAM<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>InstanceProfile\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> SpotFleetInstanceRole\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> /\\n      <span class=\\\"token key atrule\\\">Roles</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Ref</span><span class=\\\"token punctuation\\\">:</span> SpotFleetInstanceRole\\n\\n  <span class=\\\"token key atrule\\\">SpotFleetInstanceRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>IAM<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Role\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2012-10-17</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> ec2.amazonaws.com\\n      <span class=\\\"token key atrule\\\">ManagedPolicyArns</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>iam<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>policy/service<span class=\\\"token punctuation\\\">-</span>role/AmazonEC2ContainerServiceforEC2Role\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> /\\n\\n  <span class=\\\"token key atrule\\\">SpotFleetRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>IAM<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Role\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2012-10-17</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> spotfleet.amazonaws.com\\n      <span class=\\\"token key atrule\\\">ManagedPolicyArns</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>iam<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>policy/service<span class=\\\"token punctuation\\\">-</span>role/AmazonEC2SpotFleetRole\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> /\\n\\n<span class=\\\"token key atrule\\\">Outputs</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">EcsClusterName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ClusterName\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EcsClusterName\\n</code></pre>\\n      </div>\\n<h2>Conclusion</h2>\\n<p>This is not the final conclusion yet, but so far you can basically understand what I built and why I built in such way. Also, by reading these boring CloudFormation templates (to prove that your life is probably as boring as mine), you’ll have an even better understanding about AWS infrastructure and its automation. Anyway, this is part 1 and now let’s take a break and to be continued…</p>\",\"frontmatter\":{\"layout\":\"post\",\"title\":\"Build your AWS infrastructure - Part 1\",\"path\":\"/build-your-aws-infrastructure-part-1/\",\"categories\":[\"AWS\",\"DevOps\",\"CloudFormation\",\"VPC\",\"ECS\",\"SpotInstance\"],\"date\":\"2018/01/08\"}}},\"pathContext\":{\"path\":\"/build-your-aws-infrastructure-part-1/\"}}\n\n/***/ })\n\n});\n\n\n// WEBPACK FOOTER //\n// path---build-your-aws-infrastructure-part-1-3e3109c3981941a5e72c.js","module.exports = {\"data\":{\"site\":{\"meta\":{\"title\":\"DisasterDev\",\"description\":\"The blog of a disaster developer\",\"url\":\"https://blog.disasterdev.net\",\"author\":\"Rui Cheng\",\"adsense\":\"\"}},\"post\":{\"id\":\"/Users/rui/dev/ktei.github.io/src/pages/articles/2018-01-08-build-your-aws-infrastructure-part-1/index.md absPath of file >>> MarkdownRemark\",\"html\":\"<p>AWS is an enormous jungle. It has more than 50 services, the number of which keeps increasing every year. For beginners like myself, it’s pretty easy to get lost in this jungle. Thanks to my terrible memory, I think it’s useful for me to write down this blog to showcase how I built a simple AWS infrastructure using CloudFormation, and deployed a container on ECS, just in case I forget one day.</p>\\n<!--more-->\\n<p>First of all, I truly believe that <em>everything that can be automated should be automated</em>, so CloudFormation is going to be my main tool to provision the infrastructure. In fact, it’s one of the two services (another is AWS Lambda) that really got me into AWS.</p>\\n<p>So what I built here is a simple cloud infrastructure in which there’re VPC, subnets, load balancer, ECS clusters so on so forth. This infrastructure allows you to deploy containers on ECS clusters which is secure to some extent, and highly available.</p>\\n<p>In short, here is a poorly drawn diagram to illustrate what I built in a high level. I used <a href=\\\"https://www.draw.io/\\\">draw.io</a> to draw this and it actually costed me some effort so don’t you judge it!</p>\\n\\n  <span class=\\\"gatsby-resp-image-wrapper\\\" style=\\\"position: relative; display: block; margin-bottom: 1.0725rem;; max-width: 722px; margin-left: auto; margin-right: auto;\\\">\\n    <span class=\\\"gatsby-resp-image-background-image\\\" style=\\\"padding-bottom: 100.13850415512466%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAChUlEQVQ4y5VUS2/TQBDOX+VKz0hckDgiIY49gFQQ4nEo5YKqitJSECqCJhUtEkIkUIkkjb21Ha9f63Wc2B87W6/TPCBipNE+PP72m5lvt4EVNh6PcXF6AOtoG6PRaFU4GkXkYvx9H0mSLLjv+2CMIXl6HeLRNT0fDodLY8npwIbz8yuSkx0EZydIW1v6B+OWZemRHW6iv/dwZm/e0zRFFEVoEAtfbUirjezHBxTOL+SHGyjzFFJEapTwTlUGZ8co1DyNOMrxCPnRc0z6p/o7rUM+vGTY6/X0ppQSuVDpsw7C7Tvo97o6gL6dN3fh79+HjAPEgQsRc/hv1hG3PyEMQ107iguCoAJUJxBd+8sDvWnbNvx2E9y1kYkYZVGAWQMEQw+scwCvewTHcXRswH0NShhTwArd8zwdGLsDyGdryI+3EHgXmIQOxEVXsZvWzHVdyPeK9Ysb+t8FhrQwRql2P+9gyM4VKxfZ67uQr24jCbmWkTHn20f83nusD1jK8KqRDMiIodc+Bu804bHBDGChSiGEWM2QjJqkARVDM/ccNgNo4jTgPEPO+WWRK6da0p4I/Row8l1d5/k4kt4CQ127hOmR0jDXjL4ZQJlEmGTKc6GFTPtlWdZxMwyp9fbJRn0qjcSQtGcAE9Vl1nmnZNOayqbyBYbUKSMbYmhsvoaUnomrY5bV0DSlYG3wl7dQji5BuctqQLfqcpnFCJ6sYeL3p4B/63IhY8RbN5G1NvXa6ne1PLTu7AqwmEC8XUe6e281wyzLdEpXdWiMboqRDd0USv+fDOedmpLGYQ2YS7EgGxNXM6RmcFX4cpxVPpod1TNmzDxVZZ4tjPXzRYB5ni9l+D9OYKSOP0B58Dc2a6c9AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\\\">\\n      <img class=\\\"gatsby-resp-image-image\\\" style=\\\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\\\" alt=\\\"Infrastructure\\\" title=\\\"\\\" src=\\\"/static/infrastructure-8f75cbdb4a671c074a696017b5aeb1af-5ba46.png\\\" srcset=\\\"/static/infrastructure-8f75cbdb4a671c074a696017b5aeb1af-584f6.png 188w,\\n/static/infrastructure-8f75cbdb4a671c074a696017b5aeb1af-a48bd.png 375w,\\n/static/infrastructure-8f75cbdb4a671c074a696017b5aeb1af-5ba46.png 722w\\\" sizes=\\\"(max-width: 722px) 100vw, 722px\\\">\\n    </span>\\n  </span>\\n  \\n<h2>Infrastructure</h2>\\n<p>To make my infrastructure highly availalbe, I choose to use 2 available zones - which I’ll call AZ1 and AZ2 just for simplicity. I divide each zone into 3 subnets, although from the diagram you can only see 2.</p>\\n<h3>Public subnet</h3>\\n<p>The Internet facing subnet (my <a href=\\\"https://en.wikipedia.org/wiki/DMZ_(computing)\\\">DMZ</a>), which I call public subnet is where I put things like <em>jumpbox</em> or <em>NAT gateway</em>. Any EC2 instance I deploy in this subnet will automatically have an assigned public IP, which means if I open port 22 through its security groups, I can SSH to the terminal from the Internet. As you can imagine, this is not a good place for your application servers, as this is the front line between the evil world and your happy private paradise, so we need to leave our servers and databases out of this area. However, this is the right place for everything that should be public facing, such as NAT gateway.</p>\\n<h3>Service subnet</h3>\\n<p>This is where I deploy my ECS clusters. The idea is that only load balancer can forward the requests from public subnets to these clusters, so all I need to do is to allow ALB (application load balancer) to hit the clusters. I can achieve this by creating a security group for ALB to listen to Internet requests on port 443, and then attaching a security group on clusters, which grants the inbound access for instances belonging to ALB security group, which is the ALB itself.</p>\\n<p>Another caveat I encountered was that to register EC2 instances to a ECS cluster, those instances need to have public IPs. If you think about it, instances in private subnets don’t have public IPs, so that seems like a conflict now? Not really, because you can put a NAT gateway - well, technically 2 for high availability - in public subnets, and then add a route <em>0.0.0.0/0->NAT</em> for the instances, so outgoing traffic will all go through the NAT gateway, which will translate their private IPs into public IPs, so that ECS agents can work properly.</p>\\n<h3>Application load balancer</h3>\\n<p>There’s not much to say about this but do understand one thing, that the traffic between the ALB and the ECS clusters may or may not be secure, which is totally up to how you implement your services. You can force the HTTP encryption between ALB and ECS, but that requires your web server - kestrel (.NET Core) for example - to be able to decrypt the traffic, given the SSL/TLS certificate. However, if your application server cannot decrypt it, then you can’t encrypt the traffic, otherwise nothing works.</p>\\n<h3>Data subnet</h3>\\n<p>This is something I left for future. At the moment I’m not planning to run any RDS (they’re indeed way more expensive than small EC2 instances). But as the name suggests, this is where you put data servers. ALB should not have access to this area. In fact, this subnet should be mostly protected as it’s the place for your data, which has not public facing responsibility. If somehow this area is compromised, you’ll be in trouble.</p>\\n<h3>Spot instance</h3>\\n<p>I chose to run spot instances for ECS clusters, as they’re way cheaper than on-demand instances. Beause I’m not running any commercial website, I can just put a very low bid price there hoping that the price will always be slightly higher than spot instance price, which will keep all my instances running. In fact, I use spot instances in my company for test environment and the website went down ever since. It makes a lot sense to do this especially when you run small business or startup, in which you want to save every cent of your money but also enjoy the power that AWS brings to you, so spot instance is a fine choice fro you.</p>\\n<h2>CloudFormation</h2>\\n<p>So far you should understand the infrastructure from a high level. Now it’s time to build it. With CloudFormation, I can deploy the whole infrastructure without endless cliking in AWS console, so here’re the templates I used to provision my infrastructure. You can read them and reuse them or roll your own, so let’s have a look.</p>\\n<p>With the CloudFormation templates below, I built the infrastructure depicted in the diagram. If you want to reuse them, make sure you run them in such correct sequence and use the stack name I provided here:</p>\\n<ul>\\n<li>infra-vpc</li>\\n<li>infra-sgs</li>\\n<li>infra-alb</li>\\n<li>infra-ecs-cluster</li>\\n</ul>\\n<h3>VPC - (infra-vpc)</h3>\\n<p>This template built VPC where 6 subnets (public subnets, service subnets and data subnets) exist. I added a parameter <code>EnableNat</code> which controls whether or not I build NAT gateways as I don’t want to run NAT gateways for personal AWS account - it costs money!</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2010-09-09</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> VPC and subnets\\n\\n<span class=\\\"token key atrule\\\">Parameters</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">VpcCidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for VPC\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.61.0/22\\n\\n  <span class=\\\"token key atrule\\\">EnableNat</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Whether to create NAT gateways for private subnets\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">false</span>\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for public subnet 1\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.61.0/26\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for public subnet 2\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.61.64/26\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for service (private) subnet 1\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.62.0/26\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for service (private) subnet 2\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.62.64/26\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for data (private) subnet 1\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.63.0/26\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedPattern</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\/(?:2[0-8]|1[6-9])$'</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> CIDR for data (private) subnet 2\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> 10.0.63.64/26\\n\\n<span class=\\\"token key atrule\\\">Conditions</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">EnableNat</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Equals</span> <span class=\\\"token punctuation\\\">[</span> <span class=\\\"token tag\\\">!Ref</span> EnableNat<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token string\\\">\\\"true\\\"</span> <span class=\\\"token punctuation\\\">]</span>\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">Vpc</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VPC\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> VpcCidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Vpc\\n\\n  <span class=\\\"token key atrule\\\">InternetGateway</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>InternetGateway\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>InternetGateway\\n\\n  <span class=\\\"token key atrule\\\">InternetGatewayVpcAttachment</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VPCGatewayAttachment\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">InternetGatewayId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> InternetGateway\\n\\n  <span class=\\\"token key atrule\\\">NatGatewayAz1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>NatGateway\\n    <span class=\\\"token key atrule\\\">Condition</span><span class=\\\"token punctuation\\\">:</span> EnableNat\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span> InternetGatewayVpcAttachment\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AllocationId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> NatEipAz1.AllocationId\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1\\n\\n  <span class=\\\"token key atrule\\\">NatEipAz1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EIP\\n    <span class=\\\"token key atrule\\\">Condition</span><span class=\\\"token punctuation\\\">:</span> EnableNat\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span> InternetGatewayVpcAttachment\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Domain</span><span class=\\\"token punctuation\\\">:</span> vpc\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">0</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1Cidr\\n      <span class=\\\"token key atrule\\\">MapPublicIpOnLaunch</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">1</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet2Cidr\\n      <span class=\\\"token key atrule\\\">MapPublicIpOnLaunch</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnetsRouteTable</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>RouteTable\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnetsRouteTable\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet1Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet2\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnetsInternetGatewayRoute</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Route\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span> InternetGatewayVpcAttachment\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">DestinationCidrBlock</span><span class=\\\"token punctuation\\\">:</span> 0.0.0.0/0\\n      <span class=\\\"token key atrule\\\">GatewayId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> InternetGateway    \\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">0</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet1Cidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet1\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">1</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet2Cidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet2\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnetsRouteTable</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>RouteTable\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnetsRouteTable\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet1\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet2\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnetsNatGatewayAz1Route</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Route\\n    <span class=\\\"token key atrule\\\">Condition</span><span class=\\\"token punctuation\\\">:</span> EnableNat\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">DestinationCidrBlock</span><span class=\\\"token punctuation\\\">:</span> 0.0.0.0/0\\n      <span class=\\\"token key atrule\\\">NatGatewayId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> NatGatewayAz1\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">0</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet1Cidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet1\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Subnet\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">AvailabilityZone</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Select</span> \\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token number\\\">1</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Fn::GetAZs</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Region\\n      <span class=\\\"token key atrule\\\">CidrBlock</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet2Cidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet2\\n\\n  <span class=\\\"token key atrule\\\">DataSubnetsRouteTable</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>RouteTable\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnetsRouteTable\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet1\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2Association</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SubnetRouteTableAssociation\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet2\\n\\n  <span class=\\\"token key atrule\\\">DataSubnetsNatGatewayAz1Route</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Route\\n    <span class=\\\"token key atrule\\\">Condition</span><span class=\\\"token punctuation\\\">:</span> EnableNat\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">RouteTableId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnetsRouteTable\\n      <span class=\\\"token key atrule\\\">DestinationCidrBlock</span><span class=\\\"token punctuation\\\">:</span> 0.0.0.0/0\\n      <span class=\\\"token key atrule\\\">NatGatewayId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> NatGatewayAz1\\n\\n<span class=\\\"token key atrule\\\">Outputs</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> VPC ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> Vpc\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n\\n  <span class=\\\"token key atrule\\\">VpcCidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> VPC CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> VpcCidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcCidr\\n  \\n  <span class=\\\"token key atrule\\\">PublicSubnet1Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Public subnet 1 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1Id\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Public subnet 1 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet1Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1Cidr\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Public subnet 2 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet2\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2Id\\n\\n  <span class=\\\"token key atrule\\\">PublicSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Public subnet 2 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> PublicSubnet2Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2Cidr\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Service subnet 1 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet1\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet1Id\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Service subnet 1 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet1Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet1Cidr\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Service subnet 2 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet2\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet2Id\\n\\n  <span class=\\\"token key atrule\\\">ServiceSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Service subnet 2 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ServiceSubnet2Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ServiceSubnet2Cidr\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Data subnet 1 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet1\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet1Id\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet1Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Data subnet 1 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet1Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet1Cidr\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2Id</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Data subnet 2 ID\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet2\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet2Id\\n\\n  <span class=\\\"token key atrule\\\">DataSubnet2Cidr</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Data subnet 2 CIDR\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DataSubnet2Cidr\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DataSubnet2Cidr\\n</code></pre>\\n      </div>\\n<h3>Shared security groups - (infra-sgs)</h3>\\n<p>I usually define some shared security groups for other resources to share.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2010-09-09</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Shared security groups\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">DefaultIngressSg</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SecurityGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">GroupDescription</span><span class=\\\"token punctuation\\\">:</span> SSH access across the VPC\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n      <span class=\\\"token key atrule\\\">SecurityGroupIngress</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> icmp\\n          <span class=\\\"token key atrule\\\">FromPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">8</span>\\n          <span class=\\\"token key atrule\\\">ToPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">8</span>\\n          <span class=\\\"token key atrule\\\">CidrIp</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcCidr\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> tcp\\n          <span class=\\\"token key atrule\\\">FromPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">22</span>\\n          <span class=\\\"token key atrule\\\">ToPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">22</span>\\n          <span class=\\\"token key atrule\\\">CidrIp</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcCidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DefaultIngressSg\\n\\n<span class=\\\"token key atrule\\\">Outputs</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">DefaultIngressSgId</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Default ingress security group id\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DefaultIngressSg\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DefaultIngressSgId\\n</code></pre>\\n      </div>\\n<h3>ALB - (infra-alb)</h3>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2010-09-09</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Application load balancer\\n\\n<span class=\\\"token key atrule\\\">Parameters</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">CertificateArn</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> The ARN of the SSL/TLS certificate for ALB port 443 listener\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>acm<span class=\\\"token punctuation\\\">:</span>ap<span class=\\\"token punctuation\\\">-</span>southeast<span class=\\\"token punctuation\\\">-</span>2<span class=\\\"token punctuation\\\">:</span>504224764639<span class=\\\"token punctuation\\\">:</span>certificate/ce5a2456<span class=\\\"token punctuation\\\">-</span>f97b<span class=\\\"token punctuation\\\">-</span>49ed<span class=\\\"token punctuation\\\">-</span>91fd<span class=\\\"token punctuation\\\">-</span>323b0e290fb8\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">LoadBalancer</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ElasticLoadBalancingV2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancer\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Subnets</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1Id\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2Id\\n      <span class=\\\"token key atrule\\\">SecurityGroups</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!Ref</span> LoadBalancerSg\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancer\\n\\n  <span class=\\\"token key atrule\\\">LoadBalancerSg</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SecurityGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">GroupDescription</span><span class=\\\"token punctuation\\\">:</span> Public access to ALB\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n      <span class=\\\"token key atrule\\\">SecurityGroupIngress</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">CidrIp</span><span class=\\\"token punctuation\\\">:</span> 0.0.0.0/0\\n          <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> tcp\\n          <span class=\\\"token key atrule\\\">FromPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">443</span>\\n          <span class=\\\"token key atrule\\\">ToPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">443</span>\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerSg\\n  \\n  <span class=\\\"token comment\\\"># We're not going to use the default group but we need this to create ALB</span>\\n  <span class=\\\"token key atrule\\\">DefaultTargetGroup</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ElasticLoadBalancingV2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>TargetGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Port</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">80</span>\\n      <span class=\\\"token key atrule\\\">Protocol</span><span class=\\\"token punctuation\\\">:</span> HTTP\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DefaultTargetGroup\\n\\n  <span class=\\\"token key atrule\\\">LoadBalancerListener</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ElasticLoadBalancingV2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Listener\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">LoadBalancerArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> LoadBalancer\\n      <span class=\\\"token key atrule\\\">Port</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">443</span>\\n      <span class=\\\"token key atrule\\\">Protocol</span><span class=\\\"token punctuation\\\">:</span> HTTPS\\n      <span class=\\\"token key atrule\\\">Certificates</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">CertificateArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> CertificateArn\\n      <span class=\\\"token key atrule\\\">DefaultActions</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">TargetGroupArn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> DefaultTargetGroup\\n          <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> forward\\n\\n<span class=\\\"token key atrule\\\">Outputs</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">LoadBalancerListenerArn</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> LoadBalancerListener\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerListenerArn\\n\\n  <span class=\\\"token key atrule\\\">LoadBalancerSgId</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> LoadBalancerSg\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerSgId\\n</code></pre>\\n      </div>\\n<h3>ECS cluster (infra-ecs-cluster)</h3>\\n<p>Here’s the how I provisioned an ECS cluster based on a spot fleet request. Notice that here I put EC2 instances in public subnets, which is not best practice in terms of security, but it saves me money as otherwise I need to put NAT gateways in public subnets so that my EC2 instances in private subnets can have public IPs for ECS agents to talk to ECS service.</p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-yaml\\\"><code><span class=\\\"token punctuation\\\">---</span>\\n<span class=\\\"token key atrule\\\">AWSTemplateFormatVersion</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2010-09-09</span>\\n\\n<span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> ECS cluster of spot fleet\\n\\n<span class=\\\"token key atrule\\\">Parameters</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">ClusterName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Name of the ECS cluster\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> ApplicationCluster\\n\\n  <span class=\\\"token key atrule\\\">TargetCapacity</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> Number\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> How many EC2 instances do we want\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">1 </span><span class=\\\"token comment\\\"># HA needs at least 2</span>\\n\\n  <span class=\\\"token key atrule\\\">InstanceType</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">AllowedValues</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> t2.micro\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> EC2 instance type to use for ECS cluster\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> t2.micro\\n\\n  <span class=\\\"token key atrule\\\">KeyName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>KeyPair<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>KeyName\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Name of an existing EC2 KeyPair to enable SSH access to the EC2 instances\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> default<span class=\\\"token punctuation\\\">-</span>keypair\\n\\n  <span class=\\\"token key atrule\\\">SpotBidPrice</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> String\\n    <span class=\\\"token key atrule\\\">Description</span><span class=\\\"token punctuation\\\">:</span> Maximum price that you are willing to pay per hour per instance\\n    <span class=\\\"token key atrule\\\">Default</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">0.0035</span>\\n\\n<span class=\\\"token key atrule\\\">Mappings</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">AWSRegionToECSAMI</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">ap-northeast-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>af46dbc9\\n    <span class=\\\"token key atrule\\\">ap-southeast-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>fec3b482\\n    <span class=\\\"token key atrule\\\">ap-southeast-2</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>b88e7cda\\n    <span class=\\\"token key atrule\\\">ca-central-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>e8cb4e8c\\n    <span class=\\\"token key atrule\\\">eu-central-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>b378e8dc\\n    <span class=\\\"token key atrule\\\">eu-west-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>7827b301\\n    <span class=\\\"token key atrule\\\">eu-west-2</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>acd5cdc8\\n    <span class=\\\"token key atrule\\\">us-east-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span><span class=\\\"token number\\\">13401669</span>\\n    <span class=\\\"token key atrule\\\">us-east-2</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>901338f5\\n    <span class=\\\"token key atrule\\\">us-west-1</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>b3adacd3\\n    <span class=\\\"token key atrule\\\">us-west-2</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AMI</span><span class=\\\"token punctuation\\\">:</span> ami<span class=\\\"token punctuation\\\">-</span>9a02a9e2\\n\\n<span class=\\\"token key atrule\\\">Resources</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">EcsCluster</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>ECS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Cluster\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">ClusterName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ClusterName\\n\\n  <span class=\\\"token key atrule\\\">EcsHostSg</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SecurityGroup\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">VpcId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcId\\n      <span class=\\\"token key atrule\\\">GroupDescription</span><span class=\\\"token punctuation\\\">:</span> Access to the ECS hosts and the tasks/containers that run on them\\n      <span class=\\\"token key atrule\\\">SecurityGroupIngress</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token comment\\\"># allow free access for ALB</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token string\\\">\\\"-1\\\"</span>\\n          <span class=\\\"token key atrule\\\">SourceSecurityGroupId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>alb<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>LoadBalancerSgId\\n        <span class=\\\"token comment\\\"># SSH for jumpbox</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IpProtocol</span><span class=\\\"token punctuation\\\">:</span> tcp\\n          <span class=\\\"token key atrule\\\">FromPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">22</span>\\n          <span class=\\\"token key atrule\\\">ToPort</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">22</span>\\n          <span class=\\\"token key atrule\\\">CidrIp</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>VpcCidr\\n      <span class=\\\"token key atrule\\\">Tags</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Key</span><span class=\\\"token punctuation\\\">:</span> Name\\n          <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EcsHostSg\\n\\n  <span class=\\\"token key atrule\\\">SpotFleet</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EC2<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>SpotFleet\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> SpotFleetRole\\n      <span class=\\\"token punctuation\\\">-</span> SpotFleetInstanceProfile\\n      <span class=\\\"token punctuation\\\">-</span> EcsHostSg\\n      <span class=\\\"token punctuation\\\">-</span> EcsCluster\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">SpotFleetRequestConfigData</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">AllocationStrategy</span><span class=\\\"token punctuation\\\">:</span> lowestPrice\\n        <span class=\\\"token key atrule\\\">IamFleetRole</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> SpotFleetRole.Arn\\n        <span class=\\\"token key atrule\\\">LaunchSpecifications</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">IamInstanceProfile</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Arn</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!GetAtt</span> SpotFleetInstanceProfile.Arn\\n            <span class=\\\"token key atrule\\\">ImageId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!FindInMap</span> <span class=\\\"token punctuation\\\">[</span>AWSRegionToECSAMI<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token tag\\\">!Ref</span> <span class=\\\"token string\\\">\\\"AWS::Region\\\"</span><span class=\\\"token punctuation\\\">,</span> AMI<span class=\\\"token punctuation\\\">]</span>\\n            <span class=\\\"token key atrule\\\">InstanceType</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> InstanceType\\n            <span class=\\\"token key atrule\\\">KeyName</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> KeyName\\n            <span class=\\\"token key atrule\\\">Monitoring</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Enabled</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n            <span class=\\\"token key atrule\\\">SecurityGroups</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">GroupId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> EcsHostSg\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">GroupId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>sgs<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>DefaultIngressSgId\\n\\n            <span class=\\\"token comment\\\"># EC2 instances need to have public IPs to register ECS:</span>\\n            <span class=\\\"token comment\\\"># https://stackoverflow.com/questions/31036600/why-cant-my-ecs-service-register-available-ec2-instances-with-my-elb</span>\\n            <span class=\\\"token comment\\\"># I can either use public subnets, which is not best security practice, but it saves</span>\\n            <span class=\\\"token comment\\\"># me money from running NAT gateways.</span>\\n            <span class=\\\"token comment\\\"># Or, I can use service subnets, which is better practice, but I need to run NAT gateways.</span>\\n            <span class=\\\"token key atrule\\\">SubnetId</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Join</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token string\\\">','</span>\\n              <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet1Id\\n                <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token tag\\\">!ImportValue</span> infra<span class=\\\"token punctuation\\\">-</span>vpc<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>PublicSubnet2Id\\n\\n            <span class=\\\"token key atrule\\\">UserData</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">\\\"Fn::Base64\\\"</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> <span class=\\\"token punctuation\\\">|</span><span class=\\\"token scalar string\\\">\\n                #!/bin/bash\\n                yum install -y aws-cfn-bootstrap\\n                echo ECS_CLUSTER=${EcsCluster} >> /etc/ecs/ecs.config</span>\\n        <span class=\\\"token key atrule\\\">SpotPrice</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> SpotBidPrice\\n        <span class=\\\"token key atrule\\\">TargetCapacity</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> TargetCapacity\\n        <span class=\\\"token key atrule\\\">TerminateInstancesWithExpiration</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean important\\\">true</span>\\n\\n  <span class=\\\"token key atrule\\\">SpotFleetInstanceProfile</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>IAM<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>InstanceProfile\\n    <span class=\\\"token key atrule\\\">DependsOn</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token punctuation\\\">-</span> SpotFleetInstanceRole\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> /\\n      <span class=\\\"token key atrule\\\">Roles</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Ref</span><span class=\\\"token punctuation\\\">:</span> SpotFleetInstanceRole\\n\\n  <span class=\\\"token key atrule\\\">SpotFleetInstanceRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>IAM<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Role\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2012-10-17</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> ec2.amazonaws.com\\n      <span class=\\\"token key atrule\\\">ManagedPolicyArns</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>iam<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>policy/service<span class=\\\"token punctuation\\\">-</span>role/AmazonEC2ContainerServiceforEC2Role\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> /\\n\\n  <span class=\\\"token key atrule\\\">SpotFleetRole</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Type</span><span class=\\\"token punctuation\\\">:</span> AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>IAM<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>Role\\n    <span class=\\\"token key atrule\\\">Properties</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">AssumeRolePolicyDocument</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token key atrule\\\">Version</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token datetime number\\\">2012-10-17</span>\\n        <span class=\\\"token key atrule\\\">Statement</span><span class=\\\"token punctuation\\\">:</span>\\n          <span class=\\\"token punctuation\\\">-</span> <span class=\\\"token key atrule\\\">Action</span><span class=\\\"token punctuation\\\">:</span>\\n            <span class=\\\"token punctuation\\\">-</span> sts<span class=\\\"token punctuation\\\">:</span>AssumeRole\\n            <span class=\\\"token key atrule\\\">Effect</span><span class=\\\"token punctuation\\\">:</span> Allow\\n            <span class=\\\"token key atrule\\\">Principal</span><span class=\\\"token punctuation\\\">:</span>\\n              <span class=\\\"token key atrule\\\">Service</span><span class=\\\"token punctuation\\\">:</span>\\n                <span class=\\\"token punctuation\\\">-</span> spotfleet.amazonaws.com\\n      <span class=\\\"token key atrule\\\">ManagedPolicyArns</span><span class=\\\"token punctuation\\\">:</span>\\n        <span class=\\\"token punctuation\\\">-</span> arn<span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>iam<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>aws<span class=\\\"token punctuation\\\">:</span>policy/service<span class=\\\"token punctuation\\\">-</span>role/AmazonEC2SpotFleetRole\\n      <span class=\\\"token key atrule\\\">Path</span><span class=\\\"token punctuation\\\">:</span> /\\n\\n<span class=\\\"token key atrule\\\">Outputs</span><span class=\\\"token punctuation\\\">:</span>\\n  <span class=\\\"token key atrule\\\">EcsClusterName</span><span class=\\\"token punctuation\\\">:</span>\\n    <span class=\\\"token key atrule\\\">Value</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Ref</span> ClusterName\\n    <span class=\\\"token key atrule\\\">Export</span><span class=\\\"token punctuation\\\">:</span>\\n      <span class=\\\"token key atrule\\\">Name</span><span class=\\\"token punctuation\\\">:</span> <span class=\\\"token tag\\\">!Sub</span> $<span class=\\\"token punctuation\\\">{</span>AWS<span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>StackName<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">:</span><span class=\\\"token punctuation\\\">:</span>EcsClusterName\\n</code></pre>\\n      </div>\\n<h2>Conclusion</h2>\\n<p>This is not the final conclusion yet, but so far you can basically understand what I built and why I built in such way. Also, by reading these boring CloudFormation templates (to prove that your life is probably as boring as mine), you’ll have an even better understanding about AWS infrastructure and its automation. Anyway, this is part 1 and now let’s take a break and to be continued…</p>\",\"frontmatter\":{\"layout\":\"post\",\"title\":\"Build your AWS infrastructure - Part 1\",\"path\":\"/build-your-aws-infrastructure-part-1/\",\"categories\":[\"AWS\",\"DevOps\",\"CloudFormation\",\"VPC\",\"ECS\",\"SpotInstance\"],\"date\":\"2018/01/08\"}}},\"pathContext\":{\"path\":\"/build-your-aws-infrastructure-part-1/\"}}\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/json-loader!./.cache/json/build-your-aws-infrastructure-part-1.json\n// module id = 379\n// module chunks = 142854424372053"],"sourceRoot":""}